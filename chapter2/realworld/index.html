
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter2/realworld/">
      
      
        <meta name="author" content="Adrian Hall">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.3">
    
    
      
        <title>Tokens in Real Apps - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2cb7adb3.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f0267088.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-93366112-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#caching-tokens" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Tokens in Real Apps
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Chapter 1 - Introduction
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 1 - Introduction" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Chapter 1 - Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_pc/" class="md-nav__link">
      Your First App - PC Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_mac/" class="md-nav__link">
      Your First App - Mac Edition
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Chapter 2 - Authentication
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 2 - Authentication" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Chapter 2 - Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../authconcepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../backend/" class="md-nav__link">
      Authentication in the Backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../enterprise/" class="md-nav__link">
      Enterprise Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../social/" class="md-nav__link">
      Social Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../debugging/" class="md-nav__link">
      Debugging Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../custom/" class="md-nav__link">
      Custom Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../authorization/" class="md-nav__link">
      Claims and Authorization
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Tokens in Real Apps
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Tokens in Real Apps
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#caching-tokens" class="md-nav__link">
    Caching Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh-tokens" class="md-nav__link">
    Refresh Tokens
  </a>
  
    <nav class="md-nav" aria-label="Refresh Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-refresh-tokens" class="md-nav__link">
    Configuring Refresh Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-refresh-tokens" class="md-nav__link">
    Using Refresh Tokens
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging-out" class="md-nav__link">
    Logging out
  </a>
  
    <nav class="md-nav" aria-label="Logging out">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invalidating-the-token-on-the-mobile-backend" class="md-nav__link">
    Invalidating the token on the mobile backend.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-the-token-from-the-local-secure-cache-store" class="md-nav__link">
    Removing the token from the local secure cache store.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-a-logoutasync-method" class="md-nav__link">
    Implementing a LogoutAsync() method.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../bestpractices/" class="md-nav__link">
      Best Practices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Chapter 3 - Data Access and Offline Sync
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 3 - Data Access and Offline Sync" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Chapter 3 - Data Access and Offline Sync
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/dataconcepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/server/" class="md-nav__link">
      Implementing Table Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/projection/" class="md-nav__link">
      Data Projection and Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/client/" class="md-nav__link">
      The Mobile Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/relationships/" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/domainmgr/" class="md-nav__link">
      The Domain Manager
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Chapter 4 - Server Side Code
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 4 - Server Side Code" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Chapter 4 - Server Side Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/options/" class="md-nav__link">
      Options for Server Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/custom/" class="md-nav__link">
      Custom HTTP Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/webjobs/" class="md-nav__link">
      WebJobs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/functions/" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/recipes/" class="md-nav__link">
      Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Chapter 5 - Push Notifications
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 5 - Push Notifications" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Chapter 5 - Push Notifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/concepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/android/" class="md-nav__link">
      Android Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/ios/" class="md-nav__link">
      iOS Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/windows/" class="md-nav__link">
      Windows Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/recipes/" class="md-nav__link">
      Push Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Chapter 6 - Combining Web and Mobile Apps
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 6 - Combining Web and Mobile Apps" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Chapter 6 - Combining Web and Mobile Apps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/mvc/" class="md-nav__link">
      MVC Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/jquery/" class="md-nav__link">
      jQuery Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/angular/" class="md-nav__link">
      Angular Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/react/" class="md-nav__link">
      React Applications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Chapter 7 - Other Useful Services
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 7 - Other Useful Services" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Chapter 7 - Other Useful Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/services/" class="md-nav__link">
      Useful Azure Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/search/" class="md-nav__link">
      Azure Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/media/" class="md-nav__link">
      Media Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Chapter 8 - Developing An App
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 8 - Developing An App" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        Chapter 8 - Developing An App
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/developing/" class="md-nav__link">
      The Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/testing/" class="md-nav__link">
      Testing your Application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Chapter 9 - Going to Production
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 9 - Going to Production" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon"></span>
        Chapter 9 - Going to Production
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/arm/" class="md-nav__link">
      Repeatable Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/appsvc/" class="md-nav__link">
      Safe Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/monitoring/" class="md-nav__link">
      Monitoring and Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../xamarin_tips/" class="md-nav__link">
      Xamarin Forms Tips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../android_appendix/" class="md-nav__link">
      Android Developer Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vs_extensions/" class="md-nav__link">
      Visual Studio Extensions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#caching-tokens" class="md-nav__link">
    Caching Tokens
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh-tokens" class="md-nav__link">
    Refresh Tokens
  </a>
  
    <nav class="md-nav" aria-label="Refresh Tokens">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-refresh-tokens" class="md-nav__link">
    Configuring Refresh Tokens
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-refresh-tokens" class="md-nav__link">
    Using Refresh Tokens
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#logging-out" class="md-nav__link">
    Logging out
  </a>
  
    <nav class="md-nav" aria-label="Logging out">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#invalidating-the-token-on-the-mobile-backend" class="md-nav__link">
    Invalidating the token on the mobile backend.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#removing-the-token-from-the-local-secure-cache-store" class="md-nav__link">
    Removing the token from the local secure cache store.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#implementing-a-logoutasync-method" class="md-nav__link">
    Implementing a LogoutAsync() method.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter2/realworld.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Tokens in Real Apps</h1>
                
                <h2 id="caching-tokens">Caching Tokens<a class="headerlink" href="#caching-tokens" title="Permanent link">&para;</a></h2>
<p>You will notice that we have to log in with every start of the application.  The token that is generated has a lifetime that is provided and controlled by the identity provider.  Some providers have a relatively short lifetime.  For example, Azure Active Directory tokens have a lifetime of 1 hour.  Others are incredibly long.  Facebook has an expiry time of 60 days.</p>
<p>Irrespective of the lifespan of the token, we will want to store it securely and re-use it when we can.  Xamarin has provided a nice component, <a href="https://components.xamarin.com/gettingstarted/xamarin.auth">Xamarin.Auth</a>, that provides such as secure store in a cross-platform manner.  It starts with an account store:</p>
<pre><code class="language-csharp">// For iOS:
var accountStore = AccountStore.Create();
// For Android:
var accountStore = AccountStore.Create(Context);
</code></pre>
<p>We can then store the token with the following:</p>
<pre><code class="language-csharp">accountStore.Save(account, &quot;descriptor&quot;);
</code></pre>
<p>The descriptor is a string that allows us to find the token again.  The account (which is an <code>Account</code> object) is uniquely identified by a key composed of the account's Username property and the descriptor.  The Account class is provided with Xamarin.Auth.  Storage is backed by the <a href="https://developer.apple.com/library/ios/#documentation/security/Reference/keychainservices/Reference/reference.html">Keychain</a> on iOS and the <a href="http://developer.android.com/reference/java/security/KeyStore.html">KeyStore</a> on Android.</p>
<p>To get the token back, we use the following:</p>
<pre><code class="language-csharp">var accounts = accountStore.FindAccountsForService(&quot;descriptor&quot;);
</code></pre>
<p>When we receive the token back from the key store, we will want to check the expiry time to ensure the token has not expired.  As a result, there is a little bit more code to caching code than one would expect.</p>
<p>Let's start with the Android version in <strong>TaskList.Droid</strong>.  As with all the other login code, we are adjusting the <code>LoginAsync()</code> method in <code>Services\DroidLoginProvider.cs</code>:</p>
<pre><code class="language-csharp">using System;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Android.App;
using Android.Content;
using Microsoft.IdentityModel.Clients.ActiveDirectory;
using Microsoft.WindowsAzure.MobileServices;
using Newtonsoft.Json.Linq;
using TaskList.Abstractions;
using TaskList.Droid.Services;
using TaskList.Helpers;
using Xamarin.Auth;

[assembly: Xamarin.Forms.Dependency(typeof(DroidLoginProvider))]
namespace TaskList.Droid.Services
{
    public class DroidLoginProvider : ILoginProvider
    {
        public Context RootView { get; private set; }

        public AccountStore AccountStore { get; private set; }

        public void Init(Context context)
        {
            RootView = context;
            AccountStore = AccountStore.Create(context);
        }

        public async Task LoginAsync(MobileServiceClient client)
        {
            // Check if the token is available within the key store
            var accounts = AccountStore.FindAccountsForService(&quot;tasklist&quot;);
            if (accounts != null)
            {
                foreach (var acct in accounts)
                {
                    string token;

                    if (acct.Properties.TryGetValue(&quot;token&quot;, out token))
                    {
                        if (!IsTokenExpired(token))
                        {
                            client.CurrentUser = new MobileServiceUser(acct.Username);
                            client.CurrentUser.MobileServiceAuthenticationToken = token;
                            return;
                        }
                    }
                }
            }

            // Server Flow
            await client.LoginAsync(RootView, &quot;aad&quot;);

            // Store the new token within the store
            var account = new Account(client.CurrentUser.UserId);
            account.Properties.Add(&quot;token&quot;, client.CurrentUser.MobileServiceAuthenticationToken);
            AccountStore.Save(account, &quot;tasklist&quot;);
        }

        bool IsTokenExpired(string token)
        {
            // Get just the JWT part of the token (without the signature).
            var jwt = token.Split(new Char[] { '.' })[1];

            // Undo the URL encoding.
            jwt = jwt.Replace('-', '+').Replace('_', '/');
            switch (jwt.Length % 4)
            {
                case 0: break;
                case 2: jwt += &quot;==&quot;; break;
                case 3: jwt += &quot;=&quot;; break;
                default:
                    throw new ArgumentException(&quot;The token is not a valid Base64 string.&quot;);
            }

            // Convert to a JSON String
            var bytes = Convert.FromBase64String(jwt);
            string jsonString = UTF8Encoding.UTF8.GetString(bytes, 0, bytes.Length);

            // Parse as JSON object and get the exp field value,
            // which is the expiration date as a JavaScript primative date.
            JObject jsonObj = JObject.Parse(jsonString);
            var exp = Convert.ToDouble(jsonObj[&quot;exp&quot;].ToString());

            // Calculate the expiration by adding the exp value (in seconds) to the
            // base date of 1/1/1970.
            DateTime minTime = new DateTime(1970, 1, 1, 0, 0, 0, 0, DateTimeKind.Utc);
            var expire = minTime.AddSeconds(exp);
            return (expire &lt; DateTime.UtcNow);
        }
    }
}
</code></pre>
<p>There are three new pieces to this code.  The first piece is to check to see if there is an existing token in the KeyStore.  If there is, we check the expiry time and then set up the Azure Mobile Apps client with the username and token from the KeyStore.  If there isn't, we do the normal authentication process.  If the authentication process is successful, we reach the second piece, which is to store the token within the KeyStore.  If there is an existing entry, it will be overwritten.  Finally, there is a method called <code>IsTokenExpired()</code> whose only job is to check to see if a token is expired or not.  This same code can be used in the <code>Services/iOSLoginProvider.cs</code>.  The only difference is in the <code>AccountStore.Create()</code> call (as discussed earlier).</p>
<div class="admonition warn">
<p class="admonition-title">Update Entitlements for iOS 10</p>
<p>You may notice that you are not able to use <code>AccountStore.Save()</code> in the iOS 10 Simulator.  A change to the iOS entitlements has caused this change.  You must add keychain access to your Entitlements.plist file, and use the Entitlements.plist file as a custom entitlements list.  </p>
</div>
<p>Visual Studio for the PC doesn't provide a lot of assistance with the entitlements.  However, Visual Studio for Mac has a great editor for the entitlement, so this is one time I'd suggest going over to the Mac to do something.  Make sure you have created an Apple Developer account and created a provisioning profile.  These are pre-requisites to using the Keychain.</p>
<ol>
<li>Right-click the <strong>TaskList.iOS</strong> project to open the options pane and select <strong>Options</strong> </li>
<li>Select the <strong>iOS Bundle Signing</strong> menu option.</li>
<li>Select <strong>iPhoneSimulator</strong> for the Platform.</li>
<li>Click the <strong>...</strong> button next to <strong>Custom Entitlements</strong>.</li>
<li>Select the <strong>Entitlements.plist</strong> file, then click <strong>Open</strong>.</li>
<li>Save the properties (I used Ctrl-S for this)</li>
<li>Find and open the <strong>Entitlements.plist</strong> file in the <strong>TaskList.iOS</strong> project.</li>
<li>In the <strong>Keychain</strong> sction, check the box next to <strong>Enable Keychain Access Groups</strong>.  This may require additional setup and linking to a provisioning profile.</li>
<li>Save the file and re-build your project.</li>
</ol>
<p>Xamarin.Auth only support iOS and Android.  We need to turn to an alternate library for token caching on Universal Windows.  The standard library has a package called <a href="https://msdn.microsoft.com/library/windows/apps/windows.security.credentials.passwordvault.aspx">PasswordVault</a> that can be used identically to the <a href="http://developer.android.com/reference/java/security/KeyStore.html">KeyStore</a> and <a href="https://developer.apple.com/library/ios/#documentation/security/Reference/keychainservices/Reference/reference.html">Keychain</a> libraries.  Here is the Universal Windows version of the same code in <code>Services\UWPLoginProvider.cs</code>:</p>
<pre><code class="language-csharp">using System;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using Microsoft.IdentityModel.Clients.ActiveDirectory;
using Microsoft.WindowsAzure.MobileServices;
using Newtonsoft.Json.Linq;
using TaskList.Abstractions;
using TaskList.Helpers;
using TaskList.UWP.Services;
using Windows.Security.Credentials;

[assembly: Xamarin.Forms.Dependency(typeof(UWPLoginProvider))]
namespace TaskList.UWP.Services
{
    public class UWPLoginProvider : ILoginProvider
    {
        public PasswordVault PasswordVault { get; private set; }

        public UWPLoginProvider()
        {
            PasswordVault = new PasswordVault();
        }

        public async Task LoginAsync(MobileServiceClient client)
        {
            // Check if the token is available within the password vault
            var acct = PasswordVault.FindAllByResource(&quot;tasklist&quot;).FirstOrDefault();
            if (acct != null)
            {
                var token = PasswordVault.Retrieve(&quot;tasklist&quot;, acct.UserName).Password;
                if (token != null &amp;&amp; token.Length &gt; 0 &amp;&amp; !IsTokenExpired(token))
                {
                    client.CurrentUser = new MobileServiceUser(acct.UserName);
                    client.CurrentUser.MobileServiceAuthenticationToken = token;
                    return;
                }
            }

            // Server-Flow Version
            await client.LoginAsync(&quot;aad&quot;);

            // Store the token in the password vault
            PasswordVault.Add(new PasswordCredential(&quot;tasklist&quot;,
                client.CurrentUser.UserId,
                client.CurrentUser.MobileServiceAuthenticationToken));
        }

        bool IsTokenExpired(string token)
        {
            /* Copy code from DroidLoginProvider */
        }
    }
}
</code></pre>
<p>The PasswordVault replaces the KeyStore (Android) and Keychain (iOS), but the concepts are the same.  All three
mechanisms provide the basic functionality of storing client secrets securely.</p>
<h2 id="refresh-tokens">Refresh Tokens<a class="headerlink" href="#refresh-tokens" title="Permanent link">&para;</a></h2>
<p>The token cache checks the token to see if it is expired and prompts the user if the token is no longer valid.  Since the life of a token is inevitably short (maybe one hour), this will still mean that the user is prompted for new credentials most of the time.  In addition, we have an issue when the app is running for a long time.  What happens if the user leaves the app running for 2 hours?  The token we received at the start of the session will be invalid halfway through the session and we will have to restart the app in order to continue.  Both of these situations are undesirable from the point of view of the user.  Access tokens eventually expire and we need to explicitly deal with this situation.</p>
<p>The first part of the solution is to request a <em>Refresh Token</em>.  This is something the identity provider issues when the scope of the request includes an offline scope.  Only certain identity providers include the ability to request refresh tokens.  For server-flow:</p>
<ul>
<li>Google: Append the "access_type=offline" to the request.</li>
<li>Microsoft Account: Select the wl.offline_access scope in the Azure management portal.</li>
<li>Azure AD: Configure Azure AD to support access to the Graph API.</li>
</ul>
<p>Facebook and Twitter do not provider refresh tokens.  Once you have the refresh tokens, you can simply call the refresh API in the Azure Mobile Apps SDK to refresh the token.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Refresh Tokens are one area that require special consideration when using Custom Authentication.  Just like with the /.auth/me endpoint, you are on your own when it comes to handling token expiry for custom authentication.</p>
</div>
<h3 id="configuring-refresh-tokens">Configuring Refresh Tokens<a class="headerlink" href="#configuring-refresh-tokens" title="Permanent link">&para;</a></h3>
<p>You can add the additional information to a Google request with the following code snippet:</p>
<pre><code class="language-csharp">client.LoginAsync(&quot;google&quot;, new Dictionary&lt;string, string&gt;
{
    { &quot;access_type&quot;, &quot;offline&quot; }
});
</code></pre>
<p>Azure Active Directory is perhaps the trickiest to configure.</p>
<ul>
<li>Log on to the <a href="https://portal.azure.com/">Azure portal</a>.</li>
<li>Navigate to your Azure Active Directory.</li>
<li>Click <strong>App registrations</strong>, then your WEB application</li>
<li>Click <strong>Keys</strong>.</li>
<li>
<p>Enter a friendly name.  Pick <em>2 years</em> in the Expiry duration</p>
<p><img alt="AAD - Add a Key" src="../img/aad-add-key.PNG" /></p>
</li>
<li>
<p>Click <strong>Save</strong>.  The key will be generated for you.  Copy the key (you will need it below).</p>
</li>
<li>Go to <strong>App Services</strong>, then your App Service.</li>
<li>Click <strong>Resource explorer</strong> in the menu, then <strong>Go</strong>.</li>
<li>In the Resource Explorer, expand <strong>config</strong> and select <strong>authsettings</strong>.</li>
<li>Click on <strong>Edit</strong>.</li>
<li>Set the clientSecret to the key you copied from above.</li>
<li>Set the additionalLoginParams to <code>["response_type=code id_token"]</code>.</li>
</ul>
<p><img alt="AAD: Resource Explorer View" src="../img/aad-resource-explorer.PNG" /></p>
<ul>
<li>Click the <strong>Read/Write</strong> toggle button at the top of the page.</li>
<li>Click the <strong>PUT</strong> button.</li>
</ul>
<p>The next time the user logs into our web app side, there will be a one-time prompt to consent to graph API access.
Once granted, the App Service Authentication / Authorization service will start requesting and receiving refresh
tokens.  Once you go through this process and re-authenticate, you will be able to see the refresh token in the output of the <code>/.auth/me</code> endpoint:</p>
<p><img alt="AAD: Refresh Tokens" src="../img/aad-refresh-token.PNG" /></p>
<p>Refresh tokens have a different expiry time to the identity token.  The refresh token theoretically lives forever,
but there are "non-use expiry" times. This varies by identity provider.</p>
<ul>
<li>Google: 6 months</li>
<li>Microsoft Account: 24 hours</li>
<li>Azure Active Directory: 90 days</li>
</ul>
<p>In addition, there may be other reasons why a token can be invalidated.  For instance, Google provides 25 refresh
tokens per user.  If the user requests more than the limit, the oldest token is invalidated.  You should refer
to the OAuth documentation for the identity provider.</p>
<h3 id="using-refresh-tokens">Using Refresh Tokens<a class="headerlink" href="#using-refresh-tokens" title="Permanent link">&para;</a></h3>
<p>The Azure Mobile Apps Client SDK has a built in method for refreshing tokens for you.  It assumes that you are using
a supported identity provider (Azure Active Directory, Google or Microsoft Account), and have configured the identity
provider to generate the refresh token.  To refresh a token, use:</p>
<pre><code class="language-csharp">client.RefreshUserAsync();
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you get the error "You do not have permission to view this directory or page" when accessing the refresh
endpoint, there are no refresh tokens for your user in the token store.  This could be because the user has
yet to re-authenticate (causing a new refresh token to be generated), the provider is not set up to generate
refresh tokens or the provider does not support refresh tokens.</p>
</div>
<p>We can easily add this to the login process in the platform-specific provider.  Rather than provide the same logic
over and over, we can extend the <code>ILoginProvider</code> to do the base operations for us then implement the logic once
in the <code>AzureCloudService</code>.  The <code>Abstractions\ILoginProvider.cs</code> interface now looks like this:</p>
<pre><code class="language-csharp">using System.Threading.Tasks;
using Microsoft.WindowsAzure.MobileServices;

namespace TaskList.Abstractions
{
    public interface ILoginProvider
    {
        MobileServiceUser RetrieveTokenFromSecureStore();

        void StoreTokenInSecureStore(MobileServiceUser user);

        Task&lt;MobileServiceUser&gt; LoginAsync(MobileServiceClient client);
    }
}
</code></pre>
<p>Since the <code>RefreshUserAsync()</code> method is purely contained within the Azure Mobile Apps Client SDK and requires
no changes between platforms, we don't need a special platform-specific version.  Each method of the interface
is one of the primitives we have already discussed.  For example, the Android version in  <code>Services\DroidLoginProvider.cs</code>
now looks like this:</p>
<pre><code class="language-csharp">[assembly: Xamarin.Forms.Dependency(typeof(DroidLoginProvider))]
namespace TaskList.Droid.Services
{
    public class DroidLoginProvider : ILoginProvider
    {
        #region ILoginProvider Interface
        public MobileServiceUser RetrieveTokenFromSecureStore()
        {
            var accounts = AccountStore.FindAccountsForService(&quot;tasklist&quot;);
            if (accounts != null)
            {
                foreach (var acct in accounts)
                {
                    string token;

                    if (acct.Properties.TryGetValue(&quot;token&quot;, out token))
                    {
                        return new MobileServiceUser(acct.Username)
                        {
                            MobileServiceAuthenticationToken = token
                        };
                    }
                }
            }
            return null;
        }

        public void StoreTokenInSecureStore(MobileServiceUser user)
        {
            var account = new Account(user.UserId);
            account.Properties.Add(&quot;token&quot;, user.MobileServiceAuthenticationToken);
            AccountStore.Save(account, &quot;tasklist&quot;);
        }

        public async Task&lt;MobileServiceUser&gt; LoginAsync(MobileServiceClient client)
        {
            // Server Flow
            return await client.LoginAsync(RootView, &quot;aad&quot;);
        }
        #endregion

        public Context RootView { get; private set; }

        public AccountStore AccountStore { get; private set; }

        public void Init(Context context)
        {
            RootView = context;
            AccountStore = AccountStore.Create(context);
        }
    }
}
</code></pre>
<p>The iOS version is practically the same because we are using the common Xamarin.Auth portable library.  The
difference is in the methods outside of the ILoginProvider interface:</p>
<pre><code class="language-csharp">public UIViewController RootView =&gt; UIApplication.SharedApplication.KeyWindow.RootViewController;

public AccountStore AccountStore { get; private set; }

public iOSLoginProvider()
{
    AccountStore = AccountStore.Create();
}
</code></pre>
<p>Finally, the Universal Windows version (in <code>Services\UWPLoginProvider.cs</code>) is significantly different in the
secure store implementation:</p>
<pre><code class="language-csharp">[assembly: Xamarin.Forms.Dependency(typeof(UWPLoginProvider))]
namespace TaskList.UWP.Services
{
    public class UWPLoginProvider : ILoginProvider
    {
        public PasswordVault PasswordVault { get; private set; }

        public UWPLoginProvider()
        {
            PasswordVault = new PasswordVault();
        }

        #region ILoginProvider Interface
        public MobileServiceUser RetrieveTokenFromSecureStore()
        {
            try
            {
                // Check if the token is available within the password vault
                var acct = PasswordVault.FindAllByResource(&quot;tasklist&quot;).FirstOrDefault();
                if (acct != null)
                {
                    var token = PasswordVault.Retrieve(&quot;tasklist&quot;, acct.UserName).Password;
                    if (token != null &amp;&amp; token.Length &gt; 0)
                    {
                        return new MobileServiceUser(acct.UserName)
                        {
                            MobileServiceAuthenticationToken = token
                        };
                    }
                }
            }
            catch (Exception ex)
            {
                Debug.WriteLine($&quot;Error retrieving existing token: {ex.Message}&quot;);
            }
            return null;
        }

        public void StoreTokenInSecureStore(MobileServiceUser user)
        {
            PasswordVault.Add(new PasswordCredential(&quot;tasklist&quot;, user.UserId, user.MobileServiceAuthenticationToken));
        }

        public async Task&lt;MobileServiceUser&gt; LoginAsync(MobileServiceClient client)
        {
            // Server-Flow Version
            return await client.LoginAsync(&quot;aad&quot;);
        }
        #endregion
    }
}
</code></pre>
<p>We can swap out the server-flow Azure Active Directory login method with any of the client-flow, server-flow or
custom flows that we have been discussing thus far across all three platform-specific implementations.</p>
<p>The common flow handles all the logic for us.  This is the <code>LoginAsync()</code> method in the <code>Services\AzureCloudService.cs</code>
class:</p>
<pre><code class="language-csharp">public async Task&lt;MobileServiceUser&gt; LoginAsync()
{
    var loginProvider = DependencyService.Get&lt;ILoginProvider&gt;();

    client.CurrentUser = loginProvider.RetrieveTokenFromSecureStore();
    if (client.CurrentUser != null)
    {
        // User has previously been authenticated - try to Refresh the token
        try
        {
            var refreshed = await client.RefreshUserAsync();
            if (refreshed != null)
            {
                loginProvider.StoreTokenInSecureStore(refreshed);
                return refreshed;
            }
        }
        catch (Exception refreshException)
        {
            Debug.WriteLine($&quot;Could not refresh token: {refreshException.Message}&quot;);
        }
    }

    if (client.CurrentUser != null &amp;&amp; !IsTokenExpired(client.CurrentUser.MobileServiceAuthenticationToken))
    {
        // User has previously been authenticated, no refresh is required
        return client.CurrentUser;
    }

    // We need to ask for credentials at this point
    await loginProvider.LoginAsync(client);
    if (client.CurrentUser != null)
    {
        // We were able to successfully log in
        loginProvider.StoreTokenInSecureStore(client.CurrentUser);
    }
    return client.CurrentUser;
}
</code></pre>
<p>For full disclosure, I've also moved the <code>IsTokenExpired()</code> method from the platform-specific code to the shared project, and updated the <code>ICloudService.cs</code> to match the new signature of <code>LoginAsync()</code>.  The process follows the best practices:</p>
<ul>
<li>Check for a stored token - if one exists, try to refresh it.</li>
<li>If the token (that potentially just got refreshed) is not expired, continue using it.</li>
<li>If not, ask the user for credentials.</li>
<li>If we get a valid token back, store it in the secure store for next time.</li>
</ul>
<p>There is another place that we must consider refresh tokens.  During a HTTP request to our mobile backend, it is possible that the token has expired since our last request.  The request will return a 401 Unauthorized response in this case.  We need to trap that and perform a login request.  The login request will either refresh the token or prompt the user for new credentials.  We can then continue with the request as before.</p>
<p>The Azure Mobile Apps SDK contains a mechanism for hooking into the HTTP workflow using a <code>DelegatingHandler</code>. A delegating handler is a base type for a HTTP handler that allows us to process the request and response from the HTTP client object before (and after) it finally get processed.  It's used for adding additional headers to the request or logging the request and response, for example.  We are going to use it to validate the response and re-submit the request (after login) if the request comes back as a 401 Unauthorized.</p>
<p>We start with the adjustment to the <code>Services\AzureCloudService.cs</code> constructor:</p>
<pre><code class="language-csharp">public AzureCloudService()
{
    client = new MobileServiceClient(Locations.AppServiceUrl, new AuthenticationDelegatingHandler());

    if (Locations.AlternateLoginHost != null)
        client.AlternateLoginHost = new Uri(Locations.AlternateLoginHost);
}
</code></pre>
<p>The <code>AuthenticationDelegatingHandler()</code> is the new piece here.  This is the delegating handler that we are going
to implement to handle the re-try logic.  I've placed the code in <code>Helpers\AuthenticationDelegatingHandler.cs</code>:</p>
<pre><code class="language-csharp">using System.Collections.Generic;
using System.IO;
using System.Net;
using System.Net.Http;
using System.Threading;
using System.Threading.Tasks;
using TaskList.Abstractions;

namespace TaskList.Helpers
{
    class AuthenticationDelegatingHandler : DelegatingHandler
    {
        protected override async Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request, CancellationToken cancellationToken)
        {
            // Clone the request, in case we need to re-issue it
            var clone = await CloneHttpRequestMessageAsync(request);
            // Now do the request
            var response = await base.SendAsync(request, cancellationToken);

            if (response.StatusCode == HttpStatusCode.Unauthorized)
            {
                // The request resulted in a 401 Unauthorized.  We need to do a LoginAsync,
                // which will do the Refresh if appropriate, or ask for credentials if not.
                var user = await ServiceLocator.Instance.Resolve&lt;ICloudService&gt;().LoginAsync();

                // Now, retry the request with the cloned request.  The only thing we have
                // to do is replace the X-ZUMO-AUTH header with the new auth token.
                clone.Headers.Remove(&quot;X-ZUMO-AUTH&quot;);
                clone.Headers.Add(&quot;X-ZUMO-AUTH&quot;, user.MobileServiceAuthenticationToken);
                response = await base.SendAsync(clone, cancellationToken);
            }

            return response;
        }

        /// &lt;summary&gt;
        /// Clone a HttpRequestMessage
        /// Credit: http://stackoverflow.com/questions/25044166/how-to-clone-a-httprequestmessage-when-the-original-request-has-content
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;req&quot;&gt;The request&lt;/param&gt;
        /// &lt;returns&gt;A copy of the request&lt;/returns&gt;
        public static async Task&lt;HttpRequestMessage&gt; CloneHttpRequestMessageAsync(HttpRequestMessage req)
        {
            HttpRequestMessage clone = new HttpRequestMessage(req.Method, req.RequestUri);

            // Copy the request's content (via a MemoryStream) into the cloned object
            var ms = new MemoryStream();
            if (req.Content != null)
            {
                await req.Content.CopyToAsync(ms).ConfigureAwait(false);
                ms.Position = 0;
                clone.Content = new StreamContent(ms);

                // Copy the content headers
                if (req.Content.Headers != null)
                    foreach (var h in req.Content.Headers)
                        clone.Content.Headers.Add(h.Key, h.Value);
            }


            clone.Version = req.Version;

            foreach (KeyValuePair&lt;string, object&gt; prop in req.Properties)
                clone.Properties.Add(prop);

            foreach (KeyValuePair&lt;string, IEnumerable&lt;string&gt;&gt; header in req.Headers)
                clone.Headers.TryAddWithoutValidation(header.Key, header.Value);

            return clone;
        }
    }
}
</code></pre>
<p>There is no in-built method for cloning a <code>HttpRequestMessage</code> object.  Fortunately <a href="http://stackoverflow.com/questions/25044166/how-to-clone-a-httprequestmessage-when-the-original-request-has-content">Stack Overflow</a> provided an answer that seems to work.  Running this code will now pass every single non-login request through the delegating handler.  If we get an Unauthorized at any point, the login flow (which includes an implicit refresh token) will be triggered.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>There are two HTTPClient objects created inside of the <code>MobileServiceClient</code> object. One is for all the non-login flows and it supports the delegating handlers.  However there is another one for login flows.  The one for login flows does not support delegating handlers.  This means you don't have to worry about cyclical references within the delegating handler (where a login flow triggers another login flow).</p>
</div>
<h2 id="logging-out">Logging out<a class="headerlink" href="#logging-out" title="Permanent link">&para;</a></h2>
<p>There is a dirty little secret within the Azure Mobile Apps Client SDK.  Calling <code>LogoutAsync()</code> does not actually invalidate the token you are using.  It simply removes it from the <code>MobileServiceClient</code> context.  Don't believe me?  Here is <a href="https://github.com/Azure/azure-mobile-apps-net-client/blob/main/src/Microsoft.WindowsAzure.MobileServices/MobileServiceClient.cs">the code</a>:</p>
<pre><code class="language-csharp">        /// &lt;summary&gt;
        /// Log a user out.
        /// &lt;/summary&gt;
        public Task LogoutAsync()
        {
            this.CurrentUser = null;
            return Task.FromResult(0);
        }
</code></pre>
<p>When you actually think about it, this makes sense.  You can get logged in via five different supported identity providers via a web-flow.  In this case, you are logging your <strong>browser</strong> out of the identity provider.  Do you really want to log out of Facebook when you log out of your app?</p>
<p>So, how do you log out?  You should:</p>
<ul>
<li>Call the identity provider logout method (if appropriate).  Many identity providers don't provide this.</li>
<li>Invalidate the token on the mobile backend.</li>
<li>Remove the token from the local secure cache store.</li>
<li>Finally, call the <code>LogoutAsync()</code> method on the <code>MobileServiceClient</code>.</li>
</ul>
<h3 id="invalidating-the-token-on-the-mobile-backend">Invalidating the token on the mobile backend.<a class="headerlink" href="#invalidating-the-token-on-the-mobile-backend" title="Permanent link">&para;</a></h3>
<p>Calling the <code>/.auth/logout</code> endpoint on the Azure App Service mobile backend will remove the entry on the token store.  However, it does not (currently) invalidate the token.  The token, if submitted, will still authorize the user.  The refresh token is stored in the token store. The user submitting the token will be unable to refresh the token.  Once the ZUMO token has expired (which happens an hour after it was created), the logout is complete.</p>
<p>We need to do a HTTP client call for this purpose:</p>
<pre><code class="language-csharp">// Invalidate the token on the mobile backend
var authUri = new Uri($&quot;{client.MobileAppUri}/.auth/logout&quot;);
using (var httpClient = new HttpClient())
{
    httpClient.DefaultRequestHeaders.Add(&quot;X-ZUMO-AUTH&quot;, client.CurrentUser.MobileServiceAuthenticationToken);
    await httpClient.GetAsync(authUri);
}
</code></pre>
<h3 id="removing-the-token-from-the-local-secure-cache-store">Removing the token from the local secure cache store.<a class="headerlink" href="#removing-the-token-from-the-local-secure-cache-store" title="Permanent link">&para;</a></h3>
<p>For this part of the process, We can add a new method to the <code>ILoginProvider.cs</code> interface:</p>
<pre><code class="language-csharp">void RemoveTokenFromSecureStore();
</code></pre>
<p>For Android and iOS, the concrete implementation looks like this:</p>
<pre><code class="language-csharp">public void RemoveTokenFromSecureStore()
{
    var accounts = AccountStore.FindAccountsForService(&quot;tasklist&quot;);
    if (accounts != null)
    {
        foreach (var acct in accounts)
        {
            AccountStore.Delete(acct, &quot;tasklist&quot;);
        }
    }
}
</code></pre>
<p>For Universal Windows, the concrete implementation is a bit different:</p>
<pre><code class="language-csharp">public void RemoveTokenFromSecureStore()
{
    try
    {
        // Check if the token is available within the password vault
        var acct = PasswordVault.FindAllByResource(&quot;tasklist&quot;).FirstOrDefault();
        if (acct != null)
        {
            PasswordVault.Remove(acct);
        }
    }
    catch (Exception ex)
    {
        Debug.WriteLine($&quot;Error retrieving existing token: {ex.Message}&quot;);
    }
}
</code></pre>
<h3 id="implementing-a-logoutasync-method">Implementing a LogoutAsync() method.<a class="headerlink" href="#implementing-a-logoutasync-method" title="Permanent link">&para;</a></h3>
<p>I've added the following to the <code>ICloudService</code> interface:</p>
<pre><code class="language-csharp">Task LogoutAsync();
</code></pre>
<p>This has a concrete implementation in <code>Services\AzureCloudService.cs</code>:</p>
<pre><code class="language-csharp">public async Task LogoutAsync()
{
    if (client.CurrentUser == null || client.CurrentUser.MobileServiceAuthenticationToken == null)
        return;

    // Log out of the identity provider (if required)

    // Invalidate the token on the mobile backend
    var authUri = new Uri($&quot;{client.MobileAppUri}/.auth/logout&quot;);
    using (var httpClient = new HttpClient())
    {
        httpClient.DefaultRequestHeaders.Add(&quot;X-ZUMO-AUTH&quot;, client.CurrentUser.MobileServiceAuthenticationToken);
        await httpClient.GetAsync(authUri);
    }

    // Remove the token from the cache
    DependencyService.Get&lt;ILoginProvider&gt;().RemoveTokenFromSecureStore();

    // Remove the token from the MobileServiceClient
    await client.LogoutAsync();
}
</code></pre>
<p>This does three of the four providers.  If your identity provider supports an app-level logout, then you should call that where indicated.  This is probably going to be platform-specific code, so you will want to add a method to the <code>ILoginProvider.cs</code> interface and add a concrete implementation to each platform project.</p>
<p>I've also added a logout button to my <code>Pages\TaskList.xaml</code> (<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/blob/main/Chapter2/TaskList/TaskList/Pages/TaskList.xaml#L12">view code</a>) and added the event handler for the logout button to the <code>ViewModels\EntryPageViewModel.cs</code> (<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/blob/main/Chapter2/TaskList/TaskList/ViewModels/TaskListViewModel.cs#L112">view code</a>).</p>
<!-- Images -->
<!-- Links -->
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../authorization/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Claims and Authorization
              </div>
            </div>
          </a>
        
        
          <a href="../bestpractices/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Best Practices
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017-2020 Adrian Hall
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/adrianhall" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/FizzyInTheHall" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../../assets/javascripts/bundle.c1ccee15.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>