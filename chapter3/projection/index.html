
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter3/projection/">
      
      
        <meta name="author" content="Adrian Hall">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.1.3">
    
    
      
        <title>Data Projection and Queries - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.2cb7adb3.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.f0267088.min.css">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    
      
        
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-93366112-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}),document.addEventListener("DOMContentSwitch",function(){ga("send","pageview",document.location.pathname)})</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#projecting-a-data-set" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              Data Projection and Queries
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Chapter 1 - Introduction
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 1 - Introduction" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        Chapter 1 - Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_pc/" class="md-nav__link">
      Your First App - PC Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_mac/" class="md-nav__link">
      Your First App - Mac Edition
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Chapter 2 - Authentication
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 2 - Authentication" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Chapter 2 - Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authconcepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/backend/" class="md-nav__link">
      Authentication in the Backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/enterprise/" class="md-nav__link">
      Enterprise Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/social/" class="md-nav__link">
      Social Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/debugging/" class="md-nav__link">
      Debugging Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/custom/" class="md-nav__link">
      Custom Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authorization/" class="md-nav__link">
      Claims and Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/realworld/" class="md-nav__link">
      Tokens in Real Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/bestpractices/" class="md-nav__link">
      Best Practices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Chapter 3 - Data Access and Offline Sync
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 3 - Data Access and Offline Sync" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        Chapter 3 - Data Access and Offline Sync
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dataconcepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server/" class="md-nav__link">
      Implementing Table Controllers
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Data Projection and Queries
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" class="md-nav__link md-nav__link--active">
      Data Projection and Queries
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics-of-projection" class="md-nav__link">
    Basics of Projection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#projection-recipes" class="md-nav__link">
    Projection Recipes
  </a>
  
    <nav class="md-nav" aria-label="Projection Recipes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-user-data" class="md-nav__link">
    Per-User Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-group-data" class="md-nav__link">
    Per-Group Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#friends-data" class="md-nav__link">
    Friends Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-linqpad-to-test-linq-queries" class="md-nav__link">
    Using LINQPad to test LINQ Queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../client/" class="md-nav__link">
      The Mobile Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relationships/" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../domainmgr/" class="md-nav__link">
      The Domain Manager
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Chapter 4 - Server Side Code
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 4 - Server Side Code" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        <span class="md-nav__icon md-icon"></span>
        Chapter 4 - Server Side Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/options/" class="md-nav__link">
      Options for Server Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/custom/" class="md-nav__link">
      Custom HTTP Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/webjobs/" class="md-nav__link">
      WebJobs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/functions/" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/recipes/" class="md-nav__link">
      Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Chapter 5 - Push Notifications
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 5 - Push Notifications" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        <span class="md-nav__icon md-icon"></span>
        Chapter 5 - Push Notifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/concepts/" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/android/" class="md-nav__link">
      Android Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/ios/" class="md-nav__link">
      iOS Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/windows/" class="md-nav__link">
      Windows Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/recipes/" class="md-nav__link">
      Push Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Chapter 6 - Combining Web and Mobile Apps
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 6 - Combining Web and Mobile Apps" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        <span class="md-nav__icon md-icon"></span>
        Chapter 6 - Combining Web and Mobile Apps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/mvc/" class="md-nav__link">
      MVC Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/jquery/" class="md-nav__link">
      jQuery Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/angular/" class="md-nav__link">
      Angular Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/react/" class="md-nav__link">
      React Applications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Chapter 7 - Other Useful Services
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 7 - Other Useful Services" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        <span class="md-nav__icon md-icon"></span>
        Chapter 7 - Other Useful Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/services/" class="md-nav__link">
      Useful Azure Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/search/" class="md-nav__link">
      Azure Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/media/" class="md-nav__link">
      Media Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Chapter 8 - Developing An App
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 8 - Developing An App" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        <span class="md-nav__icon md-icon"></span>
        Chapter 8 - Developing An App
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/developing/" class="md-nav__link">
      The Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/testing/" class="md-nav__link">
      Testing your Application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Chapter 9 - Going to Production
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Chapter 9 - Going to Production" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        <span class="md-nav__icon md-icon"></span>
        Chapter 9 - Going to Production
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/arm/" class="md-nav__link">
      Repeatable Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/appsvc/" class="md-nav__link">
      Safe Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/monitoring/" class="md-nav__link">
      Monitoring and Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../xamarin_tips/" class="md-nav__link">
      Xamarin Forms Tips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../android_appendix/" class="md-nav__link">
      Android Developer Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vs_extensions/" class="md-nav__link">
      Visual Studio Extensions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics-of-projection" class="md-nav__link">
    Basics of Projection
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#projection-recipes" class="md-nav__link">
    Projection Recipes
  </a>
  
    <nav class="md-nav" aria-label="Projection Recipes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#per-user-data" class="md-nav__link">
    Per-User Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#per-group-data" class="md-nav__link">
    Per-Group Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#friends-data" class="md-nav__link">
    Friends Data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-linqpad-to-test-linq-queries" class="md-nav__link">
    Using LINQPad to test LINQ Queries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter3/projection.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="projecting-a-data-set">Projecting a Data Set<a class="headerlink" href="#projecting-a-data-set" title="Permanent link">&para;</a></h1>
<p>We have thus far looked at what it takes to project a whole SQL database table into the mobile world.  We
can easily do both pre-existing and greenfield databases with code-first and database-first methodologies.
The next logical thing is to see what we can do to adjust the transfer of data.  How do we filter and
transform the data as requests are sent to the server.</p>
<p>There are two places where adjustment of the transfer is accomplished.  I recommend spending time on the
server adjusting the table controller so that security policies are assured.  The set of data that a
mobile client can see should be the complete set of data that the user of that mobile device is allowed
to see.  We can then adjust the view of that data at the client.</p>
<p>For example, let's say that the user is a sales person.  They are allowed to see the information for
their accounts, but only wants to see the records for the accounts that have planned to visit within
the next week.  We would place the limitation on what records they can see on the server, but place
the date range manipulation on the client.</p>
<p>In this section, we will look at all the things one can do on in the table controller on the server.</p>
<h2 id="basics-of-projection">Basics of Projection<a class="headerlink" href="#basics-of-projection" title="Permanent link">&para;</a></h2>
<p>There are four basic things we will want to do with table controllers:</p>
<p><strong>Filters</strong> adjust the data that the requesting user can see.  We would normally apply a filter to all
methods EXCEPT the <code>Create</code> or <code>Insert</code> method.  This is the most common adjustment that is coded in
the table controller as filtering is the key to enforcing security policy.</p>
<p><strong>Transforms</strong> adjust the data that is being sent to the table controller before it is stored.  It is
used in two areas.  First, it is used to automatically inject necessary fields for ensuring the security
filters can be applied.  For instance, if we wish to have a per-user data store (where a user can only
see their own records), then we will need to store the user ID of the requesting user.  Secondly, it is
used to insert point-in-time lookups into a record.  For instance, if we wish to record the current price
of an item at the time the record was inserted into the table, we would do this with a transform.</p>
<p><strong>Validations</strong> do not adjust the data.  Validations ensure that the data is correct according to the
server model.  Your data may, for example, store an age indirectly by storing the year of birth.  It's
highly unlikely that you will want to support the entire range of possible years.  You definitely don't
want to support years in the future.</p>
<p>Finally, <strong>Hooks</strong> allow another piece of code to be triggered either before or after the request has been
processed.  For example, we may wish to send a push notification on a valid insert, or kick off an order
processing work flow when a record is updated with an approval to ship.  We won't be covering hooks in
this chapter as we have a whole chapter on <a href="../../chapter4/options/">customized requests</a> later on.</p>
<h2 id="projection-recipes">Projection Recipes<a class="headerlink" href="#projection-recipes" title="Permanent link">&para;</a></h2>
<p>There are a few "standard" projects we see all the time and these are great ways to learn how to do
projections.</p>
<h3 id="per-user-data">Per-User Data<a class="headerlink" href="#per-user-data" title="Permanent link">&para;</a></h3>
<p>The first projection that pretty much everyone implements is the <strong>Per-User Data</strong> projection.  In this recipe, we want the user to only see records that they have inserted.  For example, let's update our TodoItem table to support per-user data.  This involves three parts:</p>
<ul>
<li>A <strong>Filter</strong> that limits data to only the logged in user.</li>
<li>A <strong>Transform</strong> that updates an inserted record with the logged in user.</li>
<li>A <strong>Validation</strong> that ensures an updated or deleted record is owned by the user.</li>
</ul>
<p>The logged in user is available as the User object, but you have to cast it to a <a href="https://msdn.microsoft.com/en-us/library/system.security.claims.claimsprincipal(v=vs.110).aspx">ClaimsPrinicipal</a> to
access the claims that are sent inside the identity token.  I tend to use a public property as an
implementation:</p>
<pre><code class="language-csharp">public string UserId
{
    get
    {
        var principal = this.User as ClaimsPrincipal;
        return principal.FindFirst(ClaimTypes.NameIdentifier).Value;
    }
}
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It's generally a good idea to use the SID as the user ID for the authenticated user in security
applications.  The user can change the email address or username associated with the account, but
the SID never changes.</p>
</div>
<p>We need an extra property in the <code>DataObjects\TodoItem.cs</code> class (in the <strong>Backend</strong> project) to hold
the extra security claim that we will be adding later:</p>
<pre><code class="language-csharp">using Microsoft.Azure.Mobile.Server;

namespace Chapter3.DataObjects
{
    public class TodoItem : EntityData
    {
        public string UserId { get; set; }

        public string Text { get; set; }

        public bool Complete { get; set; }
    }
}
</code></pre>
<p>Remember to do a code-first migration if you are doing this on an existing service.  Let's take a look
at the <code>PostTodoItem()</code> first.  This requires the <strong>Transform</strong> to ensure the UserId field is filled
in.  We've already defined the <code>UserId</code> field, so we can inject that in the inbound object:</p>
<pre><code class="language-csharp">// POST tables/TodoItem
public async Task&lt;IHttpActionResult&gt; PostTodoItem(TodoItem item)
{
    item.UserId = UserId;
    TodoItem current = await InsertAsync(item);
    return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
}
</code></pre>
<p>Transforms tend to be short.  This is deliberate.  We don't want any of our code in a table controller
to do too much work.  The heavy lifting is done by the database, with the ASP.NET table controller being
a conduit for translating requests into responses.  This allows us to support more users on less virtual
hardware.</p>
<p>The <strong>Filter</strong> is a relatively simple affair in this case.  We ensure that the only records returned
are those that belong to the user.  For example, here is a simplistic filter applied to the <code>GetAll</code>
method:</p>
<pre><code class="language-csharp">// GET tables/TodoItem
public IQueryable&lt;TodoItem&gt; GetAllTodoItems()
{
    return Query().Where(item =&gt; item.UserId.Equals(UserId));
}
</code></pre>
<p>The <code>Query()</code> and <code>Lookup(id).Queryable</code> methods return <a href="https://msdn.microsoft.com/en-us/library/bb351562(v=vs.110).aspx">IQueryable</a> objects.  The IQueryable is used
to represent a query, so we can alter it with LINQ.  A filter is merely a LINQ expression to limit the
records being returned.  There might be another filter sent by the client, in which case this filter will
be tacked on the end of the request.  For instance, let's say that the client requests only records where
<code>Complete == False</code>.  When this comes through the <code>GetAllTodoItems()</code> method, the resulting SQL code will
look something like this:</p>
<pre><code class="language-sql">SELECT * FROM [dbo].[TodoItems]
    WHERE (Complete = false) AND (UserId = @0);
</code></pre>
<p>The <code>@0</code> parameter will be replaced by the users SID.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>If a user is not logged in (i.e. you forgot to add the <code>[Authorize]</code> attribute), the User object will
be null and the server will produce a 500 Internal Server Error back to the client.</p>
</div>
<p>This can get a little unwieldy for complex filters, however.  Since the filters are applied in two
different places (and are generally used for validation as well), I like to abstract them into a
<a href="https://www.simple-talk.com/dotnet/net-framework/giving-clarity-to-linq-queries-by-extending-expressions/">LINQ extension method</a>.  Create a class in <code>Extensions\TodoItemExtensions.cs</code> (you will have to create
the <code>Extensions</code> directory) with the following contents:</p>
<pre><code class="language-csharp">using System.Linq;
using Chapter3.DataObjects;

namespace Chapter3.Extensions
{
    public static class TodoItemExtensions
    {
        public static IQueryable&lt;TodoItem&gt; PerUserFilter(this IQueryable&lt;TodoItem&gt; query, string userid)
        {
            return query.Where(item =&gt; item.UserId.Equals(userid));
        }
    }
}
</code></pre>
<p>We can use this to simplify our filters and make them more readable:</p>
<pre><code class="language-csharp">// GET tables/TodoItem
public IQueryable&lt;TodoItem&gt; GetAllTodoItems()
{
    return Query().PerUserFilter(UserId);
}

// GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
public SingleResult&lt;TodoItem&gt; GetTodoItem(string id)
{
    return new SingleResult&lt;TodoItem&gt;(Lookup(id).Queryable.PerUserFilter(UserId));
}
</code></pre>
<p>Note that we need to apply the filter we have written to both the Get methods.</p>
<p>When we look at the <code>Delete</code> and <code>Patch</code> methods, we only have to validate that the UserId owns the
id we are updating.  For that, I write a custom validation method.  This method is in the table controller:</p>
<pre><code class="language-csharp">private void ValidateOwner(string id)
{
    var result = Lookup(id).Queryable.PerUserFilter(UserId).FirstOrDefault&lt;TodoItem&gt;();
    if (result == null)
    {
        throw new HttpResponseException(HttpStatusCode.NotFound);
    }
}
</code></pre>
<p>The validation method must throw an appropriate <code>HttpResponseException</code> if the validation fails.  It's common
to return a 404 Not Found error rather than a 403 Forbidden error for security reasons.  Returning a
403 Forbidden error confirms that the Id exists, which is a data leakage.  Returning a 404 Not Found
error means that a rogue client cannot tell the difference between "I can't access the record" and
"the record doesn't exist".  We can use this validation method in each method that requires it:</p>
<pre><code class="language-csharp">// PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
public Task&lt;TodoItem&gt; PatchTodoItem(string id, Delta&lt;TodoItem&gt; patch)
{
    ValidateOwner(id);
    return UpdateAsync(id, patch);
}

// DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
public Task DeleteTodoItem(string id)
{
    ValidateOwner(id);
    return DeleteAsync(id);
}
</code></pre>
<p>Although this is a very basic example of a filtered table, we can see three different techniques:</p>
<ul>
<li>A <strong>Filter</strong> implemented as a LINQ query in an <code>IQueryable</code> extension method, applied to both <code>Get</code> methods.</li>
<li>A <strong>Transform</strong> implemented inside the <code>Post</code> method.</li>
<li>A <strong>Validation</strong> implemented using the filter as a method in the table controller, applied to <code>Patch</code> and <code>Delete</code> methods.</li>
</ul>
<p>I set up a copy of the TaskList from Chapter 2 with Azure Active Directory Client Flow for authentication.
We can look at the SQL table contents after we log in with this client and add a new task:</p>
<p><img alt="" src="../img/per-user-data.PNG" /></p>
<p>Note that the UserId is the security ID of the authenticated user.  The security ID is a stable ID for
the user.  The security ID does not change if the user changes their username or email address.</p>
<h3 id="per-group-data">Per-Group Data<a class="headerlink" href="#per-group-data" title="Permanent link">&para;</a></h3>
<p>Let's say we have a mobile client that a sales person uses to enter data about sales.  He might be able
to pick from a list of industries that the account is in.  The enterprise may further organize those
industries as groups, with several people within the organization able to view the accounts associated
with a specific industry.</p>
<p>In this case:</p>
<ul>
<li>We want to limit the mobile client to only view accounts for groups to which he belongs.</li>
<li>We want to allow the mobile client to submit new accounts for any group to which he belongs.</li>
<li>Updates and Deletes should not adjust the group field.</li>
</ul>
<p>The limit will be implemented as a filter.  The update and insert methods will require a validation method (comparing the submitted group with the list of groups to which the user belongs).</p>
<p>We have another table in <code>DataObjects\Example.cs</code>.  Let's extend it to support a GroupId:</p>
<pre><code class="language-csharp">using System;
using Microsoft.Azure.Mobile.Server;

namespace Chapter3.DataObjects
{
    public class Example : EntityData
    {
        public string GroupId { get; set; }
        public string StringField { get; set; }
        public int IntField { get; set; }
        public double DoubleField { get; set; }
        public DateTimeOffset DateTimeField { get; set; }
    }
}
</code></pre>
<p>We'll store the group ID in the additional field.  Don't forget to use a code-first migration to update the database.
Each of the validations and filters requires a list of the groups the user belongs to.  This can be achieved using
a claim lookup:</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// Get the list of groups from the claims
/// &lt;/summary&gt;
/// &lt;returns&gt;The list of groups&lt;/returns&gt;
public async Task&lt;List&lt;string&gt;&gt; GetGroups()
{
    var creds = await User.GetAppServiceIdentityAsync&lt;AzureActiveDirectoryCredentials&gt;(Request);
    return creds.UserClaims
        .Where(claim =&gt; claim.Type.Equals(&quot;groups&quot;))
        .Select(claim =&gt; claim.Value)
        .ToList();
}
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you are using claims as part of your security model, you should add the claims that you are using to the identity token that is used for authentication.  You can do this with custom authentication by calling LoginAsync() twice - once for the standard login method and the second time to adjust the token through the custom auth.</p>
</div>
<p>Our filter is defined as a LINQ extension (just like in the per-user filter) in <code>Extensions\ExampleExtensions.cs</code>:</p>
<pre><code class="language-csharp">using System.Collections.Generic;
using System.Linq;
using Chapter3.DataObjects;

namespace Chapter3.Extensions
{
    public static class ExampleExtensions
    {
        public static IQueryable&lt;Example&gt; PerGroupFilter(this IQueryable&lt;Example&gt; query, List&lt;string&gt; groups)
        {
            return query.Where(item =&gt; groups.Contains(item.GroupId));
        }
    }
}
</code></pre>
<p>We can use this LINQ extension on the retrieval methods:</p>
<pre><code class="language-csharp">// GET tables/Example
public async Task&lt;IQueryable&lt;Example&gt;&gt; GetAllExample()
{
    var groups = await GetGroups();
    return Query().PerGroupFilter(groups);
}

// GET tables/Example/48D68C86-6EA6-4C25-AA33-223FC9A27959
public async Task&lt;SingleResult&lt;Example&gt;&gt; GetExample(string id)
{
    var groups = await GetGroups();
    return new SingleResult&lt;Example&gt;(Lookup(id).Queryable.PerGroupFilter(groups));
}
</code></pre>
<p>We have to convert each of the methods to a async method so that we can check the groups.  Retrieving the group
list for a user is an async method and this trickles down to the method being called.</p>
<p>The validation method is also an async method (for the same reason).  The Post and Patch methods look like
this:</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// Validator to determine if the provided group is in the list of groups
/// &lt;/summary&gt;
/// &lt;param name=&quot;group&quot;&gt;The group name&lt;/param&gt;
public async Task ValidateGroup(string group)
{
    var groups = await GetGroups();
    if (!groups.Contains(group))
    {
        throw new HttpResponseException(HttpStatusCode.BadRequest);
    }
}

// PATCH tables/Example/48D68C86-6EA6-4C25-AA33-223FC9A27959
public async Task&lt;Example&gt; PatchExample(string id, Delta&lt;Example&gt; patch)
{
    await ValidateGroup(patch.GetEntity().GroupId);
    return await UpdateAsync(id, patch);
}

// POST tables/Example
public async Task&lt;IHttpActionResult&gt; PostExample(Example item)
{
    await ValidateGroup(item.GroupId);
    Example current = await InsertAsync(item);
    return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
}
</code></pre>
<p>It's appropriate to throw a 400 Bad Request for a validation error in this case as the user is
authenticated at this point.  The user is not being exposed by the response.</p>
<p>There is no transform in this recipe as the group ID is being sent on each update request.</p>
<h3 id="friends-data">Friends Data<a class="headerlink" href="#friends-data" title="Permanent link">&para;</a></h3>
<p>One of the common social patterns is a "friends feed". We can post to our feed and we can see
both our messages and our friends messages. In this recipe, we will have three tables.  The
first is the <code>Users</code> table with the following model:</p>
<pre><code class="language-csharp">using Microsoft.Azure.Mobile.Server;

namespace Chapter3.DataObjects
{
    public class User : EntityData
    {
        public string EmailAddress { get; set; }
        public string Name { get; set; }
    }
}
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don't forget to add a <code>DbSet&lt;&gt;</code> for each table to the <code>MobileServiceContext</code> to add the table.</p>
</div>
<p>In our application, we will update the <code>Users</code> table via a <a href="../../chapter2/custom/">custom authentication controller</a>.
After we have logged in via Azure Active Directory, we call the <code>InvokeApiAsync()</code> method
to call the custom authentication controller and get a new token with some extra information
in it.  We'll cover custom authentication controllers in a later chapter.</p>
<pre><code class="language-csharp">using System;
using System.Data.Entity.Migrations;
using System.IdentityModel.Tokens;
using System.Linq;
using System.Security.Claims;
using System.Security.Principal;
using System.Threading.Tasks;
using System.Web.Http;
using Chapter3.DataObjects;
using Chapter3.Models;
using Microsoft.Azure.Mobile.Server.Authentication;
using Microsoft.Azure.Mobile.Server.Login;
using Newtonsoft.Json;

namespace Chapter3.Controllers
{
    [Authorize]
    [Route(&quot;auth/login/custom&quot;)]
    public class CustomAuthController : ApiController
    {
        MobileServiceContext dbContext;

        public CustomAuthController()
        {
            dbContext = new MobileServiceContext();

            string website = Environment.GetEnvironmentVariable(&quot;WEBSITE_HOSTNAME&quot;);
            Audience = $&quot;https://{website}/&quot;;
            Issuer = $&quot;https://{website}/&quot;;
            SigningKey = Environment.GetEnvironmentVariable(&quot;WEBSITE_AUTH_SIGNING_KEY&quot;);
        }

        public string Audience { get; set; }
        public string Issuer { get; set; }
        public string SigningKey { get; set; }

        [HttpPost]
        public async Task&lt;IHttpActionResult&gt; Post()
        {
            var creds = await User.GetAppServiceIdentityAsync&lt;AzureActiveDirectoryCredentials&gt;(Request);
            var sid = ((ClaimsPrincipal)User).FindFirst(ClaimTypes.NameIdentifier).Value;
            var email = creds.UserClaims
                .FirstOrDefault(claim =&gt; claim.Type.EndsWith(&quot;emailaddress&quot;))
                .Value;
            var name = creds.UserClaims
                .FirstOrDefault(claim =&gt; claim.Type.EndsWith(&quot;name&quot;))
                .Value;

            // Insert the record information into the database
            User user = new User()
            {
                Id = sid,
                Name = name,
                EmailAddress = email
            };
            dbContext.Users.AddOrUpdate(user);
            dbContext.SaveChanges();

            // Mind a new token based on the old one plus the new information
            var newClaims = new Claim[]
            {
                new Claim(JwtRegisteredClaimNames.Sub, sid),
                new Claim(JwtRegisteredClaimNames.Email, email),
                new Claim(&quot;name&quot;, name)
            };
            JwtSecurityToken token = AppServiceLoginHandler.CreateToken(
                newClaims, SigningKey, Audience, Issuer, TimeSpan.FromDays(30));

            // Return the token and user ID to the client
            return Ok(new LoginResult()
            {
                AuthenticationToken = token.RawData,
                UserId = sid
            });
        }
    }

    public class LoginResult
    {
        [JsonProperty(PropertyName = &quot;authenticationToken&quot;)]
        public string AuthenticationToken { get; set; }

        [JsonProperty(PropertyName = &quot;user_id&quot;)]
        public string UserId { get; set; }
    }
}
</code></pre>
<p>The actual database update is done by Entity Framework.  The ASP.NET service is just
a regular ASP.NET service using Entity Framework, so all the same facilities are
available as that configuration.  In this case, we take the provided token (which
is the same token that Azure Active Directory client-flow returns) and return a
modified token that includes a couple of extra fields.  During this process, we
update the database by adding or inserting (also known as upserting) a record with
the Id field set to the security ID and the additional fields we need.</p>
<p>I need a table to implement the "friends" relationship.  My friends are not stored
in Azure Active Directory.  If I were using a social provider, I could use the
friends feed from that social provider by doing a Graph API lookup.  In this case,
I'm going to use the following model:</p>
<pre><code class="language-csharp">namespace Chapter3.DataObjects
{
    public class Friend
    {
        public string UserId { get; set; }
        public string FriendId { get; set; }
    }
}
</code></pre>
<p>This is not based on <code>EntityData</code> because I am not going to expose this table to the mobile client.  It's purely for determining what records I am going to show to the mobile client.  In this example, I will maintain the data in this table manually. A "real" application would have some sort of custom workflow to add friends and get the friends to approve the connection.</p>
<p>To get the list of "friends I can see", I will request a list of the <code>FriendId</code> field where the <code>UserId</code> is my UserId.</p>
<p>The final table in the trio is the <code>Messages</code> table.  This will be downloaded to the
mobile client so it has to be based on the <code>EntityData</code> base class.  In addition, the
inserts for this table are going to look a lot like a per-user table.  I need the
<code>UserId</code> field to properly maintain the security model.</p>
<pre><code class="language-csharp">using Microsoft.Azure.Mobile.Server;

namespace Chapter3.DataObjects
{
    public class Message : EntityData
    {
        public string UserId { get; set; }
        public string Text { get; set; }
    }
}
</code></pre>
<p>Let's think about the security model we want to implement in the <code>Messages</code> table controller:</p>
<ul>
<li>A <strong>filter</strong> will allow the viewing of the users own data or any data that has an association in the Friends table.</li>
<li>A <strong>transform</strong> will set the owner of the record to my UserId</li>
<li>We will remove the ability to update or delete records since this is a write-once read-many table.</li>
</ul>
<p>Let's look at the <code>PostMessage()</code> method for the <code>MessageController</code> first.  This is
practically identical to the <code>PostTodoItem()</code> method in the per-user recipe:</p>
<pre><code class="language-csharp">public string UserId =&gt; ((ClaimsPrincipal)User).FindFirst(ClaimTypes.NameIdentifier).Value;

// POST tables/Message
public async Task&lt;IHttpActionResult&gt; PostMessage(Message item)
{
    item.UserId = UserId;
    Message current = await InsertAsync(item);
    return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
}
</code></pre>
<p>The filter is a little harder.  We are going to use the <a href="https://msdn.microsoft.com/en-us/library/bb397676.aspx"><em>Fluent Syntax</em></a> for LINQ to provide the right logic. The Fluent Syntax is also known as "Query Syntax" or the "declarative syntax", depending on the author.  The extension method looks like this:</p>
<pre><code class="language-csharp">using Chapter3.DataObjects;
using System.Data.Entity;
using System.Linq;

namespace Chapter3.Extensions
{
    public static class MessageExtensions
    {
        public static IQueryable&lt;Message&gt; OwnedByFriends(this IQueryable&lt;Message&gt; query, DbSet&lt;Friend&gt; friends, string userId)
        {
            var myPosts = from m in query
                          let fr = (from f in friends where f.FriendId == userId select f.UserId)
                          where m.UserId == userId || fr.Contains(m.UserId)
                          select m;
            return myPosts;
        }
    }
}
</code></pre>
<p>The LINQ query selects the messages from the <code>Messages</code> table where the author is either the mobile client user or the mobile client
user is listed as a friend of the author.  My query methods in the table controller now look similar to the per-user data:</p>
<pre><code class="language-csharp">public string UserId =&gt; ((ClaimsPrincipal)User).FindFirst(ClaimTypes.NameIdentifier).Value;

// GET tables/Message
public IQueryable&lt;Message&gt; GetAllMessage()
{
    return Query().OwnedByFriends(context.Friends, UserId);
}

// GET tables/Message/48D68C86-6EA6-4C25-AA33-223FC9A27959
public SingleResult&lt;Message&gt; GetMessage(string id)
{
    return new SingleResult&lt;Message&gt;(Lookup(id).Queryable.OwnedByFriends(context.Friends, UserId));
}
</code></pre>
<h3 id="using-linqpad-to-test-linq-queries">Using LINQPad to test LINQ Queries<a class="headerlink" href="#using-linqpad-to-test-linq-queries" title="Permanent link">&para;</a></h3>
<p>I tend to struggle with LINQ queries.  Fortunately, there are a plethora of blogs, tutorials and tools out there to assist.  One
of my favorite tools is <a href="https://www.linqpad.net/">LINQPad</a>.  LINQPad gives you an interactive playground for testing your LINQ queries.  In this case, I
created a new query with the following contents:</p>
<pre><code class="language-csharp">public class Message {
   public string UserId;
   public string Text;
}

public class Friend {
   public string UserId;
   public string FollowerId;
}

void Main()
{


List&lt;Friend&gt; friends = new List&lt;Friend&gt;() {
   new Friend() { UserId = &quot;adrian&quot;, FollowerId = &quot;donna&quot; },
   new Friend() { UserId = &quot;fabio&quot;, FollowerId = &quot;donna&quot; },
   new Friend() { UserId = &quot;fabio&quot;, FollowerId = &quot;adrian&quot; }
};

List&lt;Message&gt; messages = new List&lt;Message&gt;() {
   new Message() { UserId = &quot;adrian&quot;, Text = &quot;message 1&quot; },
   new Message() { UserId = &quot;donna&quot;, Text = &quot;message 2&quot; },
   new Message() { UserId = &quot;fabio&quot;, Text = &quot;message 3&quot; }
};
var user = &quot;fabio&quot;;

var q = from m in messages
        let fr = (from f in friends where f.FollowerId == user select f.UserId)
        where m.UserId == user || fr.Contains(m.UserId)
        select m;

q.Dump();

}
</code></pre>
<p>I have a friends table and a messages table.  User "donna" should be able to see three messages, user "adrian"
should be able to see two messages and user "fabio" should be able to see just one message.  By changing the
value of the <code>user</code> variable, I can test the query I am writing.  I don't need to set up a database (although
LINQPad supports that as well).</p>
<p><img alt="" src="../img/linqpad.PNG" /></p>
<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<p>There are a number of best practices that I think are important in developing table controllers:</p>
<ul>
<li><strong>Optimize Operations</strong></li>
</ul>
<p>You should always optimize the CRUD operations that are implemented in a table controller.  This means limiting
  the code so that only <strong>filters</strong>, <strong>transforms</strong> and <strong>validators</strong> are used.  You can use <strong>hooks</strong> as an
  asynchronous way to handle custom code if something else needs to happen when a mobile client inserts, updates
  or deletes a record.  (We will be delving into hooks during the custom code chapter later on).</p>
<p>You should <strong>NOT</strong> insert custom code into a table controller that runs synchronously.</p>
<ul>
<li><strong>Implement Security Policy with Filters</strong></li>
</ul>
<p>The mobile backend should be concerned with security.  What can the connecting user see?  Use <strong>filters</strong> to
  ensure that the connecting user can only see the data that they are allowed to see.  There are several examples
  of bad filters.  For example, if a user normally wants to see the last 7 days worth of messages, but is allowed
  to see all messages.  I would implement this particular case as a client-side filter as it has nothing to do
  with security.</p>
<ul>
<li><strong>Use LINQ Extension Methods</strong></li>
</ul>
<p>LINQ extension methods can be used to great effect to make your CRUD methods more readable.  I love readable
  code.  For example, consider the following two code snippets from the last recipe:</p>
<pre><code class="language-csharp">public IQueryable&lt;Message&gt; GetAllMessage()
{
  // Recipe #1
  return Query().OwnedByFriends(context.Friends, UserId);

  // Recipe #2
  return from m in Query()
    let fr = (from f in context.Friends where f.FriendId == UserId select f.UserId)
    where m.UserId == UserId || fr.Contains(m.UserId)
    select m;
}
</code></pre>
<p>The first recipe makes the intent of the filter very clear.  I have to work at understanding the specific implementation
  of the second method.</p>
<!-- Images -->
<!-- Links -->
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../server/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Implementing Table Controllers
              </div>
            </div>
          </a>
        
        
          <a href="../client/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                The Mobile Client
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017-2020 Adrian Hall
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/adrianhall" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/FizzyInTheHall" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/vendor.7e0ee788.min.js"></script>
      <script src="../../assets/javascripts/bundle.c1ccee15.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../..",
          features: [],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>