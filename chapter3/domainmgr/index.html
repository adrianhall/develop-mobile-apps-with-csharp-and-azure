
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter3/domainmgr/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.14">
    
    
      
        <title>The Domain Manager - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3de6f41f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#the-domain-manager" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              The Domain Manager
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Chapter 1 - Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 1 - Introduction" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Chapter 1 - Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_pc/" class="md-nav__link">
        Your First App - PC Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_mac/" class="md-nav__link">
        Your First App - Mac Edition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Chapter 2 - Authentication
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 2 - Authentication" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Chapter 2 - Authentication
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/backend/" class="md-nav__link">
        Authentication in the Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/enterprise/" class="md-nav__link">
        Enterprise Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/social/" class="md-nav__link">
        Social Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/debugging/" class="md-nav__link">
        Debugging Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/custom/" class="md-nav__link">
        Custom Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authorization/" class="md-nav__link">
        Claims and Authorization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/realworld/" class="md-nav__link">
        Tokens in Real Apps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/bestpractices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Chapter 3 - Data Access and Offline Sync
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 3 - Data Access and Offline Sync" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Chapter 3 - Data Access and Offline Sync
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../server/" class="md-nav__link">
        Implementing Table Controllers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection/" class="md-nav__link">
        Data Projection and Queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/" class="md-nav__link">
        The Mobile Client
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../relationships/" class="md-nav__link">
        Relationships
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          The Domain Manager
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        The Domain Manager
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#existing-table-relationships-with-the-mappedentitydomainmanager" class="md-nav__link">
    Existing Table Relationships with the MappedEntityDomainManager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosql-storage-with-the-storagedomainmanager" class="md-nav__link">
    NoSQL Storage with the StorageDomainManager
  </a>
  
    <nav class="md-nav" aria-label="NoSQL Storage with the StorageDomainManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitations-of-the-azure-storage-domain-manager" class="md-nav__link">
    Limitations of the Azure Storage Domain Manager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Chapter 4 - Server Side Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 4 - Server Side Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Chapter 4 - Server Side Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/options/" class="md-nav__link">
        Options for Server Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/custom/" class="md-nav__link">
        Custom HTTP Endpoints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/webjobs/" class="md-nav__link">
        WebJobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/functions/" class="md-nav__link">
        Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/recipes/" class="md-nav__link">
        Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Chapter 5 - Push Notifications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 5 - Push Notifications" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Chapter 5 - Push Notifications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/android/" class="md-nav__link">
        Android Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/ios/" class="md-nav__link">
        iOS Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/windows/" class="md-nav__link">
        Windows Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/recipes/" class="md-nav__link">
        Push Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Chapter 6 - Combining Web and Mobile Apps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 6 - Combining Web and Mobile Apps" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Chapter 6 - Combining Web and Mobile Apps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/mvc/" class="md-nav__link">
        MVC Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/jquery/" class="md-nav__link">
        jQuery Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/angular/" class="md-nav__link">
        Angular Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/react/" class="md-nav__link">
        React Applications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Chapter 7 - Other Useful Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 7 - Other Useful Services" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Chapter 7 - Other Useful Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/services/" class="md-nav__link">
        Useful Azure Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/search/" class="md-nav__link">
        Azure Search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/media/" class="md-nav__link">
        Media Services
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Chapter 8 - Developing An App
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 8 - Developing An App" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Chapter 8 - Developing An App
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/developing/" class="md-nav__link">
        The Development Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/testing/" class="md-nav__link">
        Testing your Application
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Chapter 9 - Going to Production
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 9 - Going to Production" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Chapter 9 - Going to Production
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/arm/" class="md-nav__link">
        Repeatable Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/appsvc/" class="md-nav__link">
        Safe Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/monitoring/" class="md-nav__link">
        Monitoring and Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../xamarin_tips/" class="md-nav__link">
        Xamarin Forms Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../android_appendix/" class="md-nav__link">
        Android Developer Notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../vs_extensions/" class="md-nav__link">
        Visual Studio Extensions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../credits/" class="md-nav__link">
        Credits
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#existing-table-relationships-with-the-mappedentitydomainmanager" class="md-nav__link">
    Existing Table Relationships with the MappedEntityDomainManager
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#nosql-storage-with-the-storagedomainmanager" class="md-nav__link">
    NoSQL Storage with the StorageDomainManager
  </a>
  
    <nav class="md-nav" aria-label="NoSQL Storage with the StorageDomainManager">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#limitations-of-the-azure-storage-domain-manager" class="md-nav__link">
    Limitations of the Azure Storage Domain Manager
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter3/domainmgr.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="the-domain-manager">The Domain Manager<a class="headerlink" href="#the-domain-manager" title="Permanent link">&para;</a></h1>
<p>As a request comes in to the mobile backend, it is processed through several layers.  First, ASP.NET
processes the request, handling things like Authentication and Authorization.  It is then processed
through the <code>Microsoft.Web.Http.OData</code> controller, which compiles the requested query.  Then it is 
passed to the Domain Manager, which is responsible for converting the request into a response.  The
response is then passed back up the stack to be finally given back to the mobile client.</p>
<p>The Domain Manager is a central part of this process.  It is a class that implements the <code>IDomainManager</code>
interface:</p>
<pre><code class="language-csharp">namespace Microsoft.Azure.Mobile.Server.Tables
{
    public interface IDomainManager&lt;TData&gt; where TData : class, ITableData
    {
        IQueryable&lt;TData&gt; Query();
        SingleResult&lt;TData&gt; Lookup(string id);
        Task&lt;IEnumerable&lt;TData&gt;&gt; QueryAsync(ODataQueryOptions query);
        Task&lt;SingleResult&lt;TData&gt;&gt; LookupAsync(string id);
        Task&lt;TData&gt; InsertAsync(TData data);
        Task&lt;TData&gt; UpdateAsync(string id, Delta&lt;TData&gt; patch);
        Task&lt;TData&gt; ReplaceAsync(string id, TData data);
        Task&lt;bool&gt; DeleteAsync(string id);
    }
}
</code></pre>
<p>This looks deceptively simple.  Just 8 methods.  In reality, this is anything but simple.  The major issue
that a prospective domain manager implementor has to grapple with is the translation of an <code>IQueryable</code> into
something that the backend data source can understand.</p>
<p>Let's take a look at a couple of domain managers that solve specific problems that crop up from time to time
during development.  It should be noted that <strong>NEITHER</strong> of these domain managers are recommended as a generalized
solution.  They both have significant caveats to their use and you should understand those caveats before
embarking on integrating them.</p>
<h2 id="existing-table-relationships-with-the-mappedentitydomainmanager">Existing Table Relationships with the MappedEntityDomainManager<a class="headerlink" href="#existing-table-relationships-with-the-mappedentitydomainmanager" title="Permanent link">&para;</a></h2>
<p>One of the key areas that is weak when using the default <code>EntityDomainManager</code> is handling existing tables.  The
generally accepted method of dealing with relationships is through loose coupling and manual relationship management
in the client. Relationships are core to the SQL database world and we sometimes want to project those relationships 
into the mobile client, allowing the backend to preserve any relationships that have been configured while still 
using the standard offline client capabilities.  If you have existing SQL relationships, you can use a combination
of <a href="http://automapper.org/">AutoMapper</a> and the <code>MappedEntityDomainManager</code>.  </p>
<p>The <code>MappedEntityDomainManager</code> is an abstract <code>IDomainManager</code> implementation targetting SQL as the backend store where
there is not a 1:1 mapping between the data object (DTO) exposed through the TableController and the domain model managed 
by Entity Framework.  If there is a 1:1 mapping, use <code>EntityDomainManager</code>.  The <code>MappedEntityDomainManager</code> uses 
<a href="http://automapper.org/">AutoMapper</a> to map between the DTO and the domain model.  It assumes that AutoMapper has already been initialized with 
appropriate mappings that map from DTO to domain model and from the domain model to the DTO.</p>
<p>Let's take a small example.  If I am producing an enterprise mobile app that field engineers can use - the ones
that, for example, visit your house to install cable.  I can define an Entity Framework model map as follows:</p>
<pre><code class="language-csharp">[Table(&quot;Customers&quot;)]
public class Customer
{
    public Customer()
    {
        this.Jobs = new HashSet&lt;Job&gt;();
    }

    [StringLength(50)]
    public string Id { get; set; }

    [StringLength(50)]
    public string FullName { get; set; }

    [StringLength(250)]
    public string Address { get; set; 

    public decimal? Latitude { get; set; }

    public decimal? Longitude { get; set; }

    public ICollection&lt;Job&gt; Jobs { get; set; }
}

[Table(&quot;Equipment&quot;)]
public class Equipment : ITableData
{
    public Equipment()
    {
        this.Jobs = new HashSet&lt;Job&gt;();
    }

    [StringLength(50)]
    public string Name { get; set; }

    [StringLength(28)]
    public string Asset { get; set; }

    [StringLength(250)]
    public string Description { get; set; }

    #region ITableData
    public DateTimeOffset? CreatedAt { get; set; }
    public bool Deleted { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public DateTimeOffset? UpdatedAt { get; set; }

    [Timestamp]
    public byte[] Version { get; set; }
    #endregion

    public ICollection&lt;Job&gt; Jobs { get; set; }
}

[Table(&quot;Jobs&quot;)]
public class Job : ITableData
{
    public Job()
    {
        this.Equipments = new HashSet&lt;Equipment&gt;();
    }

    [StringLength(50)]
    public string CustomerId { get; set; }

    [StringLength(50)]
    public string AgentId { get; set; }

    public DateTimeOffset? StartTime { get; set; }

    public DateTimeOffset? EndTime { get; set; }

    [StringLength(50)]
    public string Status { get; set; }

    [StringLength(250)]
    public string Description { get; set; }

    #region ITableData
    public DateTimeOffset? CreatedAt { get; set; }
    public bool Deleted { get; set; }

    [DatabaseGenerated(DatabaseGeneratedOption.Computed)]
    public DateTimeOffset? UpdatedAt { get; set; }

    [Timestamp]
    public byte[] Version { get; set; }
    #endregion

    public ICollection&lt;Equipment&gt; Equipments { get; set; }
}
</code></pre>
<p>This is the representation of the tables within the database.  They don't have to map to what the client
requires.  We can wire up the relationships in the normal <a href="http://www.entityframeworktutorial.net/code-first/configure-one-to-one-relationship-in-code-first.aspx">Entity Framework way</a>, within the <code>DbContext</code>:</p>
<pre><code class="language-csharp">public partial class ExistingDbContext : DbContext
{
    public FieldDbContext() : base(&quot;name=MS_TableConnectionString&quot;)
    {            
    }

    public virtual DbSet&lt;Customer&gt; Customers { get; set; }
    public virtual DbSet&lt;Equipment&gt; Equipments { get; set; }
    public virtual DbSet&lt;Job&gt; Jobs { get; set; } 

    protected override void OnModelCreating(DbModelBuilder modelBuilder)
    {            
        modelBuilder.HasDefaultSchema(&quot;dbo&quot;);
        modelBuilder.Conventions.Add(
            new AttributeToColumnAnnotationConvention&lt;TableColumnAttribute, string&gt;(
            &quot;ServiceTableColumn&quot;, (property, attributes) =&gt; attributes.Single().ColumnType.ToString()));

        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Address).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.FullName).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Id).IsUnicode(false);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Latitude).HasPrecision(9, 6);
        modelBuilder.Entity&lt;Customer&gt;().Property(e =&gt; e.Longitude).HasPrecision(9, 6);

        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Asset).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Description).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Name).IsUnicode(false);
        modelBuilder.Entity&lt;Equipment&gt;().Property(e =&gt; e.Id).IsUnicode(false);

        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.CustomerId).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.AgentId).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Id).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Status).IsUnicode(false);
        modelBuilder.Entity&lt;Job&gt;().Property(e =&gt; e.Description).IsUnicode(false);

        modelBuilder.Entity&lt;Equipment&gt;()
            .HasMany(e =&gt; e.Jobs)
            .WithMany(e =&gt; e.Equipments)
            .Map(m =&gt; m.ToTable(&quot;EquipmentIds&quot;).MapLeftKey(&quot;EquipmentId&quot;).MapRightKey(&quot;JobId&quot;));
    }
}
</code></pre>
<p>We can see the relationship (a Many:Many relationship) at the end of the <code>modelBuilder</code> within
the DbContext.  The 1:Many and 1:1 relationships are handled within the models themselves, per the
normal Entity Framework methods. This is pure Entity Framework thus far - we have defined the
structure of the database.</p>
<p>To translate this into a mobile client, we need to define Data Transfer Objects.  These don't
have to be the same shape as the models that Entity Framework is using.  For example:</p>
<pre><code class="language-csharp">public class CustomerDTO
{
    public string FullName { get; set; }
    public string Address { get; set; 
    public decimal? Latitude { get; set; }
    public decimal? Longitude { get; set; }
}

public class EquipmentDTO
{
    public string Name { get; set; }
    public string Asset { get; set; }
    public string Description { get; set; }
}

public class JobDTO : EntityData
{
    public string AgentId { get; set; }
    public DateTimeOffset? StartTime { get; set; }
    public DateTimeOffset? EndTime { get; set; }
    public string Status { get; set; }
    public string Description { get; set; }  

    public virtual CustomerDTO Customer { get; set; }
    public virtual List&lt;EquipmentDTO&gt; Equipments { get; set; }
}
</code></pre>
<p>Note that the DTOs are similar, but definitely not the same.  They don't have the same relationships between
the records, for example.  <code>MappedEntityDomainManager</code> requires that AutoMapper is already configured and
initialized, so that's the next step.  Set up an AutoMapper configuration in the <code>App_Start</code> directory:</p>
<pre><code class="language-csharp">using AutoMapper;
using FieldEngineer.Service.DataObjects;
using FieldEngineer.Service.Models;

namespace FieldEngineer.Service
{
    public class AutomapperConfiguration
    {
        public static void CreateMapping(IConfiguration cfg)
        {
            // Apply some name changes from the entity to the DTO
            cfg.CreateMap&lt;Job, JobDTO&gt;()                
                .ForMember(jobDTO =&gt; jobDTO.Equipments, map =&gt; map.MapFrom(job =&gt; job.Equipments));

            // For incoming requests, ignore the relationships
            cfg.CreateMap&lt;JobDTO, Job&gt;()                                            
                .ForMember(job =&gt; job.Customer, map =&gt; map.Ignore())
                .ForMember(job =&gt; job.Equipments, map =&gt; map.Ignore());

            cfg.CreateMap&lt;Customer, CustomerDTO&gt;();            
            cfg.CreateMap&lt;Equipment, EquipmentDTO&gt;();
        }
    }
}
</code></pre>
<p>You will also need to initialize the AutoMapper - this can be done where you also configure the Azure Mobile Apps:</p>
<pre><code class="language-csharp">using System;
using System.Web.Http;
using AutoMapper;
using Microsoft.WindowsAzure.Mobile.Service;

namespace FieldEngineer.Service
{
    public static class WebApiConfig
    {
        public static void Register()
        {
            // Use this class to set configuration options for your mobile service
            ConfigOptions options = new ConfigOptions();

            // Use this class to set WebAPI configuration options
            HttpConfiguration config = ServiceConfig.Initialize(new ConfigBuilder(options));

            // To display errors in the browser during development, uncomment the following
            // line. Comment it out again when you deploy your service for production use.
            config.IncludeErrorDetailPolicy = IncludeErrorDetailPolicy.Always;

            // This is the line that initializes AutoMapper
            Mapper.Initialize(cfg =&gt; { AutomapperConfiguration.CreateMapping(cfg); });                                
        }
    }
}
</code></pre>
<p>Finally, we can create a controller that allows the receipt and update of jobs:</p>
<pre><code class="language-csharp">namespace FieldEngineer.Service.Controllers
{
    [Authorize]  
    public class JobController : TableController&lt;JobDTO&gt;
    {      
        private FieldDbContext context;        

        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            this.context = new FieldDbContext();

            this.DomainManager = new DefaultMappedEntityDomainManager&lt;JobDTO,Job&gt;(this.context, Request, Services);            
        }

        [ExpandProperty(&quot;Customer&quot;)]
        [ExpandProperty(&quot;Equipments&quot;)]
        public async Task&lt;IQueryable&lt;JobDTO&gt;&gt; GetAllJobs()
        {                        
            var jobs = this.context.Jobs
                .Include(&quot;Customer&quot;)
                .Include(&quot;Equipments&quot;)
                .Project().To&lt;JobDTO&gt;();            
            return jobs;
        }

        [ExpandProperty(&quot;Customer&quot;)]
        [ExpandProperty(&quot;Equipments&quot;)]
        public SingleResult&lt;JobDTO&gt; GetJob(string id)
        {
            return this.Lookup(id);
        }

        public async Task&lt;JobDTO&gt; PatchJob(string id, Delta&lt;JobDTO&gt; patch)
        {
            return await this.UpdateAsync(id, patch);                   
        }        
    }
}
</code></pre>
<p>We are using <code>[ExpandProperty]</code> to expand the Customer and Equipment data so that it is transferred with the Job object.
The <code>MappedEntityDomainManager</code> is an abstract type, so we have to create a concrete implementation.  Fortunately, most
of the work is done for us.  There are already concrete versions of most of the methods we require (like insert, delete
and lookup). The <code>MappedEntityDomainManager</code> needs help to deal with replacements nor optimistic concurrency - features 
we want.  We can use the <code>DefaultMappedEntityDomainManager</code>to handle this for us:</p>
<pre><code class="language-csharp">namespace FieldEngineerLite.Service.Helpers
{
    public class DefaultMappedEntityDomainManager&lt;TData, TModel&gt;
            : MappedEntityDomainManager&lt;TData, TModel&gt;
        where TData : class, ITableData
        where TModel : class, ITableData
    {
        public DefaultMappedEntityDomainManager(DbContext context, HttpRequestMessage request, ApiServices services)
            : base(context, request, services)
        {            
        }

        public override Task&lt;bool&gt; DeleteAsync(string id)
        {
            return this.DeleteItemAsync(id);
        }

        public override Task&lt;TData&gt; UpdateAsync(string id, Delta&lt;TData&gt; patch)
        {
            return this.UpdateEntityAsync(patch, id);
        }

        public override SingleResult&lt;TData&gt; Lookup(string id)
        {
            return this.LookupEntity(model =&gt; model.Id == id);
        }

        protected override void SetOriginalVersion(TModel model, byte[] version)
        {            
            this.Context.Entry(model).OriginalValues[&quot;Version&quot;] = version;
        }
    }
}
</code></pre>
<p>The primary thing that the <code>DefaultMappedEntityDomainManager</code> does that the original doesn't is in the <code>SetOriginalVersion</code>
method.  This causes the model to be updated with a new version, allowing for conflict detection in the domain manager.</p>
<p>If we move now to the models on the mobile client, we see some fairly standard models:</p>
<pre><code class="language-csharp">public class Customer
{
    public string Id { get; set; }
    public string FullName { get; set; }
    public string Address { get; set; 
    public decimal? Latitude { get; set; }
    public decimal? Longitude { get; set; }
}

public class Equipment
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Asset { get; set; }
    public string Description { get; set; }
}

public class Job
{
    public const string CompleteStatus = &quot;Completed&quot;;
    public const string InProgressStatus = &quot;On Site&quot;;
    public const string PendingStatus = &quot;Not Started&quot;;

    public string Id { get; set; }
    public string AgentId { get; set; }
    public DateTimeOffset? StartTime { get; set; }
    public DateTimeOffSet? EndTime { get; set; }
    public string Status { get; set; }
    public string Description { get; set; }

    public Customer Customer { get; set; }
    public List&lt;Equipment&gt; Equipments { get; set; }

    [Version]
    public string Version { get; set; }
}
</code></pre>
<p>In this case, we only need to sync the Job table, so we can define it in the <code>InitializeAsync()</code> method on the client:</p>
<pre><code class="language-csharp">public async Task InitializeAsync()
{
        var store = new MobileServiceSQLiteStore(&quot;localdata.db&quot;);
        store.DefineTable&lt;Job&gt;();
        await MobileService.SyncContext.InitializeAsync(store);
}
</code></pre>
<p>You can use <code>GetSyncTable&lt;Job&gt;()</code> to get a reference to the table and deal with it as you normally would.  I'd expect in this
case that the Customer and Equipment would be handled elsewhere - maybe a separate web application that customer service
agents use, for example.</p>
<p>So, what are the caveats?  The first is that the Job, Customer and Equipment data all comes down as one record.  This has a 
side effect of ensuring that the Customer and Equipment data is read-only.  You can only update the information in the Job
table.  This is also a very time consuming process to set up properly.  Automapper is known as a fairly picky piece of 
software to integrate, so extra time must be allotted to make it work correctly.</p>
<p>In the end, I prefer handling tables individually and handling relationship management on the mobile client manually.  This
causes more code on the mobile client but makes the server much simpler by avoiding most of the complexity of relationships.</p>
<h2 id="nosql-storage-with-the-storagedomainmanager">NoSQL Storage with the StorageDomainManager<a class="headerlink" href="#nosql-storage-with-the-storagedomainmanager" title="Permanent link">&para;</a></h2>
<p>What if you don't want to use a SQL backend for your service?  Relationships between entities are not that important in the mobile client and Azure Table Storage costs significantly less than SQL Azure.  There are always trade-offs between various storage providers.  A Domain Manager enables you to swap out the storage for one of your own choosing.  Azure Mobile Apps provides a domain manager for Azure Table Storage.  Azure Table Storage is Microsoft's NOSQL key/attribute store.  It has a schemaless design, which (at least theoretically) enables you to adapt your data models as the application evolves without having to worry about the schema.</p>
<p>To see this in action, let's rework the existing data store (which has tags and todoitems as tables) to use Table Storage.  First up, we need to set up a suitable environment.  This involves:</p>
<ol>
<li>Create a Resource Group</li>
<li>Create an Azure App Service</li>
<li>Set up authentication on the Azure App Service</li>
<li>Create a Storage Account</li>
<li>Link the Storage Account to the Azure App Service.</li>
</ol>
<p>We've already covered the first three items in previous chapters.  The important element here is that we do not create a SQL database.  We are going to be using Table Storage instead so we don't need it.  To create a Storage Account:</p>
<ul>
<li>Log on to the <a href="https://portal.azure.com/">Azure portal</a>.</li>
<li>Click the big <strong>+ NEW</strong> button in the top left corner.</li>
<li>Click <strong>Data + Storage</strong>, then <strong>Storage account</strong>.</li>
<li>Fill in the form:<ul>
<li>The name can only contain letters and numbers and must be unique.  A GUID without the dashes is a good choice.</li>
<li>The <strong>Deployment model</strong> should be set to <strong>Resource manager</strong>.</li>
<li>The <strong>Account kind</strong> should be set to <strong>General purpose</strong>.</li>
<li>The <strong>Performance</strong> should be set to <strong>Standard</strong> for this example.</li>
<li>The <strong>Replication</strong> should be set to <strong>Locally-redundant storage (LRS)</strong>.</li>
<li>Set the <strong>Resource group</strong> to your existing resource group.</li>
<li>Set the <strong>Location</strong> to the same location as your App Service.</li>
</ul>
</li>
<li>Click <strong>Create</strong>.</li>
</ul>
<p>Just like SQL Azure, Azure Storage has some great scalability and redundancy features if your backend takes advantage of them. We have selected the slowest performance and least redundant options here to keep the cost down on your service.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>There is no "free" option for Azure Storage.  You pay by the kilobyte depending on the performance and redundancy selected.</p>
</div>
<p>Once the Azure Storage account is deployed, you can link the storage account to your App Service:</p>
<ul>
<li>Open your App Service in the <a href="https://portal.azure.com/">Azure portal</a>.</li>
<li>Click  <strong>Data Connections</strong> under the <strong>MOBILE</strong> section in the settings menu.</li>
<li>Click <strong>+ ADD</strong></li>
<li>In the <strong>Add data connection</strong> blade:<ul>
<li>Set the Type to <strong>Storage</strong>.</li>
<li>Click the <strong>Storage</strong> link.</li>
<li>In the <strong>Storage Account</strong> selector, click the storage account you just created.</li>
<li>Click the <strong>Connection string</strong>.</li>
<li>In the <strong>Connection string</strong> selector, make a note of the <strong>Name</strong> field.</li>
<li>Click <strong>OK</strong>.</li>
<li>Click <strong>OK</strong> to close the <strong>Add data connection</strong> blade.</li>
</ul>
</li>
</ul>
<p>Click on the <strong>Application Settings</strong> menu option, then scroll down to the <strong>Connection Strings</strong> section.  Note that the portal has created the connection string as an App Setting for you with the right value:</p>
<pre><code class="language-bash">DefaultEndpointsProtocol=https;AccountName=thebook;AccountKey=&lt;key1&gt;
</code></pre>
<p>The key is the access key for the storage.  When a storage account is created, two keys are also created.  If you re-generate the storage access keys, remember to update your connection string.  By default, the connection string is called <code>MS_AzureStorageAccountConnectionString</code> and we will use that throughout.</p>
<p>Now that our resources are set up, let's look at the Backend project.  This started off as a standard Azure Mobile Apps template.  The template assumes you are going to use SQL Azure, so there is quite a bit of work to convert the provided template to use Azure Table Storage.  Let's start with the <code>App_Start\Startup.MobileApp.cs</code> file.  There is no Entity Framework, so that needs to be stripped out:</p>
<pre><code class="language-csharp">using System.Configuration;
using System.Web.Http;
using Microsoft.Azure.Mobile.Server;
using Microsoft.Azure.Mobile.Server.Authentication;
using Microsoft.Azure.Mobile.Server.Config;
using Owin;

namespace Backend
{
    public partial class Startup
    {
        public static void ConfigureMobileApp(IAppBuilder app)
        {
            HttpConfiguration config = new HttpConfiguration();

            new MobileAppConfiguration()
                .AddTables()
                .ApplyTo(config);

            app.UseWebApi(config);
        }
    }
}
</code></pre>
<p>We've made three changes:</p>
<ol>
<li>We've removed the database seeding.</li>
<li>We've removed the database initializer.</li>
<li>We've changed <code>AddTablesWithEntityFramework()</code> to <code>AddTables()</code>.</li>
</ol>
<p>There is extra work needed with Entity Framework.  Since we aren't using it, we don't need the additional work.  We do, however, need to create the ASP.NET routes to the table controllers.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You must add the <code>Microsoft.Azure.Mobile.Server.Storage</code> package from NuGet. </p>
</div>
<p>Let's move onto the DataObjects.  These are very similar:</p>
<pre><code class="language-csharp">namespace Backend.DataObjects
{
    public class TodoItem : StorageData
    {
        public string Text { get; set; }
        public bool Complete { get; set; }
    }
}
</code></pre>
<p>Each storage implementation will likely need their own implementation of the <code>ITableData</code> interface.  The <code>StorageData</code> class performs the same duties as the <code>EntityData</code> class for Entity Framework based backends.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can remove the <code>Models</code> directory and the <code>DbContext</code> for the project.  These are only needed when working with Entity Framework.</p>
</div>
<p>The Azure Table Storage SDK is completely async driven.  Fortunately, the domain manager specification (codified in the definition of <code>IDomainManager</code>) allows both async and synchronous usage.  This does require a change to our controller:</p>
<pre><code class="language-csharp">using System.Collections.Generic;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using System.Web.Http.OData.Query;
using Backend.DataObjects;
using Microsoft.Azure.Mobile.Server;

namespace Backend.Controllers
{
    public class TodoItemController : TableController&lt;TodoItem&gt;
    {
        const string connectionString = &quot;MS_AzureStorageAccountConnectionString&quot;;
        const string tableName = &quot;TodoItem&quot;;

        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            DomainManager = new StorageDomainManager&lt;TodoItem&gt;(connectionString, tableName, Request, enableSoftDelete: true);
        }

        // GET tables/TodoItem
        public async Task&lt;IEnumerable&lt;TodoItem&gt;&gt; GetAllTodoItemsAsync(ODataQueryOptions query)
        {
            return await QueryAsync(query);
        }

        // GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task&lt;SingleResult&lt;TodoItem&gt;&gt; GetTodoItemAsync(string id)
        {
            return await LookupAsync(id);
        }

        // PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task&lt;TodoItem&gt; PatchTodoItemAsync(string id, Delta&lt;TodoItem&gt; patch)
        {
            return await UpdateAsync(id, patch);
        }

        // POST tables/TodoItem
        public async Task&lt;IHttpActionResult&gt; PostTodoItemAsync(TodoItem item)
        {
            TodoItem current = await InsertAsync(item);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task DeleteTodoItemAsync(string id)
        {
            await DeleteAsync(id);
        }
    }
}
</code></pre>
<p>Note how we instantiate the storage domain controller.  This requires a connection string and the name of the table.  We have created the connection string in the portal, but we have not exposed that connection string to our ASP.NET application. We need to edit the <code>Web.config</code> file as well:</p>
<pre><code class="language-xml">&lt;connectionStrings&gt;
    &lt;add name=&quot;MS_AzureStorageAccountConnectionString&quot; connectionString=&quot;UseDevelopmentStorage=true&quot;/&gt;
&lt;/connectionStrings&gt;
</code></pre>
<p>This will be overwritten by the connection string in the portal.  If you are running the service locally, you can use this
setting with the Azure Storage Emulator.  If you don't add this line to the <code>Web.config</code>, you will not be able to run this
server locally.</p>
<p>This backend can now be published and we can work with Postman to test it out.  For instance, let's try adding a simple test
of getting some data:</p>
<p><img alt="" src="../img/storage-1.PNG" /></p>
<p>This is exactly the same response as we got when we don't have any data from the Entity Framework version.  Let's add a 
record:</p>
<p><img alt="" src="../img/storage-2.PNG" /></p>
<p>There are a couple of things to note here.  Firstly, the Id must be specified.  It also must be of a specific form.  There are two numbers.  The first is a partition key and the second is a row key.  Tables are partitioned to support load balancing across storage notes.  It can be anything you wish it to be.  Similarly, the row key is unique within a partition.  We can use this information to generate a suitable Id if one is not provided:</p>
<pre><code class="language-csharp">// POST tables/TodoItem
public async Task&lt;IHttpActionResult&gt; PostTodoItemAsync(TodoItem item)
{
    if (item.Id == null || item.Id == &quot;'',''&quot;)
    {
        item.Id = GenerateUniqueId();
    }
    TodoItem current = await InsertAsync(item);
    return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
}

private string GenerateUniqueId()
{
    var partitionId = &quot;1&quot;;
    var rowId = Guid.NewGuid().ToString(&quot;N&quot;);
    return $&quot;'{partitionId}','{rowId}'&quot;;
}
</code></pre>
<p>The value <code>'',''</code> is the default value of the Id column.  However, that is not good enough to get a successful store.  This code
generates a unique identifier in the right format.  A single partition is reasonable for most applications.  If you intend on
storing massive amounts of data, the data partitioning scheme will require some consideration (just like any other NoSQL application).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You will need a copy of the <code>GenerateUniqueId()</code> method if you generate unique identifiers for your records within 
your mobile client.  The partition key and row key are returned as part of the record.  </p>
</div>
<p>You can use the <strong>Cloud Explorer</strong> if you wish to see the data stored in Azure Table Storage.  Expand the <strong>Storage Accounts</strong> node,
then expand the appropriate nodes: your storage account, <strong>Tables</strong>, <strong>TodoItem</strong>.  You can open the table editor or delete the table
from there.  </p>
<p><img alt="" src="../img/storage-3.PNG" /></p>
<p>Within the table editor, you can right-click on any row to delete or edit values.  This will update the time stamp and etag, ensuring
that your mobile clients are updated as well.</p>
<h3 id="limitations-of-the-azure-storage-domain-manager">Limitations of the Azure Storage Domain Manager<a class="headerlink" href="#limitations-of-the-azure-storage-domain-manager" title="Permanent link">&para;</a></h3>
<p>There are, of course, caveats to working in Azure Mobile Apps with Azure Table Storage.   There are three major caveats that you should
be aware of.</p>
<ol>
<li>There are no relationships possible with Azure Table Storage.</li>
<li>Only <code>$filter</code>, <code>$top</code> and <code>$select</code> are supported in the URI.</li>
<li>Offline sync only supports flat objects.</li>
</ol>
<p>Let's take a look at each in turn.</p>
<p><strong>No relationhips</strong></p>
<p>You have to work at relationships and relationships between entities are severely restricted in Entity Framework.  However, they are
possible.  Not so with Azure Table Storage.  The NoSQL store has no concept of a relationship of any description.  This is not a major
caveat since your mobile client similarly has no notion of relationships.  Just treat every table as distinct.</p>
<p><strong>Limited support for OData query options</strong></p>
<p>Only <code>$filter</code>, <code>$top</code> and <code>$select</code> are <a href="https://msdn.microsoft.com/en-us/library/azure/dd894031.aspx">supported by the OData interface</a>.  Since the Azure Table Storage Domain Manager passes the 
incoming OData query to the Storage driver intact, this limitation is passed on to the OData interface for Azure Mobile Apps.  Specifically, 
this means paging is handled differently.  With the <code>EntityDomainManager</code>, paging was accomplished by using <code>$skip</code> and <code>$top</code> to get more
records until zero records were returned.  With the <code>StorageDomainManager</code>, a <code>Link</code> header is returned when there are more records.</p>
<p><img alt="" src="../img/storage-4.PNG" /></p>
<p>The <code>Link</code> header contains the URI that you need to retrieve to get the next page of the results.  This has implications for how you 
receive more than 50 records.</p>
<p><strong>Offline sync only supports "flat" objects</strong></p>
<p>One of the common reasons for using NoSQL stores is that you can store pretty much any document you wish.  You just have to have a JSON
representation of the object cross the wire.  If you have complex objects stored in Azure Table Storage, they won't be able to be stored
in the offline cache.  The offline cache is based on SQLite and inherits the limitations of that resource.  In particular, this means no
complex types.</p>
<p>Using a NoSQL store seems like a great idea.  However, the limitations of the platform make Azure Table Storage a poor choice for this
particular function.  The Azure Table Storage is ill-suited to the demands of a mobile client backend.</p>
<p>One of the great uses of the Azure Table Storage Domain Manager is to see how you can write your own domain manager.  The <a href="https://github.com/Azure/azure-mobile-apps-net-server/blob/master/src/Microsoft.Azure.Mobile.Server.Storage/StorageDomainManager.cs">code</a> for
the domain manager (and the ITableData interface) is relatively simple since it passes through the OData query to Azure Storage.  This
allows you to see what is truly involved in writing a domain manager.</p>
<!-- Images -->
<!-- Links -->

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../relationships/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Relationships" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Relationships
            </div>
          </div>
        </a>
      
      
        
        <a href="../../chapter4/options/" class="md-footer__link md-footer__link--next" aria-label="Next: Options for Server Code" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Options for Server Code
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2017-2020 Adrian Hall
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/adrianhall" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/FizzyInTheHall" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c2e1ee47.min.js"></script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>