
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter3/server/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.14">
    
    
      
        <title>Implementing Table Controllers - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3de6f41f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#implementing-table-controllers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Implementing Table Controllers
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Chapter 1 - Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 1 - Introduction" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Chapter 1 - Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_pc/" class="md-nav__link">
        Your First App - PC Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_mac/" class="md-nav__link">
        Your First App - Mac Edition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Chapter 2 - Authentication
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 2 - Authentication" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Chapter 2 - Authentication
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/backend/" class="md-nav__link">
        Authentication in the Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/enterprise/" class="md-nav__link">
        Enterprise Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/social/" class="md-nav__link">
        Social Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/debugging/" class="md-nav__link">
        Debugging Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/custom/" class="md-nav__link">
        Custom Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authorization/" class="md-nav__link">
        Claims and Authorization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/realworld/" class="md-nav__link">
        Tokens in Real Apps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/bestpractices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Chapter 3 - Data Access and Offline Sync
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 3 - Data Access and Offline Sync" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Chapter 3 - Data Access and Offline Sync
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../dataconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Implementing Table Controllers
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Implementing Table Controllers
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementing-code-first-migrations" class="md-nav__link">
    Implementing Code First Migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-sql-table-controller" class="md-nav__link">
    Adding a SQL Table Controller
  </a>
  
    <nav class="md-nav" aria-label="Adding a SQL Table Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-data-transfer-object" class="md-nav__link">
    Creating a Data Transfer Object
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-table-controller" class="md-nav__link">
    Create a Table Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-code-first-migration" class="md-nav__link">
    Creating a Code-First Migration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-publish-failures" class="md-nav__link">
    Handling Publish Failures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#turning-on-diagnostic-logs" class="md-nav__link">
    Turning on Diagnostic Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-an-existing-sql-table" class="md-nav__link">
    Using an existing SQL Table
  </a>
  
    <nav class="md-nav" aria-label="Using an existing SQL Table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-mobile-schema" class="md-nav__link">
    Changing the Mobile Schema
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../projection/" class="md-nav__link">
        Data Projection and Queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../client/" class="md-nav__link">
        The Mobile Client
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../relationships/" class="md-nav__link">
        Relationships
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../domainmgr/" class="md-nav__link">
        The Domain Manager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Chapter 4 - Server Side Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 4 - Server Side Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Chapter 4 - Server Side Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/options/" class="md-nav__link">
        Options for Server Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/custom/" class="md-nav__link">
        Custom HTTP Endpoints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/webjobs/" class="md-nav__link">
        WebJobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/functions/" class="md-nav__link">
        Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/recipes/" class="md-nav__link">
        Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Chapter 5 - Push Notifications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 5 - Push Notifications" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Chapter 5 - Push Notifications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/android/" class="md-nav__link">
        Android Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/ios/" class="md-nav__link">
        iOS Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/windows/" class="md-nav__link">
        Windows Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter5/recipes/" class="md-nav__link">
        Push Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Chapter 6 - Combining Web and Mobile Apps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 6 - Combining Web and Mobile Apps" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Chapter 6 - Combining Web and Mobile Apps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/mvc/" class="md-nav__link">
        MVC Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/jquery/" class="md-nav__link">
        jQuery Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/angular/" class="md-nav__link">
        Angular Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/react/" class="md-nav__link">
        React Applications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Chapter 7 - Other Useful Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 7 - Other Useful Services" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Chapter 7 - Other Useful Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/services/" class="md-nav__link">
        Useful Azure Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/search/" class="md-nav__link">
        Azure Search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/media/" class="md-nav__link">
        Media Services
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Chapter 8 - Developing An App
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 8 - Developing An App" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Chapter 8 - Developing An App
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/developing/" class="md-nav__link">
        The Development Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/testing/" class="md-nav__link">
        Testing your Application
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Chapter 9 - Going to Production
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 9 - Going to Production" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Chapter 9 - Going to Production
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/arm/" class="md-nav__link">
        Repeatable Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/appsvc/" class="md-nav__link">
        Safe Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/monitoring/" class="md-nav__link">
        Monitoring and Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../xamarin_tips/" class="md-nav__link">
        Xamarin Forms Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../android_appendix/" class="md-nav__link">
        Android Developer Notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../vs_extensions/" class="md-nav__link">
        Visual Studio Extensions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../credits/" class="md-nav__link">
        Credits
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#implementing-code-first-migrations" class="md-nav__link">
    Implementing Code First Migrations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#adding-a-sql-table-controller" class="md-nav__link">
    Adding a SQL Table Controller
  </a>
  
    <nav class="md-nav" aria-label="Adding a SQL Table Controller">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-data-transfer-object" class="md-nav__link">
    Creating a Data Transfer Object
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-table-controller" class="md-nav__link">
    Create a Table Controller
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-a-code-first-migration" class="md-nav__link">
    Creating a Code-First Migration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-publish-failures" class="md-nav__link">
    Handling Publish Failures
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#turning-on-diagnostic-logs" class="md-nav__link">
    Turning on Diagnostic Logs
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-an-existing-sql-table" class="md-nav__link">
    Using an existing SQL Table
  </a>
  
    <nav class="md-nav" aria-label="Using an existing SQL Table">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#changing-the-mobile-schema" class="md-nav__link">
    Changing the Mobile Schema
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practices" class="md-nav__link">
    Best Practices
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter3/server.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="implementing-table-controllers">Implementing Table Controllers<a class="headerlink" href="#implementing-table-controllers" title="Permanent link">&para;</a></h1>
<p>The central component for providing a table endpoint on the Azure App Service side of things occurs in your
backend project.  You must implement a Table Controller.  This is a specialized version of an ApiController
that has some similarities with an ODataController.  However, it has its own base class and the Azure Mobile
Apps SDK simplifies the process of making them.</p>
<h2 id="implementing-code-first-migrations">Implementing Code First Migrations<a class="headerlink" href="#implementing-code-first-migrations" title="Permanent link">&para;</a></h2>
<p>Before we can get started with adding another table controller, we have to deal with modifications to our
database schema.  The default code for Azure Mobile Apps will deploy the configured schema <strong>only if the
database is empty</strong>.  If the database is not empty, you have to do extra work.  This extra work involves
updating the schema of your database.</p>
<p>There are two methods of doing this.  The first we will consider is Code First Migrations.  With code first
migrations, we construct a code file whenever we need to change the database.  Don't worry - it's done for
us.  Later on, we will consider Database First.  With database first, we adjust the database schema
manually, then write C# models to reflect that change.</p>
<p>Nothing causes more headaches in an Azure Mobile Apps backend than <a href="https://msdn.microsoft.com/en-us/data/jj591621">code-first migrations</a>.  A code-first
migration is simply a set of configuration commands that updates the database to support the new
database model.  If you try to publish this application, you will see an <code>InvalidOperationException</code>
and your service will likely crash.  If you manage to trap the error, it will say <em>The model backing
the 'MobileServiceContext' context has changed since the database was created. Consider using Code First
Migrations to update the database.</em>  That's fairly specific and is common to all applications based
on Entity Framework that use code-first models.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>There is an alternative here called <strong>Database First Models</strong>.  In this alternative, you create the
database first then create the models to match.  However, Azure Mobile Apps requires specific configuration
of mobile tables that you will need to take care of.  See <a href="#using-an-existing-sql-table">the section</a> on
<a href="#using-an-existing-sql-table">using existing SQL tables</a> later on for details.</p>
</div>
<p>The first step is to enable migrations.  Go to <strong>View</strong> -&gt; <strong>Other Windows</strong> -&gt; <strong>Package Manager Console</strong>.
This window will generally appear in the same place as your Output and Error List windows at the bottom
of the screen.  Type <code>enable-migrations</code> in it:</p>
<p><img alt="" src="../img/enable-migrations.PNG" /></p>
<p>Check out the <code>Migrations</code> folder that has just been created to hold the code-first migrations.  An initial
<code>Configuration.cs</code> object will be added to this folder that describes the basic configuration.  We also need
to create an Initial migration that represents the current state of the database.  We can do this with the
command <code>add-migration Initial</code>.</p>
<p><img alt="" src="../img/add-initial-migration.PNG" /></p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If you have multiple projects in your solution, you may need to add <code>-Project _projectname_</code>.  For example,
<code>add-migration -project Chapter3 Initial</code>.  This applies to all the migration commands you execute in the
Package Manager Console.</p>
</div>
<p>The initial migration creates a few files in the <code>Migrations</code> folder that represent the current state of
affairs for the database. These easily recognized by a combination of the current date and the name of the
migration.  Code First Migrations can be applied manually or automatically.  I personally prefer the automatic
method.  To implement automated Code First Migrations, edit the <code>App_Start\Startup.MobileApp.cs</code> file:</p>
<pre><code class="language-csharp">public static void ConfigureMobileApp(IAppBuilder app)
{
    var httpConfig = new HttpConfiguration();
    var mobileConfig = new MobileAppConfiguration();

    mobileConfig
        .AddTablesWithEntityFramework()
        .ApplyTo(httpConfig);

    // Automatic Code First Migrations
    var migrator = new DbMigrator(new Migrations.Configuration());
    migrator.Update();

    app.UseWebApi(httpConfig);
}
</code></pre>
<p>We have replaced the <code>DbInitializer()</code> (which was the method that created the database for us) with the
automatic database migrator code.  There is one issue that will cause some problems.  We are no longer using
a database initializer.  The database initializer is the single line of code we just replaced that creates
the database tables with the appropriate triggers. This means that the special system columns will no longer
be wired up to update their values automatically. We can fix that by configuring the SqlGenerator in
<code>Migrations\Configuration.cs</code>:</p>
<pre><code class="language-csharp">public Configuration()
{
    AutomaticMigrationsEnabled = false;
    SetSqlGenerator(&quot;System.Data.SqlClient&quot;, new EntityTableSqlGenerator());
}
</code></pre>
<p>Since we are not using a database initializer, our seed data has also gone.  You may as well delete the
<code>MobileServiceInitializer</code> class in the <code>App_Start\Startup.MobileApp.cs</code> as it isn't doing anything
any more.  You can move the seed data to the <code>Migrations\Configuration.cs</code> file though:</p>
<pre><code class="language-csharp">namespace Chapter3.Migrations
{
    using System;
    using System.Collections.Generic;
    using System.Data.Entity.Migrations;
    using DataObjects;
    using Microsoft.Azure.Mobile.Server.Tables;

    internal sealed class Configuration : DbMigrationsConfiguration&lt;Chapter3.Models.MobileServiceContext&gt;
    {
        public Configuration()
        {
            AutomaticMigrationsEnabled = false;
            SetSqlGenerator(&quot;System.Data.SqlClient&quot;, new EntityTableSqlGenerator());
        }

        protected override void Seed(Chapter3.Models.MobileServiceContext context)
        {
            List&lt;TodoItem&gt; todoItems = new List&lt;TodoItem&gt;
            {
                new TodoItem { Id = Guid.NewGuid().ToString(), Text = &quot;First item&quot;, Complete = false },
                new TodoItem { Id = Guid.NewGuid().ToString(), Text = &quot;Second item&quot;, Complete = false }
            };

            foreach (TodoItem todoItem in todoItems)
            {
                context.Set&lt;TodoItem&gt;().Add(todoItem);
            }

            base.Seed(context);
        }
    }
}
</code></pre>
<p>The contents of the <code>Seed</code> method are a cut-and-paste from the <code>MobileServiceInitializer</code> version.</p>
<p>If all goes well, you can clear your database (or delete it and re-create it), then publish this project
and do a GET of the <code>/tables/todoitem</code> endpoint.  You should still see your data.  You should do a little
more investigation however.</p>
<ul>
<li>Open the database in the <strong>SQL Server Object Explorer</strong>.</li>
<li>Expand the <strong>Tables</strong> node.</li>
<li>Right-click on the <strong>dbo.__MigrationHistory</strong> table and select <strong>View Data</strong>.</li>
</ul>
<p><img alt="" src="../img/initial-migration-applied.PNG" /></p>
<p>There should be one row with a name that indicates it is the initial migration.</p>
<p>The final step is to apply the migration to the local system.  In the Package Manager Console, enter
the command <code>update-database</code> to apply the existing migration.</p>
<h2 id="adding-a-sql-table-controller">Adding a SQL Table Controller<a class="headerlink" href="#adding-a-sql-table-controller" title="Permanent link">&para;</a></h2>
<p>Before we can use a table controller, we need to add one.  This has three steps:</p>
<ul>
<li>Create a Data Transfer Object (DTO)</li>
<li>Create a Table Controller</li>
<li>Create a Code-First Migration</li>
</ul>
<h3 id="creating-a-data-transfer-object">Creating a Data Transfer Object<a class="headerlink" href="#creating-a-data-transfer-object" title="Permanent link">&para;</a></h3>
<p>A Data Transfer Object (or DTO as it is commonly known) is the wire representation of the model for your
table.  It must inherit from a concrete implementation of <code>ITableData</code>.  The Azure Mobile Apps SDK includes
<code>EntityData</code> for this reason.  EntityData is a concrete implementation that works with Entity Framework.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>You can't just assume EntityData will work with other data stores.  There are Entity Framework specific
attributes decorating the properties for EntityData that will likely be different for other stores.</p>
</div>
<p>The default Azure Mobile Apps project that is supplied with the Azure SDK provides a folder for storing
DTOs called <code>DataObjects</code>.  Let's create a DTO by right-clicking on the <strong>DataObjects</strong> folder, then
using <strong>Add</strong> -&gt; <strong>Class...</strong>:</p>
<pre><code class="language-csharp">using System;
using Microsoft.Azure.Mobile.Server;

namespace Chapter3.DataObjects
{
    public class Example : EntityData
    {
        public string StringField { get; set; }
        public int IntField { get; set; }
        public double DoubleField { get; set; }
        public DateTimeOffset DateTimeField { get; set; }
    }
}
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Don't call your model <code>SomethingDTO</code>.  This ends up as a <code>/tables/somethingDTO</code> endpoint and a <code>SomethingDTO</code>
table in your database.  Just call it <code>Something</code>.  All the names will then line up properly.</p>
</div>
<p>I've included several field types, including a complex type.  The basic requirement for a field is that it
must be serialized into a simple JSON type during transfer between the server and the mobile client.  Complex
types (that is, any type that can be serialized to an object or array) will always require special handling
and may not be able to be used at all.</p>
<h3 id="create-a-table-controller">Create a Table Controller<a class="headerlink" href="#create-a-table-controller" title="Permanent link">&para;</a></h3>
<p>Visual Studio for Windows (with the Azure SDK) provides some help in creating a table controller.  Right-click on the <strong>Controllers</strong> node and select <strong>Add</strong> -&gt; <strong>Controller...</strong>.</p>
<p><img alt="" src="../img/new-controller-1.PNG" /></p>
<p>Visual Studio provides scaffolding for a new table controller.  Select it and then click on <strong>Add</strong>.</p>
<p><img alt="" src="../img/new-controller-2.PNG" /></p>
<p>The dialog asks for the model (which is actually a DTO) and the data context (which is already created).
Once you select the model, the controller name is created for you.  You can change it if you like, but
it's common practice to not do this.</p>
<p>Once the scaffolding is finished, you can look at your newly created table controller.  We do want to do one change.  We want to enable soft delete so that our table controller supports offline sync scenarios properly.  To do this, go into the <code>Initialize()</code> method and change the constructor of the <code>EntityDomainManager</code>.  The completed table controller looks like this:</p>
<pre><code class="language-csharp">using System.Linq;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using Microsoft.Azure.Mobile.Server;
using Chapter3.DataObjects;
using Chapter3.Models;

namespace Chapter3.Controllers
{
    public class ExampleController : TableController&lt;Example&gt;
    {
        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            MobileServiceContext context = new MobileServiceContext();
            DomainManager = new EntityDomainManager&lt;Example&gt;(context, Request, enableSoftDelete: true);
        }

        // GET tables/Example
        public IQueryable&lt;Example&gt; GetAllExample()
        {
            return Query();
        }

        // GET tables/Example/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public SingleResult&lt;Example&gt; GetExample(string id)
        {
            return Lookup(id);
        }

        // PATCH tables/Example/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public Task&lt;Example&gt; PatchExample(string id, Delta&lt;Example&gt; patch)
        {
             return UpdateAsync(id, patch);
        }

        // POST tables/Example
        public async Task&lt;IHttpActionResult&gt; PostExample(Example item)
        {
            Example current = await InsertAsync(item);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/Example/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public Task DeleteExample(string id)
        {
             return DeleteAsync(id);
        }
    }
}
</code></pre>
<h3 id="creating-a-code-first-migration">Creating a Code-First Migration<a class="headerlink" href="#creating-a-code-first-migration" title="Permanent link">&para;</a></h3>
<p>You must add a code first migration to update the database when it is published. Use the <code>add-migration</code> command in the Package Manager Console.  The <code>add-migration</code> command will request a name - it just has to be unique, but it's a good idea to make the name descriptive:</p>
<p><img alt="" src="../img/add-migration.PNG" /></p>
<p>You should also use <code>update-database</code> to apply the change to the local database (if any):</p>
<p><img alt="" src="../img/update-database.PNG" /></p>
<p>Once this is done, you can publish the project.  Right-click on the project and select <strong>Publish...</strong>.  Once the project is published, you should be able to send a query to the <code>/tables/example</code> endpoint using Postman and get an empty array.  You should also be able to insert, update and delete entities as you can with the <code>TodoItem</code> table.</p>
<h3 id="handling-publish-failures">Handling Publish Failures<a class="headerlink" href="#handling-publish-failures" title="Permanent link">&para;</a></h3>
<p>Sometimes, the publish fails.  It seems that whenever I start with code-first migrations, my publish fails.  I get a nice error screen, but no actual error.  At least half the time, the problem is not my code-first migration, but something else.  For instance, one of the things I tend to do is update my NuGet packages. This inevitably breaks something.</p>
<p>Fortunately, once the error message is known, it's generally trivial to correct the error.  You can turn custom error messages off (and thus expose the original error message) by editing the Web.config file.  Locate the <code>&lt;system.web&gt;</code> section and add the <code>&lt;customErrors mode="Off"/&gt;</code> line:</p>
<pre><code class="language-xml">  &lt;system.web&gt;
    &lt;httpRuntime targetFramework=&quot;4.6&quot; /&gt;
    &lt;compilation debug=&quot;true&quot; targetFramework=&quot;4.6&quot; /&gt;
    &lt;customErrors mode=&quot;Off&quot; /&gt;
  &lt;/system.web&gt;
</code></pre>
<p>Then republish your project and the response from the server is much more informative.</p>
<h3 id="turning-on-diagnostic-logs">Turning on Diagnostic Logs<a class="headerlink" href="#turning-on-diagnostic-logs" title="Permanent link">&para;</a></h3>
<p>You can log all the SQL statements that Entity Framework executes on your behalf by adding a Database Log.  Edit the <code>Models\MobileServiceContext.cs</code> file:</p>
<pre><code class="language-csharp">public class MobileServiceContext : DbContext
{
    private const string connectionStringName = &quot;Name=MS_TableConnectionString&quot;;

    public MobileServiceContext() : base(connectionStringName)
    {
        Database.Log = s =&gt; WriteLog(s);
    }

    public void WriteLog(string msg)
    {
        System.Diagnostics.Debug.WriteLine(msg);
    }

    protected override void OnModelCreating(DbModelBuilder modelBuilder)
    {
        modelBuilder.Conventions.Add(
            new AttributeToColumnAnnotationConvention&lt;TableColumnAttribute, string&gt;(
                &quot;ServiceTableColumn&quot;, (property, attributes) =&gt; attributes.Single().ColumnType.ToString()));
    }

    public DbSet&lt;DataObjects.TodoItem&gt; TodoItems { get; set; }
    public DbSet&lt;DataObjects.Example&gt; Examples { get; set; }
}
</code></pre>
<p>You have to use a real method.  System.Diagnostics.Debug is removed from the context when DEBUG is not defined, so you can't just use it directly.   Using an interim method works around that problem. Azure App Service captures the output from the console and places it into the log viewer for you.</p>
<p>To turn on diagnostic logging:</p>
<ul>
<li>Log in to the <a href="https://portal.azure.com">Azure Portal</a>.</li>
<li>Click on <strong>App Services</strong> then your App Service.</li>
<li>Find <strong>Diagnostic Logs</strong> in the list of settings (you can use the search box).</li>
<li>Turn on <strong>Application Logging (Filesystem)</strong> with a level of <strong>Verbose</strong>.</li>
<li>Click on <strong>Save</strong>.</li>
</ul>
<p>To view the diagnostic logs in the portal, find <strong>Log Stream</strong> in the list of settings (again, you can
use the search box).  You can also get the diagnostic logs within Visual Studio.</p>
<ul>
<li>Open the <strong>Server Explorer</strong>.</li>
<li>Expand <strong>Azure</strong>, <strong>App Service</strong>, your resource group.</li>
<li>Right-click on the your App Service and select <strong>View Streaming Logs</strong>.</li>
</ul>
<p><img alt="" src="../img/debug-logging.PNG" /></p>
<h2 id="using-an-existing-sql-table">Using an existing SQL Table<a class="headerlink" href="#using-an-existing-sql-table" title="Permanent link">&para;</a></h2>
<p>There are times when a "Database First" approach is needed.  If you are trying to expose an existing
SQL database table, for example, you want to use a "Database First" approach.  You may also like the
separation of the database table from the mobile system columns.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>The Database First and Code First approaches to Entity Framework are mutually exclusive.  You need
to decide which one you want to use and stick with it.</p>
</div>
<p>To use "Database First", you first set up the database.  Then you create a Model and update the DbContext object.  For example, our <code>Example</code> model from before can be represented by the following database schema:</p>
<pre><code class="language-sql">CREATE TABLE [dbo].[Examples] (
    -- This must be a string suitable for a GUID
    [Id]            NVARCHAR (128)     NOT NULL,

    -- These are the system properties
    [Version]       ROWVERSION         NOT NULL,
    [CreatedAt]     DATETIMEOFFSET (7) NOT NULL,
    [UpdatedAt]     DATETIMEOFFSET (7) NULL,
    [Deleted]       BIT                NOT NULL

    -- These are the properties of our DTO not included in EntityFramework
    [StringField]   NVARCHAR (MAX)     NULL,
    [IntField]      INT                NOT NULL,
    [DoubleField]   FLOAT (53)         NOT NULL,
    [DateTimeField] DATETIMEOFFSET (7) NOT NULL,
);

CREATE CLUSTERED INDEX [IX_CreatedAt]
    ON [dbo].[Examples]([CreatedAt] ASC);

ALTER TABLE [dbo].[Examples]
    ADD CONSTRAINT [PK_dbo.Examples] PRIMARY KEY NONCLUSTERED ([Id] ASC);

CREATE TRIGGER [TR_dbo_Examples_InsertUpdateDelete] ON [dbo].[Examples]
    AFTER INSERT, UPDATE, DELETE AS
    BEGIN
        UPDATE [dbo].[Examples]
            SET [dbo].[Examples].[UpdatedAt] = CONVERT(DATETIMEOFFSET, SYSUTCDATETIME())
            FROM INSERTED WHERE inserted.[Id] = [dbo].[Examples].[Id]
    END;
</code></pre>
<p>The system properties are added to the schema.  We can (and do) use a trigger to update the UpdatedAt
column when the data is updated.  Placing this logic within the SQL Server schema definition means
we can use this SQL table outside of the mobile context and it will still work for the mobile application.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We use the CreatedAt field to create a clustered index.  In older versions of SQL Server, this was
required to increase performance on the table as a whole.  It may not be required now and may be removed
in future versions of Azure Mobile Apps.</p>
</div>
<p>If you can update an existing table to match this schema, then you should do so.  Note that the Id field is
not set by default.  If you want to set a default, set it to <code>NEWID()</code>:</p>
<pre><code class="language-sql">ALTER TABLE [dbo].[Examples]
    ALTER COLUMN [Id] SET DEFAULT CONVERT(NVARCHAR(128), NEWID());
</code></pre>
<p>Once you have set up the database and created the models, you must also turn off the database initializer.
This is done in <code>App_Start\Startup.MobileApp.cs</code>:</p>
<pre><code class="language-csharp">public static void ConfigureMobileApp(IAppBuilder app)
{
    var httpConfig = new HttpConfiguration();
    var mobileConfig = new MobileAppConfiguration();

    mobileConfig
        .AddTablesWithEntityFramework()
        .ApplyTo(httpConfig);

    // Automatic Code First Migrations
    // var migrator = new DbMigrator(new Migrations.Configuration());
    // migrator.Update();

    // Database First
    Database.SetInitializer&lt;MobileDbContext&gt;(null);

    app.UseWebApi(httpConfig);
}
</code></pre>
<p>There are a lot of times when the existing table is not suitable for this sort of schema adjustment.  The
primary reason will be that the existing table has an auto-incrementing integer Id column and you can't
change that.  Quite often, I see developers needing to integrate the SQL schema of an existing application
like a Customer Relationship Management system with this constraint, for example.</p>
<p>Let's take an example.  Suppose you have a table called [dbo].[TodoItems].  This is fairly basic and
defined like this:</p>
<pre><code class="language-sql">CREATE TABLE [dbo].[TodoItems] (
  [id]       BIGINT NOT NULL IDENTITY(1,1) PRIMARY KEY,
  [UserId]   NVARCHAR(255) NOT NULL,
  [Title]    NVARCHAR(255) NOT NULL,
  [Complete] BIT
);
</code></pre>
<p>This is the sort of SQL table that is very common within existing web applications, for instance.  We have
an auto-incrementing id column and some fields.  It isn't complex (no relationships, for example), so we
don't have to worry about <a href="https://msdn.microsoft.com/en-us/library/aa292166(v=vs.71).aspx">referential integrity</a> of the table.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>I recommend placing the "mobile views" that we will discuss below in a separate schema (for example,
<code>[mobile]</code>) so that they don't interfere with your existing database schema.</p>
</div>
<p>Let's take a look at creating a VIEW of the data that is "mobile ready".  This is an Entity Relationship
Diagram of what we are going to do:</p>
<p><img alt="" src="../img/erd-diagram.PNG" /></p>
<p>we are going to create a separate table for the system properties, called <code>[mobile].[SysProps_TodoItems]</code>.
This will hold the five fields that Azure Mobile Apps requires, plus a reference to the TodoItem id:</p>
<pre><code class="language-sql">CREATE TABLE [mobile].[SysProps_TodoItems] (
  [Id]        NVARCHAR(128) CONSTRAINT [DF_todoitem_id] DEFAULT (CONVERT([NVARCHAR](255),NEWID(),(0))) NOT NULL,
  [CreatedAt] DATETIMEOFFSET(7) CONSTRAINT [DF_todoitem_createdAt] DEFAULT (CONVERT([DATETIMEOFFSET](7),SYSUTCDATETIME(),(0))) NOT NULL,
  [UpdatedAt] DATETIMEOFFSET(7) NULL,
  [Version]   ROWVERSION NOT NULL,
  [Deleted]   BIT DEFAULT ((0)) NOT NULL,
  [Item_Id]   BIGINT NOT NULL
  PRIMARY KEY NONCLUSTERED ([id] ASC)
);
</code></pre>
<p>Then we will create a SQL VIEW that maps to this:</p>
<pre><code class="language-sql">CREATE VIEW [mobile].[TodoItems] AS
SELECT
    [mobile].[SysProps_TodoItems].[Id],
    [mobile].[SysProps_TodoItems].[CreatedAt],
    [mobile].[SysProps_TodoItems].[UpdatedAt],
    [mobile].[SysProps_TodoItems].[Version],
    [mobile].[SysProps_TodoItems].[Deleted],
    [mobile].[SysProps_TodoItems].[Item_Id],
    [dbo].[TodoItems].[UserId],
    [dbo].[TodoItems].[Title],
    [dbo].[TodoItems].[Complete]
FROM
    [dbo].[TodoItems],
    [mobile].[SysProps_TodoItems]
WHERE
    [dbo].[TodoItems].[id] = [mobile].[SysProps_TodoItems].[Item_Id];
</code></pre>
<p>This view is still only a combination of the two tables.  I want specific logic so that when a row
is changed (inserted, updated or deleted) in the <code>[dbo].[TodoItems]</code> table, a similar change is made
to the <code>[mobile].[SysProps_TodoItems]</code> table.  This is achieved through the use of triggers:</p>
<pre><code class="language-sql">CREATE TRIGGER
    [dbo].[TRG_TodoItem_Insert]
ON
    [dbo].[TodoItems]
AFTER
    INSERT
AS BEGIN
    INSERT INTO [mobile].[SysProps_TodoItems] ([Item_Id], [UpdatedAt])
    SELECT inserted.id, CONVERT(DATETIMEOFFSET(7), SYSUTCDATETIME())
    FROM inserted
END
GO

CREATE TRIGGER
    [dbo].[TRG_TodoItem_Update]
ON
    [dbo].[TodoItems]
AFTER
    UPDATE
AS BEGIN
    UPDATE
        [mobile].[SysProps_TodoItems]
    SET
        [UpdatedAt] = CONVERT(DATETIMEOFFSET(7), SYSUTCDATETIME())
    FROM
        INSERTED
    WHERE
        INSERTED.id = [mobile].[SysProps_TodoItems].[Item_Id]
END
GO

CREATE TRIGGER
    [dbo].[TRG_TodoItem_Delete]
ON
    [dbo].[TodoItems]
AFTER
    DELETE
AS BEGIN
    DELETE FROM [mobile].[SysProps_TodoItems]
    WHERE [Item_Id] IN (select deleted.id from deleted)
END
GO
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You may want to set the <code>Deleted</code> flag to 1 (or true) in the Delete trigger.  This will enable soft
delete on the system properties table, ensuring that mobile clients remove the row from their offline
cache.</p>
</div>
<p>Similarly, when changes are made by the mobile backend to the VIEW, we need to propagate those changes
to the underlying tables.  This is also done with triggers:</p>
<pre><code class="language-sql">CREATE TRIGGER
    [mobile].[TRG_Mobile_TodoItem_Insert]
ON
    [mobile].[TodoItems]
INSTEAD OF
    INSERT
AS BEGIN
    DECLARE @userid AS NVARCHAR(255)
    SELECT @userid = inserted.UserId FROM inserted
    DECLARE @title AS NVARCHAR(255)
    SELECT @title = inserted.Title FROM inserted
    DECLARE @complete AS BIT
    SELECT @complete = inserted.Complete FROM inserted


    INSERT INTO
        [dbo].[TodoItems] ([UserId], [Title], [Complete])
    VALUES
        (@userid, @title, @complete)

    IF UPDATE(Id) BEGIN
        DECLARE @itemid AS BIGINT
        SELECT @itemid = @@identity
        DECLARE @id AS NVARCHAR(255)
        SELECT @id = inserted.Id FROM inserted
        UPDATE [mobile].[SysProps_TodoItems] SET [Id] = @id WHERE [item_id] = @itemid
    END
END;
GO

CREATE TRIGGER
    [mobile].[TRG_Mobile_TodoItem_Update]
ON
    [mobile].[TodoItems]
INSTEAD OF
    UPDATE
AS BEGIN
    DECLARE @id AS NVARCHAR(255)
    SELECT @id = inserted.id FROM inserted
    DECLARE @itemid AS BIGINT
    SELECT @itemid = [item_id] FROM [mobile].[SysProps_TodoItems] WHERE [id] = @id

    IF UPDATE(UserId) BEGIN
        DECLARE @userid AS NVARCHAR(255)
        SELECT @userid = inserted.UserId FROM inserted
        UPDATE [dbo].[TodoItems] SET [UserId] = @userid WHERE [id] = @itemid
    END
    IF UPDATE(Title) BEGIN
        DECLARE @title AS NVARCHAR(255)
        SELECT @title = inserted.Title FROM inserted
        UPDATE [dbo].[TodoItems] SET [Title] = @title WHERE [id] = @itemid
    END
    IF UPDATE(Complete) BEGIN
        DECLARE @complete AS BIT
        SELECT @complete = inserted.Complete FROM inserted
        UPDATE [dbo].[TodoItems] SET [Complete] = @complete WHERE [id] = @itemid
    END
    IF UPDATE(deleted) BEGIN
        DECLARE @deleted AS BIT
        SELECT @deleted = inserted.deleted FROM inserted
        UPDATE [mobile].[SysProps_TodoItems] SET [deleted] = @deleted WHERE [item_id] = @itemid
    END
END
GO

CREATE TRIGGER
    [mobile].[TRG_Mobile_TodoItem_Delete]
ON
    [mobile].[TodoItems]
INSTEAD OF
    DELETE
AS BEGIN
    DECLARE @id AS NVARCHAR(255)
    SELECT @id = deleted.id FROM deleted
    DECLARE @itemid AS BIGINT
    SELECT @itemid = [item_id] FROM [mobile].[SysProps_TodoItems] WHERE [id] = @id

    DELETE FROM [dbo].[TodoItems] WHERE [id] = @itemid
    DELETE FROM [mobile].[SysProps_TodoItems] WHERE [id] = @id
END
GO
</code></pre>
<p>A standard SQL view is read-only.  We made the view read/write by using triggers to trap the
call and replace it with two calls instead.</p>
<div class="admonition warn">
<p class="admonition-title">Warn</p>
<p>This version does not support soft delete.  If you wish to support soft delete, set the
<code>Deleted</code> flag in the `[mobile].[SysProps_TodoItems] table instead of deleting the row.</p>
</div>
<h3 id="changing-the-mobile-schema">Changing the Mobile Schema<a class="headerlink" href="#changing-the-mobile-schema" title="Permanent link">&para;</a></h3>
<p>We stored our mobile representation of the table in a different schema.  Azure Mobile Apps looks for tables (and views) in the <code>[dbo]</code> schema by default.  There are two places you can modify the schema that Entity Framework uses to access the database.  The first is by changing the default schema that Entity Framework uses.  This will affect all the tables that we are exposing via a table controller.  This is done in the <code>Models\MobileDbContext.cs</code> class:</p>
<pre><code class="language-csharp">protected override void OnModelCreating(DbModelBuilder modelBuilder)
{
    modelBuilder.HasDefaultSchema(&quot;mobile&quot;);
    modelBuilder.Conventions.Add(
        new AttributeToColumnAnnotationConvention&lt;TableColumnAttribute, string&gt;(
            &quot;ServiceTableColumn&quot;,
            (property, attributes) =&gt; attributes.Single().ColumnType.ToString()
        )
    );
}
</code></pre>
<p>We can also do this on the model as an annotation.  For example, here is the TodoItem model suitably adjusted:</p>
<pre><code class="language-csharp">using Microsoft.Azure.Mobile.Server;
using Newtonsoft.Json;
using System.ComponentModel.DataAnnotations.Schema;

namespace Backend.DataObjects
{
    [Table(&quot;TodoItems&quot;, Schema=&quot;mobile&quot;)]
    public class TodoItem : EntityData
    {
        public string UserId { get; set; }

        public string Title { get; set; }

        public bool Complete { get; set; }
    }
}
</code></pre>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Entity Framework adds an <code>s</code> onto the end of the model to create the table name.  If you have a model named <code>TodoItem</code>, the table is called <code>TodoItems</code> in the database.  You can use this same annotation to adjust the table name if it is not to your liking.</p>
</div>
<h2 id="best-practices">Best Practices<a class="headerlink" href="#best-practices" title="Permanent link">&para;</a></h2>
<p>Here is a summary of what I consider best practices for table controllers:</p>
<ul>
<li>Use Code First when you are in a green-field database situation.</li>
<li>Use Database First when you have to integrate an existing database.</li>
<li>Only expose the data that you need for the mobile client.</li>
<li>Set up Automatic Code First Migrations as early as possible.</li>
<li>Think about what happens to existing clients when you update the schema.</li>
</ul>
<p>This last point is an important one.  Let's say you have a v1 mobile client of your awesome mobile
application.  This works with v1 mobile backend.  You've set up the schema and ensured that everything
works.  Then you want to release v2 mobile client.  It has a new feature and needs some extra data.
So you update to v2 mobile backend that provides that data.</p>
<p>You need to ensure that the schema changes provided by the v2 mobile backend are optional.  In other
words, the v1 mobile client can continue to work against the v2 mobile backend.  You should test this
case.  Users do not upgrade instantly.  In fact, many users don't upgrade at all.  At every release
of your app, you are going to have to ensure that ALL versions of your mobile client work against
your mobile backend.</p>
<!-- Images -->
<!-- Links -->

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../dataconcepts/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Concepts" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Concepts
            </div>
          </div>
        </a>
      
      
        
        <a href="../projection/" class="md-footer__link md-footer__link--next" aria-label="Next: Data Projection and Queries" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Data Projection and Queries
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2017-2020 Adrian Hall
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/adrianhall" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/FizzyInTheHall" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c2e1ee47.min.js"></script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>