



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter3/client/">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.1">
    
    
      
        <title>The Mobile Client - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.a315b664.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#handling-data-in-mobile-clients" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/" title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
              </span>
              <span class="md-header-nav__topic">
                The Mobile Client
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </span>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Chapter 1 - Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Chapter 1 - Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_pc/" title="Your First App - PC Edition" class="md-nav__link">
      Your First App - PC Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_mac/" title="Your First App - Mac Edition" class="md-nav__link">
      Your First App - Mac Edition
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Chapter 2 - Authentication
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Chapter 2 - Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/backend/" title="Authentication in the Backend" class="md-nav__link">
      Authentication in the Backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/enterprise/" title="Enterprise Authentication" class="md-nav__link">
      Enterprise Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/social/" title="Social Authentication" class="md-nav__link">
      Social Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/debugging/" title="Debugging Authentication" class="md-nav__link">
      Debugging Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/custom/" title="Custom Authentication" class="md-nav__link">
      Custom Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authorization/" title="Claims and Authorization" class="md-nav__link">
      Claims and Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/realworld/" title="Tokens in Real Apps" class="md-nav__link">
      Tokens in Real Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/bestpractices/" title="Best Practices" class="md-nav__link">
      Best Practices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" checked>
    
    <label class="md-nav__link" for="nav-4">
      Chapter 3 - Data Access and Offline Sync
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Chapter 3 - Data Access and Offline Sync
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../dataconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../server/" title="Implementing Table Controllers" class="md-nav__link">
      Implementing Table Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../projection/" title="Data Projection and Queries" class="md-nav__link">
      Data Projection and Queries
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        The Mobile Client
      </label>
    
    <a href="./" title="The Mobile Client" class="md-nav__link md-nav__link--active">
      The Mobile Client
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#an-online-client" title="An Online Client" class="md-nav__link">
    An Online Client
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-support-in-online-clients" title="Query Support in Online Clients" class="md-nav__link">
    Query Support in Online Clients
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#an-offline-client" title="An Offline Client" class="md-nav__link">
    An Offline Client
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-the-local-sqlite-database" title="Configuring the Local SQLite database" class="md-nav__link">
    Configuring the Local SQLite database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-the-sync-tables" title="Updating the Sync tables" class="md-nav__link">
    Updating the Sync tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-steps-on-universal-windows" title="Additional Steps on Universal Windows" class="md-nav__link">
    Additional Steps on Universal Windows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-connection-state" title="Detecting Connection State" class="md-nav__link">
    Detecting Connection State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-conflict-resolution" title="Handling Conflict Resolution" class="md-nav__link">
    Handling Conflict Resolution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-management" title="Query Management" class="md-nav__link">
    Query Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dealing-with-historical-data" title="Dealing with Historical Data" class="md-nav__link">
    Dealing with Historical Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#purging-the-local-cache" title="Purging the Local Cache" class="md-nav__link">
    Purging the Local Cache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deleting-the-backing-store" title="Deleting the backing store" class="md-nav__link">
    Deleting the backing store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#purging-records-from-the-offline-cache" title="Purging Records from the Offline Cache" class="md-nav__link">
    Purging Records from the Offline Cache
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schema-changes-in-the-offline-cache" title="Schema changes in the Offline Cache" class="md-nav__link">
    Schema changes in the Offline Cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-the-offline-cache" title="Debugging the Offline Cache" class="md-nav__link">
    Debugging the Offline Cache
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../domainmgr/" title="The Domain Manager" class="md-nav__link">
      The Domain Manager
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Chapter 4 - Server Side Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Chapter 4 - Server Side Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/options/" title="Options for Server Code" class="md-nav__link">
      Options for Server Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/custom/" title="Custom HTTP Endpoints" class="md-nav__link">
      Custom HTTP Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/webjobs/" title="WebJobs" class="md-nav__link">
      WebJobs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/functions/" title="Functions" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/recipes/" title="Recipes" class="md-nav__link">
      Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Chapter 5 - Push Notifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Chapter 5 - Push Notifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/android/" title="Android Push" class="md-nav__link">
      Android Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/ios/" title="iOS Push" class="md-nav__link">
      iOS Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/windows/" title="Windows Push" class="md-nav__link">
      Windows Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/recipes/" title="Push Recipes" class="md-nav__link">
      Push Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7">
    
    <label class="md-nav__link" for="nav-7">
      Chapter 6 - Combining Web and Mobile Apps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Chapter 6 - Combining Web and Mobile Apps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/mvc/" title="MVC Applications" class="md-nav__link">
      MVC Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/jquery/" title="jQuery Applications" class="md-nav__link">
      jQuery Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/angular/" title="Angular Applications" class="md-nav__link">
      Angular Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter6/react/" title="React Applications" class="md-nav__link">
      React Applications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Chapter 7 - Other Useful Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Chapter 7 - Other Useful Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/services/" title="Useful Azure Services" class="md-nav__link">
      Useful Azure Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/search/" title="Azure Search" class="md-nav__link">
      Azure Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/media/" title="Media Services" class="md-nav__link">
      Media Services
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Chapter 8 - Developing An App
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Chapter 8 - Developing An App
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/developing/" title="The Development Environment" class="md-nav__link">
      The Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/testing/" title="Testing your Application" class="md-nav__link">
      Testing your Application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Chapter 9 - Going to Production
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Chapter 9 - Going to Production
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/arm/" title="Repeatable Deployments" class="md-nav__link">
      Repeatable Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/appsvc/" title="Safe Deployments" class="md-nav__link">
      Safe Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/monitoring/" title="Monitoring and Troubleshooting" class="md-nav__link">
      Monitoring and Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../xamarin_tips/" title="Xamarin Forms Tips" class="md-nav__link">
      Xamarin Forms Tips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../android_appendix/" title="Android Developer Notes" class="md-nav__link">
      Android Developer Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vs_extensions/" title="Visual Studio Extensions" class="md-nav__link">
      Visual Studio Extensions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" title="References" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" title="Credits" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#an-online-client" title="An Online Client" class="md-nav__link">
    An Online Client
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#query-support-in-online-clients" title="Query Support in Online Clients" class="md-nav__link">
    Query Support in Online Clients
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#an-offline-client" title="An Offline Client" class="md-nav__link">
    An Offline Client
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configuring-the-local-sqlite-database" title="Configuring the Local SQLite database" class="md-nav__link">
    Configuring the Local SQLite database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#updating-the-sync-tables" title="Updating the Sync tables" class="md-nav__link">
    Updating the Sync tables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#additional-steps-on-universal-windows" title="Additional Steps on Universal Windows" class="md-nav__link">
    Additional Steps on Universal Windows
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#detecting-connection-state" title="Detecting Connection State" class="md-nav__link">
    Detecting Connection State
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-conflict-resolution" title="Handling Conflict Resolution" class="md-nav__link">
    Handling Conflict Resolution
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#query-management" title="Query Management" class="md-nav__link">
    Query Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dealing-with-historical-data" title="Dealing with Historical Data" class="md-nav__link">
    Dealing with Historical Data
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#purging-the-local-cache" title="Purging the Local Cache" class="md-nav__link">
    Purging the Local Cache
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deleting-the-backing-store" title="Deleting the backing store" class="md-nav__link">
    Deleting the backing store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#purging-records-from-the-offline-cache" title="Purging Records from the Offline Cache" class="md-nav__link">
    Purging Records from the Offline Cache
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#schema-changes-in-the-offline-cache" title="Schema changes in the Offline Cache" class="md-nav__link">
    Schema changes in the Offline Cache
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#debugging-the-offline-cache" title="Debugging the Offline Cache" class="md-nav__link">
    Debugging the Offline Cache
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter3/client.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="handling-data-in-mobile-clients">Handling Data in Mobile Clients<a class="headerlink" href="#handling-data-in-mobile-clients" title="Permanent link">&para;</a></h1>
<p>Pretty much any non-trivial mobile client will require access to data.  Although we have already brushed on handling data within the client, this section will go deeper into the data handling aspects on the client.  We will cover how to get and process data, how to deal with performance and reliability and some of the quirks that one must deal with when dealing with offline data.</p>
<h2 id="an-online-client">An Online Client<a class="headerlink" href="#an-online-client" title="Permanent link">&para;</a></h2>
<p>We've already seen an example of an online client in our online <code>TaskList</code> project.  There is a method for obtaining a reference to an online table:</p>
<pre><code class="csharp">var table = client.GetTable&lt;Model&gt;();
</code></pre>

<p>This method relies on the fact that the table name is the same as the model.  One must have a consistent naming scheme - the model on the server, table controller on the server, model on the client and table on the client must all be based on the same root name.  This is definitely a best practice.  You can produce an un-typed table:</p>
<pre><code class="csharp">var table = client.GetTable(&quot;todoitem&quot;);
</code></pre>

<p>This version of the method returns an untyped table.  Whereas a typed table is based on a concrete model, an untyped table is based on a JSON object.  This allows one to access data when the model is unknown or hard to represent in a model.  You should never use an untyped table unless there is no other way of achieving whatever operation you need.</p>
<p>All tables implement the <code>IMobileServiceTable</code> interface:</p>
<ul>
<li><strong>ReadAsync()</strong> performs reads against the table.</li>
<li><strong>LookupAsync()</strong> reads a single record in the table, identified by its id.</li>
<li><strong>InsertAsync()</strong> inserts a new record into the table.</li>
<li><strong>UpdateAsync()</strong> updates an existing record in the table.</li>
<li><strong>DeleteAsync()</strong> deletes a record in the table.</li>
<li><strong>UndeleteAsync()</strong> un-deletes a deleted record (if soft-delete is turned on).</li>
</ul>
<p>When developing my interface, I tend to wrap my table interface into another class.  This isn't because I like wrapping classes.  Rather it is because the return values from many of the methods are not compatible with the general patterns used when working with a UI.  For instance, the ReadAsync() method returns an <code>IEnumerable&lt;&gt;</code> type.  However, the standard list management in Xamarin and UWP applications use an <code>ObservableCollection&lt;&gt;</code> instead.  One has to do a conversion from one to the other.</p>
<p>Let's look at a standard table wrapper:</p>
<pre><code class="csharp">using System.Collections.Generic;
using System.Threading.Tasks;
using Microsoft.WindowsAzure.MobileServices;
using TaskList.Abstractions;

namespace TaskList.Services
{
    public class AzureCloudTable&lt;T&gt; : ICloudTable&lt;T&gt; where T : TableData
    {
        IMobileServiceTable&lt;T&gt; table;

        public AzureCloudTable(MobileServiceClient client)
        {
            this.table = client.GetTable&lt;T&gt;();
        }

        #region ICloudTable interface
        public async Task&lt;T&gt; CreateItemAsync(T item)
        {
            await table.InsertAsync(item);
            return item;
        }

        public async Task&lt;T&gt; UpsertItemAsync(T item)
        {
            return (item.Id == null) ?
                await CreateItemAsync(item) :
                await UpdateItemAsync(item);
        }

        public async Task DeleteItemAsync(T item)
            =&gt; await table.DeleteAsync(item);

        public async Task&lt;ICollection&lt;T&gt;&gt; ReadAllItemsAsync()
            =&gt; await table.ToListAsync();

        public async Task&lt;T&gt; ReadItemAsync(string id)
            =&gt; await table.LookupAsync(id);

        public async Task&lt;T&gt; UpdateItemAsync(T item)
        {
            await table.UpdateAsync(item);
            return item;
        }
        #endregion
    }
}
</code></pre>

<p>This is the <code>AzureCloudTable</code> class that our task list has been using thus far.  It's actually got a few bugs in it.  Let's go over them.</p>
<p>Probably the most egregious bug is that the <code>ReadAllItemsAsync()</code> method does not handle paging.  If you have more than 50 items, then the <code>ToListAsync()</code> method will do a single GET operation and then return the results.  The Azure Mobile Apps Server SDK implements enforced paging.  This protects two things.  Firstly, the client cannot tie up the UI thread and cause a significant delay in the responsiveness of the app.  More importantly, a rogue client cannot tie up the server for a long period thus helping with dealing with denial of service attacks.  Paging is a good thing.</p>
<p>To test this:</p>
<ul>
<li>Insert over 50 records into the <code>TodoItems</code> table in your database using a SQL client.</li>
<li>Put a break point at the <code>Items.ReplaceRange(list);</code> (line 78 approximately) in <code>ViewModels\TaskListViewModel.cs</code>.</li>
<li>Run the UWP project.</li>
</ul>
<p><img alt="" src="../img/not-paging.PNG" /></p>
<p>Note that even though there are more than 50 records, you will only see 50 records in the list.  There are multiple ways to fix this and it depends on your final expectation.  In the class of "probably not what we want", we can keep on reading records until there are no more records to read. This is the simplest to implement.  In the <code>Services\AzureCloudTable.cs</code> file, replace the <code>ReadAllItemsAsync()</code> method with the following:</p>
<pre><code class="csharp">public async Task&lt;ICollection&lt;T&gt;&gt; ReadAllItemsAsync()
{
    List&lt;T&gt; allItems = new List&lt;T&gt;();

    var pageSize = 50;
    var hasMore = true;
    while (hasMore)
    {
        var pageOfItems = await table.Skip(allItems.Count).Take(pageSize).ToListAsync();
        if (pageOfItems.Count &gt; 0)
        {
            allItems.AddRange(pageOfItems);
        }
        else
        {
            hasMore = false;
        }
    }
    return allItems;
}
</code></pre>

<p>This code will always make a minimum of 2 requests if there is any data.  If you have 75 records, three requests will be made - the first will bring down 50 records, the second 25 records and the third no reocrds.  Why not stop at the second request?  We expect this code to run on a live system.  The OData subsystem is allowed to return less than the requested value and it will do so for a variety of reasons.  For example, it may be configured with a maximum transfer size and the records won't fit into the transfer buffer.  The only way of knowing for sure that you have received all the records is to do a request and be told there is no more.</p>
<p>This code could be simplified quite a bit.  The reason I am not doing so is that this is not how you would want to do the transfer of items in a real application.  Doing this will tie up the UI thread of your application for quite a while as the <code>AzureCloudTable</code> downloads all the data.  Consider if there were thousands of entries?  This method would be problematic very quickly.</p>
<p>The alternative is to incrementally load the data as it is needed.  This means that your UI thread will pause as the data is loaded, but the resulting UI will be less memory hungry and overall more responsive.  We start by adjusting our <code>Abstractions\ICloudTable.cs</code> to add a method signature for returning paged data:</p>
<pre><code class="csharp">public interface ICloudTable&lt;T&gt; where T : TableData
{
    Task&lt;T&gt; CreateItemAsync(T item);
    Task&lt;T&gt; ReadItemAsync(string id);
    Task&lt;T&gt; UpdateItemAsync(T item);
    Task&lt;T&gt; UpsertItemAsync(T item);
    Task DeleteItemAsync(T item);
    Task&lt;ICollection&lt;T&gt;&gt; ReadAllItemsAsync();
    Task&lt;ICollection&lt;T&gt;&gt; ReadItemsAsync(int start, int count);
}
</code></pre>

<p>The <code>ReadItemsAsync()</code> method is our new method here.  The concrete implementation usese <code>.Skip()</code> and <code>.Take()</code> to return just the data that is required:</p>
<pre><code class="csharp">public async Task&lt;ICollection&lt;T&gt;&gt; ReadItemsAsync(int start, int count)
{
    return await table.Skip(start).Take(count).ToListAsync();
}
</code></pre>

<p>Now that we have a method for paging through the contents of our table, we need to be able to wire that up to our <code>ListView</code>.  Xamarin Forms has a concept called <a href="https://developer.xamarin.com/guides/xamarin-forms/behaviors/introduction/">Behaviors</a> that lets us add functionality to user interface controls without having to completely re-write them or sub-class them.  We can use a behavior to implement a reusable paging control for a ListView.  Xamarin provides a sample for this called <a href="https://developer.xamarin.com/samples/xamarin-forms/behaviors/eventtocommandbehavior/">EventToCommandBehavior</a> (along with an <a href="https://developer.xamarin.com/guides/xamarin-forms/behaviors/reusable/event-to-command-behavior/">explanation</a>). We are going to be using the <a href="https://developer.xamarin.com/api/event/Xamarin.Forms.ListView.ItemAppearing/">ItemAppearing</a> event and that event uses the <a href="https://developer.xamarin.com/api/type/Xamarin.Forms.ItemVisibilityEventArgs/">ItemVisibilityEventArgs</a> as a parameter.  We need a converter for the EventToCommandBehavior class (in <code>Converters\ItemVisibilityConverter.cs</code>):</p>
<pre><code class="csharp">using System;
using System.Globalization;
using Xamarin.Forms;

namespace TaskList.Converters
{
    public class ItemVisibilityConverter : IValueConverter
    {
        public object Convert(object value, Type targetType, object parameter, CultureInfo culture)
        {
            var eventArgs = value as ItemVisibilityEventArgs;
            return eventArgs.Item;
        }

        public object ConvertBack(object value, Type targetType, object parameter, CultureInfo culture)
        {
            throw new NotImplementedException();
        }
    }
}
</code></pre>

<p>This is wired up with some XAML code in <code>Pages\TaskList.xaml.cs</code>.  There are two pieces.  Firstly, we must define the ItemVisibilityConverter that we just wrote.  This is done at the top of the file:</p>
<pre><code class="xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;ContentPage x:Class=&quot;TaskList.Pages.TaskList&quot;
             xmlns=&quot;http://xamarin.com/schemas/2014/forms&quot;
             xmlns:x=&quot;http://schemas.microsoft.com/winfx/2009/xaml&quot;
             xmlns:behaviors=&quot;clr-namespace:TaskList.Behaviors;assembly=TaskList&quot;
             xmlns:converters=&quot;clr-namespace:TaskList.Converters;assembly=TaskList&quot;
             Title=&quot;{Binding Title}&quot;&gt;

    &lt;ContentPage.Resources&gt;
        &lt;ResourceDictionary&gt;
            &lt;converters:ItemVisibilityConverter x:Key=&quot;ItemVisibilityConverter&quot; /&gt;
        &lt;/ResourceDictionary&gt;
    &lt;/ContentPage.Resources&gt;
</code></pre>

<p>Next, we must define the behavior for the ListView:</p>
<pre><code class="xml">&lt;ListView CachingStrategy=&quot;RecycleElement&quot;
            IsPullToRefreshEnabled=&quot;True&quot;
            IsRefreshing=&quot;{Binding IsBusy,
                                    Mode=OneWay}&quot;
            ItemsSource=&quot;{Binding Items}&quot;
            RefreshCommand=&quot;{Binding RefreshCommand}&quot;
            RowHeight=&quot;50&quot;
            SelectedItem=&quot;{Binding SelectedItem,
                                    Mode=TwoWay}&quot;&gt;
    &lt;ListView.Behaviors&gt;
        &lt;behaviors:EventToCommandBehavior Command=&quot;{Binding LoadMoreCommand}&quot;
                                                Converter=&quot;{StaticResource ItemVisibilityConverter}&quot;
                                                EventName=&quot;ItemAppearing&quot; /&gt;
    &lt;/ListView.Behaviors&gt;
</code></pre>

<p>Finally, we need to add a new command to our <code>TaskListViewModel</code> to load more items.  This involves firstly defining the new command:</p>
<pre><code class="csharp">public TaskListViewModel()
{
    CloudTable = CloudService.GetTable&lt;TodoItem&gt;();

    Title = &quot;Task List&quot;;

    RefreshCommand = new Command(async () =&gt; await Refresh());
    AddNewItemCommand = new Command(async () =&gt; await AddNewItem());
    LogoutCommand = new Command(async () =&gt; await Logout());
    LoadMoreCommand = new Command&lt;TodoItem&gt; (async (TodoItem item) =&gt; await LoadMore(item));

    // Subscribe to events from the Task Detail Page
    MessagingCenter.Subscribe&lt;TaskDetailViewModel&gt;(this, &quot;ItemsChanged&quot;, async (sender) =&gt;
    {
        await Refresh();
    });

    // Execute the refresh command
    RefreshCommand.Execute(null);
}

public ICommand LoadMoreCommand { get; }
</code></pre>

<p>We also need to define the actual command code:</p>
<pre><code class="csharp">bool hasMoreItems = true;

async Task LoadMore(TodoItem item)
{
    if (IsBusy)
    {
        Debug.WriteLine($&quot;LoadMore: bailing because IsBusy = true&quot;);
        return;
    }

    // If we are not displaying the last one in the list, then return.
    if (!Items.Last().Id.Equals(item.Id))
    {
        Debug.WriteLine($&quot;LoadMore: bailing because this id is not the last id in the list&quot;);
        return;
    }

    // If we don't have more items, return
    if (!hasMoreItems)
    {
        Debug.WriteLine($&quot;LoadMore: bailing because we don't have any more items&quot;);
        return;
    }

    IsBusy = true;
    try
    {
        var list = await CloudTable.ReadItemsAsync(Items.Count, 20);
        if (list.Count &gt; 0)
        {
            Debug.WriteLine($&quot;LoadMore: got {list.Count} more items&quot;);
            Items.AddRange(list);
        }
        else
        {
            Debug.WriteLine($&quot;LoadMore: no more items: setting hasMoreItems= false&quot;);
            hasMoreItems = false;
        }
    }
    catch (Exception ex)
    {
        await Application.Current.MainPage.DisplayAlert(&quot;LoadMore Failed&quot;, ex.Message, &quot;OK&quot;);
    }
    finally
    {
        IsBusy = false;
    }
}
</code></pre>

<p>I've added a whole bunch of debug output because this command is called a lot, so I can scroll back through the output window instead of setting a breakpoint and clicking Continue a lot.</p>
<p>As the UI displays each cell, it calls our command.  The command figures out if the record being displayed is the last one in the list.  If it is, it asks for more records.  Once no more records are available, it sets the flag <code>hasMoreItems</code> to false so it can short-circuit the network request.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Be careful when using <code>OrderBy()</code> with online data.  Earlier pages may change, causing duplicated data or missed data in your result set.  There is little you can do about this other than pulling down all the data ordered by the <code>CreatedAt</code> field (which is the default).</p>
</div>
<p>Finally, our current implementation of the <code>Refresh()</code> method loads all the items.  We need to adjust it to only load the first page:</p>
<pre><code class="csharp">async Task Refresh()
{
    if (IsBusy)
        return;
    IsBusy = true;

    try
    {
        var identity = await CloudService.GetIdentityAsync();
        if (identity != null)
        {
            var name = identity.UserClaims.FirstOrDefault(c =&gt; c.Type.Equals(&quot;name&quot;)).Value;
            Title = $&quot;Tasks for {name}&quot;;
        }
        var list = await CloudTable.ReadItemsAsync(0, 20);
        Items.ReplaceRange(list);
        hasMoreItems = true;
    }
    catch (Exception ex)
    {
        await Application.Current.MainPage.DisplayAlert(&quot;Items Not Loaded&quot;, ex.Message, &quot;OK&quot;);
    }
    finally
    {
        IsBusy = false;
    }
}
</code></pre>

<p>We've done two things here.</p>
<ul>
<li>We have altered the first request so that only the first 20 records are retrieved.</li>
<li>We have set <code>hasMoreItems</code> to true so that the <code>LoadMore()</code> command will do network requests again.</li>
</ul>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The Azure Mobile Apps SDK also has a collection class that can be used: <code>MobileServiceCollection&lt;T,T&gt;</code>.  This handles the paging for you and implements the <code>ICollectionChanged</code> event.  For simple cases where you don't want to do on-demand loading, you can use the <code>MobileServiceCollection&lt;T,T&gt;</code> collection class.</p>
</div>
<h3 id="query-support-in-online-clients">Query Support in Online Clients<a class="headerlink" href="#query-support-in-online-clients" title="Permanent link">&para;</a></h3>
<p>When using an online client, you can also use an OData query to look for records.  The following code snippet, for example, will only return records that are incomplete:</p>
<pre><code class="csharp">return await table
    .Where(item =&gt; item.Complete == false)
    .ToListAsync()
</code></pre>

<p>This is a standard LINQ query.  Just as the LINQ query was used to adjust the SQL that is generated in the server-side code, the LINQ query here is used to adjust the OData query that is generated to call the server.  This particular query will generate the follow HTTP call:</p>
<pre><code>GET /tables/todoitem?$filter=(complete+eq+false) HTTP/1.1
</code></pre>

<p>LINQ queries are very useful in dealing with online data.  In general they should be formatted in a particular order so that the best possible format across the Internet to your backend.</p>
<pre><code class="csharp">table                           // start with the table reference
    .Where(filter)              // filter the results
    .Select(filter)             // Only return certain fields
    .Skip(start).Take(count)    // paging support
    .ToListAsync()              // convert to something we can use
</code></pre>

<p>This format allows you to be very specific about what you want to return from the server, thus allowing you to balance the optimization of bandwidth with the responsiveness of the UI.</p>
<h2 id="an-offline-client">An Offline Client<a class="headerlink" href="#an-offline-client" title="Permanent link">&para;</a></h2>
<p>Another method of optimizing bandwidth utilization with an added benefit of providing a resilient data connection is to use an offline sync database.   The Azure Mobile Apps Client SDK has a built-in offline mode that allows for the common requirements of bandwidth optimization, connection resliency, and performance optimization.</p>
<ul>
<li>An offline capable table uses <em>Incremental Sync</em> to only bring down new records from the server.</li>
<li>Connection detection allows you to defer requests until after a connection is available.</li>
<li>In-built <em>Conflict Resolution</em> provides a robust mechanism for handling changes while your client was offline.</li>
<li>Since the data is always local, the UI will be much more responsive to changes.</li>
</ul>
<p>All of this comes at a cost.  We need to maintain an offline sync database for the tables you wish to provide offline, which takes up memory.  It may result in large data transfers (especially in the cases of the first sync operation and rapidly changing tables).  Finally, there is more complexity.  We have to deal with the offline table maintenance and conflict resolution patterns.</p>
<div class="admonition important">
<p class="admonition-title">Azure Mobile Apps v3.0</p>
<p>Azure Mobile Apps introduced a breaking change in how SQLite was used in v3.0 of the Client SDK.  The breaking change ensured support for Android Nougat.  This book covers the v3.1 release of Azure Mobile Apps.  In general, always start a project using the latest generally available release of the SDK from NuGet.</p>
</div>
<p>There are three stages to using an offline client:</p>
<ol>
<li>Initialize the local SQLite database before use.</li>
<li>Set up push / pull logic to maintain the contents of the SQLite database.</li>
<li>Configure appropriate conflict resolution.</li>
</ol>
<p>The actual code for your mobile client that deals with tables remains identical to the online case.</p>
<p>To effect the offline sync, the Azure Mobile Apps client SDK keeps a table in the local SQLite database called the <em>Operations Queue</em>.  An entry is placed in the operations queue whenever a modification is done to a sync table.  These modifications are collapsed.  Later modifications to the same record in a sync table will be collapsed into a single update when transmitted to the mobile backend.</p>
<h3 id="configuring-the-local-sqlite-database">Configuring the Local SQLite database<a class="headerlink" href="#configuring-the-local-sqlite-database" title="Permanent link">&para;</a></h3>
<p>We must initialize the local database before we can use it.  This happens on start up and the Azure Mobile Apps SDK knows enough of the models to understand the basics of maintaining the database.  Initializing the database is deceptively simple.  Install the <code>Microsoft.Azure.Mobile.Client.SQLiteStore</code> package to all the client projects.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>Microsoft.Azure.Mobile.Client</code> package v3.0.2 drastically improved the startup experience for offline sync. Make sure you are using it.  If you are using an earlier version, additional steps are required for initializing your offline cache.</p>
</div>
<p>In the <code>Services\AzureCloudService.cs</code> file, add the following method:</p>
<pre><code class="csharp">    #region Offline Sync Initialization
    async Task InitializeAsync()
    {
        // Short circuit - local database is already initialized
        if (Client.SyncContext.IsInitialized)
            return;

        // Create a reference to the local sqlite store
        var store = new MobileServiceSQLiteStore(&quot;offlinecache.db&quot;);

        // Define the database schema
        store.DefineTable&lt;TodoItem&gt;();

        // Actually create the store and update the schema
        await Client.SyncContext.InitializeAsync(store);
    }
    #endregion
</code></pre>

<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>Microsoft.Azure.Mobile.Client</code> package does not support Android API versions earlier than API 19.  To set this, right-click on the <strong>TaskList.Droid</strong> project and ensure the <strong>Minimum Android version to target</strong> is set to a minimum of API level 19.</p>
</div>
<p>We need to ensure the initialization is carried out before we use the local database. The best place to do this is
in the <code>GetTable&lt;&gt;</code> method:</p>
<pre><code class="csharp">    /// &lt;summary&gt;
    /// Returns a link to the specific table.
    /// &lt;/summary&gt;
    /// &lt;typeparam name=&quot;T&quot;&gt;The model&lt;/typeparam&gt;
    /// &lt;returns&gt;The table reference&lt;/returns&gt;
    public async Task&lt;ICloudTable&lt;T&gt;&gt; GetTableAsync&lt;T&gt;() where T : TableData
    {
        await InitializeAsync();
        return new AzureCloudTable&lt;T&gt;(Client);
    }
</code></pre>

<p>Note that we made the routine async during this process.  Adjust the <code>ICloudService</code> interface and the calls to <code>GetTable&lt;&gt;</code> in the rest of the code to compensate for this.</p>
<h3 id="updating-the-sync-tables">Updating the Sync tables<a class="headerlink" href="#updating-the-sync-tables" title="Permanent link">&para;</a></h3>
<p>We also need to add some routines to our <code>ICloudTable&lt;&gt;</code> and <code>AzureCloudTable&lt;&gt;</code> classes to effect a synchronization. The first method is added to the  <code>ICloudTable&lt;&gt;</code> interface and pulls data from the mobile backend:</p>
<pre><code class="csharp">    public interface ICloudTable&lt;T&gt; where T : TableData
    {
        Task&lt;T&gt; CreateItemAsync(T item);
        Task&lt;T&gt; ReadItemAsync(string id);
        Task&lt;T&gt; UpdateItemAsync(T item);
        Task&lt;T&gt; UpsertItemAsync(T item);
        Task DeleteItemAsync(T item);
        Task&lt;ICollection&lt;T&gt;&gt; ReadAllItemsAsync();
        Task&lt;ICollection&lt;T&gt;&gt; ReadItemsAsync(int start, int count);
        Task PullAsync();
    }
</code></pre>

<p>The new method is <code>PullAsync()</code> which will do the "pull data from the server" operation.  The <code>AzureCloudTable&lt;&gt;</code> class has the concrete implementation:</p>
<pre><code class="csharp">        IMobileServiceSyncTable&lt;T&gt; table;

        public AzureCloudTable(MobileServiceClient client)
        {
            table = client.GetSyncTable&lt;T&gt;();
        }

        public async Task PullAsync()
        {
            string queryName = $&quot;incsync_{typeof(T).Name}&quot;;
            await table.PullAsync(queryName, table.CreateQuery());
        }
</code></pre>

<p>Note that we have changed the call to get the table reference.  It's now a <code>SyncTable</code>.  You can test to see if the sync table has been defined with the following:</p>
<pre><code class="csharp">if (client.IsSyncTable(typeof(T).Name)) {
    // There is a sync table defined
}
</code></pre>

<p>This can be used to have a single <code>AzureCloudTable</code> implementation for both the online and offline capabilities.  The concrete implementation of the <code>PullAsync()</code> method implements incremental sync.  If we set the queryName to <code>null</code>, then the entire table is pulled across each time.  By setting a queryName, the last updated time for the table is stored and associated with the queryName.  The last updated time is used to request only records that have changed since the last updated time when doing the pull from the backend.</p>
<p>The push of the operations queue up to the mobile backend is handled by a single call in the <code>AzureCloudService</code> class:</p>
<pre><code class="csharp">    public async Task SyncOfflineCacheAsync()
    {
        await InitializeAsync();

        // Push the Operations Queue to the mobile backend
        await Client.SyncContext.PushAsync();

        // Pull each sync table
        var taskTable = await GetTableAsync&lt;TodoItem&gt;(); await taskTable.PullAsync();
    }
</code></pre>

<p>note that if the mobile client tries to pull data while there are pending operations in the operations queue, the Azure Mobile Apps client SDK will perform an implicit push.  You can check the state of the operations queue with:</p>
<pre><code class="csharp">if (Client.SyncContext.PendingOperations &gt; 0) {
    // There are pending operations
}
</code></pre>

<p>The only thing left to do now is to decide when to synchronize the local database on the mobile device.  In this example, I am going to synchronize the database during the refresh command of the <code>TaskListViewModel</code> and on saving or deleting an item in the <code>TaskDetailViewModel</code>.  Each synchronization will be called with the following:</p>
<pre><code class="csharp">await CloudService.SyncOfflineCacheAsync();
</code></pre>

<div class="admonition info">
<p class="admonition-title">Info</p>
<p>The offline sync cache automatically handles paging of results during the transfer for you so you never have to worry about it.</p>
</div>
<h3 id="additional-steps-on-universal-windows">Additional Steps on Universal Windows<a class="headerlink" href="#additional-steps-on-universal-windows" title="Permanent link">&para;</a></h3>
<p>If you are compiling the Universal Windows (UWP) project, there is an extra step.  You must Add a reference for SQLite to the project:</p>
<ul>
<li>Open the <strong>TaskList.UWP</strong> project.</li>
<li>Right-click on the <strong>References</strong> node, then select <strong>Add Reference</strong>. </li>
<li>Select <strong>Universal Windows</strong> -&gt; <strong>Extensions</strong>. </li>
<li>Place a check mark next to the <strong>SQLite for Universal Windows</strong> and <strong>Visual C++ 2015 Runtime for Universal Windows</strong> components.</li>
</ul>
<p><img alt="" src="../img/add-uwp-reference.PNG" /></p>
<p>If you don't do this, you will get the rather cryptic error message "Unable to set temporary directory" when running the
application.</p>
<h3 id="detecting-connection-state">Detecting Connection State<a class="headerlink" href="#detecting-connection-state" title="Permanent link">&para;</a></h3>
<p>Xamarin has a rather cool plugin called the Connectivity Plugin for testing connectivity state.  We can install it by installing the <code>Xam.Plugin.Connectivity</code> NuGet package.  Once that is installed, we can update our <code>SyncOfflineCacheAsync()</code> method to use it:</p>
<pre><code class="csharp">    public async Task SyncOfflineCacheAsync()
    {
        await InitializeAsync();

        if (!(await CrossConnectivity.Current.IsRemoteReachable(Client.MobileAppUri.Host, 443)))
        {
            Debug.WriteLine($&quot;Cannot connect to {Client.MobileAppUri} right now - offline&quot;);
            return;
        }

        // Push the Operations Queue to the mobile backend
        await Client.SyncContext.PushAsync();

        // Pull each sync table
        var taskTable = await GetTableAsync&lt;TodoItem&gt;(); await taskTable.PullAsync();
    }
</code></pre>

<p>The Connectivity Plugin (which is accessible through <code>CrossConnectivity.Current</code>) has other parameters that allow the mobile client to test for specific types of connectivity.  For example, let's say you only wanted to pull one of the tables over wifi.  You could do this as follows:</p>
<pre><code class="csharp">var connections = CrossConnectivity.Current.ConnectionTypes;
if (connections.Contains(ConnectionType.Wifi)) {
    var largeTable = await GetTableAsync&lt;LargeModel&gt;();
    largeTable.PullAsync();
}
</code></pre>

<p>The Connectivity plugin when paired with the Azure Mobile Apps Client SDK gives you a lot of flexibility in deciding what to sync and over what type of connection you should sync.</p>
<h3 id="handling-conflict-resolution">Handling Conflict Resolution<a class="headerlink" href="#handling-conflict-resolution" title="Permanent link">&para;</a></h3>
<p>When the mobile client submits a modification to the mobile backend, it's generally done as a two-step process:</p>
<ol>
<li>A "pre-condition check" is done, comparing the Version to the ETag of the record (which is derived from the Version of the record).</li>
<li>The actual request is done, where the Version of the mobile client is compared to the Version of the record on the mobile backend.</li>
</ol>
<p>If the version of the record being submitted is different from the version on the server, the test will fail.  In the case of the first check, a <em>412 Precondition Failed</em> will be returned for the modification.  If the second test fails, a <em>409 Conflict</em> response is returned.  Normally, you will see the <em>412 Precondition Failed</em> response, but you should be prepared for either response.</p>
<p>Both responses indicate a conflict that needs to be resolved before continuing.  Programatically, when doing a modification in an online table (such as an Insert, Update, Delete), you should be capture the <code>MobileServicePreconditionFailedException&lt;&gt;</code> Exception to handle the conflict.  In an offline sync table, you should capture the <code>MobileServicePushFailedException</code> during the <code>PushAsync()</code> operation.  This will potentially have an array of conflicts for you to deal with.</p>
<p>For the online case, the code would look like this:</p>
<pre><code class="csharp">try
{
    await CloudService.InsertAsync(item);
}
catch (MobileServicePreconditionFailedException&lt;TodoItem&gt; ex)
{
    await ResolveConflictAsync(item, ex.Item);
}
</code></pre>

<p>For the offline case, the code would look like this:</p>
<pre><code class="csharp">try
{
    await CloudService.PushAsync();
}
catch (MobileServicePushFailedException ex)
{
    if (ex.PushResult != null)
    {
        foreach (var error in ex.PushResult.Errors)
        {
            await ResolveConflictAsync(error);
        }
    }
}
</code></pre>

<p>In both cases, the <code>ResolveConflictAsync()</code> method is called for each conflict in turn.  Resolving the conflict involves
deciding between the two options or making corrections to the item.</p>
<ol>
<li>If you wish to keep the client copy, set the client Version property to the server Version value and re-submit.</li>
<li>If you wish to keep the server copy, discard the update.</li>
<li>If you wish to do something else, create a new copy of the record, set the Version to be the same as the server Version, then re-submit.</li>
</ol>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If the model on your mobile client does not have a Version field, the policy is "last write wins".</p>
</div>
<p>The online case is relatively simple as you are going to be ignoring the old request and creating a new request.  Here is some template code that implements both client-wins and server-wins strategies for the offline case:</p>
<pre><code class="csharp">sync Task ResolveConflictAsync(MobileServiceTableOperationError error)
{
    var serverItem = error.Result.ToObject&lt;T&gt;();
    var localItem = error.Item.ToObject&lt;T&gt;();

    // Note that you need to implement the public override Equals(TodoItem item)
    // method in the Model for this to work
    if (serverItem.Equals(localItem))
    {
        // Items are the same, so ignore the conflict
        await error.CancelAndDiscardItemAsync();
        return;
    }

    // Client Always Wins
    localItem.Version = serverItem.Version;
    await error.UpdateOperationAsync(JObject.FromObject(localItem));

    // Server Always Wins
    // await error.CancelAndDiscardItemAsync();
}
</code></pre>

<p>You could also ask the user as an option.  Finally, you could do some processing.  For example, let's say that you wanted to keep the local version of the Text, but keep the server version of Complete:</p>
<pre><code>localItem.Complete = serverItem.Complete;
localItem.Version = serverItem.Version;
await error.UpdateOperationAsync(JObject.FromObject(serverItem));
</code></pre>

<p>There are many ways to resolve a conflict.  You should consider your requirements carefully.  Asking the user should always be the last resort for conflict resolution.  In the majority of applications, most users will click the "keep my version" button to resolve conflicts, so the UI for resolving conflicts should do more than just ask the user to decide between a server and a client version.</p>
<h2 id="query-management">Query Management<a class="headerlink" href="#query-management" title="Permanent link">&para;</a></h2>
<p>Record selection is based on two factors:</p>
<ol>
<li>Security policy is enforced at the server.</li>
<li>User preference is enabled at the client.</li>
</ol>
<p>We've already discussed security policy in depth in <a href="../projection/">the last section</a>.  We've also discussed
user queries for online usage.  We just use LINQ to affect a change in the query sent to the server.  However,
what about offline cases? There are situations where you want to keep a smaller subset of the data that you are
allowed to see for offline usage.  A common request, for example, is to have the last X days of records available
offline.</p>
<p>In our <code>PullAsync()</code> call for the table, we use <code>table.CreateQuery()</code> to create a query that is designed to get
all the records available to the user from the server.  This is not always appropriate and can be adjusted.  Let's
adjust it to only obtain the records for our TodoItem table where either of the following conditions apply:</p>
<ol>
<li>The record has been updated within the last day.</li>
<li>The task is incomplete.</li>
</ol>
<p>Once the task is marked completed, it will remain in the cache for 1 day, then be removed automatically.  You can
still obtain the task while online.  The <code>table.CreateQuery()</code> method produces an <code>IMobileServiceTableQuery&lt;&gt;</code>
object.  This can be dealt with via LINQ:</p>
<pre><code class="csharp">var queryName = $&quot;incsync:r:{typeof(T).Name}&quot;;
var query = table.CreateQuery()
    .Where(r =&gt; !r.Complete || r.UpdatedAt &lt; DateTimeOffset.Now.AddDays(-1));
await table.PullAsync(queryName, query);
</code></pre>

<p>Note that I am using a different query name in this case.  The maximum value of UpdatedAt for the records is stored
and associated with the query name.  If the same query name is used, then only the records updated since the stored
date will be retrieved.  If you change the query, then change the query name.</p>
<p>Another common request is to restrict the properties that are in the local cache.  For instance, maybe you have
a particularly large text blob that you want to make available online, but not offline:</p>
<pre><code class="csharp">var queryName = $&quot;incsync:s:{typeof(T).Name}&quot;;
var query = table.CreateQuery()
    .Select(r =&gt; new { r.Text, r.Complete, r.UpdatedAt, r.Version });
await table.PullAsync(queryName, query);
</code></pre>

<p>You can also use the Fluent syntax:</p>
<pre><code class="csharp">var query =
    from r in table.CreateQuery()
    select new { r.Text, r.Complete, r.UpdatedAt, r.Version };
</code></pre>

<p>You should always construct the object including the <code>UpdatedAt</code> and <code>Version</code> properties.  <code>UpdatedAt</code> is used
for incremental sync and <code>Version</code> is used for conflict resolution.</p>
<p>Both of these cases use standard LINQ syntax to adjust the query being sent to the mobile backend in exactly the
same way that we adjusted the query when we were doing online searches.  An offline "pull" is exactly the same
as an online "query".</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>There are times when you want to download two different queries.  Avoid this if at all possible as it will
cause additional requests to the backend that are un-necessary.  Construct your query such that all records
that you want to download to the offline cache are requested at once.</p>
</div>
<h3 id="dealing-with-historical-data">Dealing with Historical Data<a class="headerlink" href="#dealing-with-historical-data" title="Permanent link">&para;</a></h3>
<p>Let's continue our example with a small extension.  Let's say you want to have the last 7 days worth of records
available offline, but you still want the ability to do a historical search.  In this case, you can create two
table references to the same table - one online for historical searches and one offline for the normal use case:</p>
<pre><code class="csharp">var table = client.GetSyncTable&lt;Message&gt;();
var historicalTable = client.GetTable&lt;Message&gt;();
</code></pre>

<p>In this case, the <code>table</code> reference is used to access the offline data.   However, you could implement a search
capability that does a query against the <code>historicalTable</code> instead.  They both point to the same table.  In one
case, the server is referenced (and only available online) and in the other, the local cache is referenced
(and available offline).</p>
<h2 id="purging-the-local-cache">Purging the Local Cache<a class="headerlink" href="#purging-the-local-cache" title="Permanent link">&para;</a></h2>
<p>It will be inevitable that you will want to clear the local cache at some point.</p>
<ul>
<li>You have just changed the model and underlying data and need to re-establish a baseline.</li>
<li>You only cache newer data and want to remove historical data.</li>
<li>Things got corrupt for some reason and you need to refresh everything.</li>
</ul>
<p>Whatever the reason, clearing the cache is one of those infrequent things that is going to be a necessity.  There
are three forms of this operation:</p>
<h3 id="deleting-the-backing-store">Deleting the backing store<a class="headerlink" href="#deleting-the-backing-store" title="Permanent link">&para;</a></h3>
<p>The major requirement during development is that you want to delete the SQLite file that backs the offline cache.  It's likely that the model evolves over time during development.  Add test data that can sometimes cause things to go wrong and you have a recipe for bugs that are only there because you are developing.  If you suspect bad data in the offline cache, the first thing you want to do is start afresh.</p>
<p>Each platform stores the offline cache in a different place and the mechanism for removing it is different in each case.  For Universal Windows projects, the offline cache is stored in the Local AppData folder for the application. This is a dedicated area that each Universal Windows app has access to for anything from temporary files to settings and cache files.  To find the location of the file, open the <strong>TaskList.UWP</strong> project and open the <strong>Package.appxmanifest</strong> file.  Go to the <strong>Packaging</strong> tab.</p>
<p><img alt="" src="../img/appxmanifest-packageid.PNG" /></p>
<p>Note the long <strong>Package family name</strong> field.  Your backing file is in your home directory under <code>AppData\Local\Packages\{family_name}\LocalState</code>.  You specified the name of the file when you created the store.</p>
<p>You need to find the <strong>Package Name</strong> for Android.  Right-click on the <strong>TaskList.Droid</strong> project and select <strong>Properties</strong>, then select the <strong>Android Manifest</strong> tab.</p>
<p><img alt="" src="../img/droid-manifest-packagename.PNG" /></p>
<p>The database will be located in <code>/data/data/{package_name}/files</code> directory on the emulator.  Google has provided utilities for handling developer connections to devices (including emulators).  In this case, we can use the <code>adb</code> utility.  First, start your emulator of choice through the <strong>Tools</strong> -&gt; <strong>Android</strong> -&gt; <strong>Android Emulator Manager</strong> menu option.  Highlight the emulator you have been using, then click <strong>Start</strong>.  Ensure the emulator is fully started before continuing.  The <code>adb</code> utility can be accessed through Visual Studio using <strong>Tools</strong> -&gt; <strong>Android</strong> -&gt; <strong>Android Adb Command Prompt</strong>.  You will be able to use <code>adb</code> commands from there.  Use <code>adb devices</code> to find the device and <code>adb connect</code> to connect to the device.</p>
<p>This opens up a Linux-like shell onto the Android device.  You can use normal Linux commands to move around.   You can remove the entire private data area for your package using the following:</p>
<pre><code class="bash">**root@donatello:/#** cd /data/data/Tasklist.Droid.TaskList.Droid
**root@donatollo:/#** find . -name tasklist.db -print | xargs rm
</code></pre>

<p>The database will normally be in the <code>files</code> directory.  Use <code>exit</code> to close the shell prompt on the Android device.  Each disk image file is independent.  You must remove the database file on each emulator individually.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>You can use the same <code>adb</code> commands to connect to a real Android device connected via USB.  Ensure <em>USB Debugging</em> is
enabled on the device.  Use <code>adb devices</code> to find the device.  For more information, see <a href="https://developer.android.com/studio/command-line/adb.html">the Android documentation</a>.</p>
</div>
<p>The iOS Simulator does not use an image files.  Instead, it stores files on your Mac disk in <code>~/Library/Developer/CoreSimulator/Devices</code>.  There is a file called <code>device_set.plist</code> that contains the list of devices that are defined and their location.  It is most easy to find a specific device.  For example, if you are testing on the iPhone 6x simulator:</p>
<pre><code class="bash">$ grep -B 1 'iPhone-6s&lt;' device_set.plist
&lt;string&gt;A3536AA4-0678-43CC-BA21-DD997B89778A&lt;/string&gt;
&lt;key&gt;com.apple.CoreSimulator.SimDeviceType.iPhone-6s&lt;/key&gt;
--
&lt;string&gt;83D08BC0-2F9A-4479-ABBD-A69858819E93&lt;/string&gt;
&lt;key&gt;com.apple.CoreSimulator.SimDeviceType.iPhone-6s&lt;/key&gt;
--
&lt;string&gt;ECAE441D-93F8-4D7A-BF14-7FA2D11BC152&lt;/string&gt;
&lt;key&gt;com.apple.CoreSimulator.SimDeviceType.iPhone-6s&lt;/key&gt;
</code></pre>

<p>Each one of these corresponds to a different OS version.  You can find the ordering like this:</p>
<pre><code class="bash">$ grep SimRuntime.iOS device_set.plist
&lt;key&gt;com.apple.CoreSimulator.SimRuntime.iOS-9-1&lt;/key&gt;
&lt;key&gt;com.apple.CoreSimulator.SimRuntime.iOS-9-2&lt;/key&gt;
&lt;key&gt;com.apple.CoreSimulator.SimRuntime.iOS-9-3&lt;/key&gt;
</code></pre>

<p>My simulator is an iPhone 6s running iOS 9.3, so I can see the GUID is the third one: <code>ECAE441D-93F8-4D7A-BF14-7FA2D11BC152</code>.  This GUID is a directory in the same directory as the <code>device_set.plist</code> file.  You can use normal UNIX style commands to remove the backing store:</p>
<pre><code class="bash">$ cd ECAE441D-93F8-4D7A-BF14-7FA2D11BC152
$ find . -name 'tasklist.db' -print | xargs rm
</code></pre>

<p>You can also use the normal Finder utilities to search for and remove the database file for your app.</p>
<h3 id="purging-records-from-the-offline-cache">Purging Records from the Offline Cache<a class="headerlink" href="#purging-records-from-the-offline-cache" title="Permanent link">&para;</a></h3>
<p>The <code>IMobileServiceSyncTable</code> interface also includes a capability for purging records that are stored in the offline sync by query.  This is done in code like this:</p>
<pre><code class="csharp">var lowerBound = DateTimeOffset.Now.AddDays(-7);
var query = syncTable.CreateQuery().Where(item =&gt; item.UpdatedAt &lt; lowerBound);
var force = true;
await syncTable.PurgeAsync(&quot;incsync_Tag&quot;, query, force);
</code></pre>

<p>There are four parameters for the <code>PurgeAsync</code> call:</p>
<ul>
<li>A query name.</li>
<li>An OData query.</li>
<li>A boolean for forcing the operation.</li>
<li>A cancellation token (for the async operation).</li>
</ul>
<p>Each incremental sync query has a unique name that is specified during the <code>PullAsync()</code> method call.  If you use the same name during the <code>PurgeAsync()</code> call, then the date associated with the incremental sync query is reset, causing a full refresh of the data.  This allows you to do a "purge and refresh" operation.  If you don't want this to happen, set the query name to null.</p>
<p>The OData query is a similar query format to the incremental sync query that we used with <code>PullAsync()</code>.  In this case, it selects the records that should be purged from the offline sync cache.  If we wished to purge everything, we could just use <code>syncTable.CreateQuery()</code>. If we want to purge only certain records, then we can adjust the query with a <code>.Where()</code> LINQ query.  In the example above, records that have not been updated within the last 7 days are purged.</p>
<p>Finally, the <code>PurgeAsync()</code> call will fail (and generate an exception) if there are any operations pending in the operations queue.  If we specify <code>force = true</code>, then the operations queue check is bypassed and pending operations in the operations queue are flushed without being uploaded.  It is important that this option is used only when absolutely required.  You can leave your database in an inconsistent state if you expect referential integrity between different tables.  Use <code>SyncContext.PushAsync()</code> to push the operations queue to the remote server before calling <code>PurgeAsync()</code>.   If you use <code>force = true</code>, then also specify a query name to reset the incremental sync state.</p>
<h2 id="schema-changes-in-the-offline-cache">Schema changes in the Offline Cache<a class="headerlink" href="#schema-changes-in-the-offline-cache" title="Permanent link">&para;</a></h2>
<p>During development, it's very likely that you will want to change the schema of the data being stored on the client. Unfortunately, there isn't a really good way of dealing with this situation.  Here is my solution:</p>
<ol>
<li>Create a constant within your mobile client containing a schema version number.  The actual value (text or int) doesn't matter.  You should never have the same schema version number twice though.  Change this constant whenever you change the schema.</li>
<li>Read a file from the mobile device with the schema version in it.  If the file exists and the read value is different from the constant you created in step 1, then you are "refreshing the cache"</li>
<li>If you are refreshing the cache, delete the offline cache file, then write the current schema version number to the file that you read in step 2.</li>
<li>Set up your offline cache, define your tables, etc.</li>
<li>If you are "refreshing the cache", do a full <code>PullAsync()</code> on all tables to populate the cache.</li>
</ol>
<p>You obviously want to avoid this process as much as possible.  One possible solution is to use the <a href="https://github.com/colbylwilliams/VersionTrackingPlugin">VersionTrackingPlugin</a> by Colby Williams to detect when the schema has been updated.  The following code can be added to automatically delete the offline cache when the version of the app changes:</p>
<pre><code class="csharp">// Add an isRemoteDatabaseSchemaChanged boolean somewhere
if (CrossVersionTracking.Current.IsFirstLaunchForBuild)
{
    isRemoteDatabaseSchemaChanged = true;

    // Drop SQLite Store file to overcome remote-db schema changes
    File.Delete(Constants.SqliteStorePath);
}
</code></pre>

<h2 id="debugging-the-offline-cache">Debugging the Offline Cache<a class="headerlink" href="#debugging-the-offline-cache" title="Permanent link">&para;</a></h2>
<p>One of the most difficult parts of the offline cache is that it is opaque - you can't really see what is going on.  Fortunately, the
<code>SQLiteStore</code> that is used is relatively straight forward to sub-class so we can add logging to it.  The following helper method can
be substituted for a <code>SQLiteStore</code> in any code.</p>
<pre><code class="csharp">public class MobileServiceSQLiteStoreWithLogging : MobileServiceSQLiteStore
{
    private bool logResults;
    private bool logParameters;

    public MobileServiceSQLiteStoreWithLogging(string fileName, bool logResults = false, bool logParameters = false)
        : base(fileName)
    {
        this.logResults = logResults;
        this.logParameters = logParameters;
    }

    protected override IList&lt;Newtonsoft.Json.Linq.JObject&gt; ExecuteQuery(string tableName, string sql, IDictionary&lt;string, object&gt; parameters)
    {
        Console.WriteLine (sql);

        if(logParameters)
            PrintDictionary (parameters);

        var result = base.ExecuteQuery(tableName, sql, parameters);

        if (logResults &amp;&amp; result != null)
        {
            foreach (var token in result)
                Console.WriteLine (token);
        }

        return result;
    }

    protected override void ExecuteNonQuery(string sql, IDictionary&lt;string, object&gt; parameters)
    {
        Console.WriteLine (sql);

        if(logParameters)
            PrintDictionary (parameters);

        base.ExecuteNonQuery(sql, parameters);
    }

    private void PrintDictionary(IDictionary&lt;string,object&gt; dictionary)
    {
        if (dictionary == null)
            return;

        foreach (var pair in dictionary)
            Console.WriteLine (&quot;{0}:{1}&quot;, pair.Key, pair.Value);
    }
}

public class LoggingHandler : DelegatingHandler
{
    private bool logRequestResponseBody;

    public LoggingHandler(bool logRequestResponseBody = false)
    {
        this.logRequestResponseBody = logRequestResponseBody;
    }

    protected override async Task&lt;HttpResponseMessage&gt; SendAsync(HttpRequestMessage request, System.Threading.CancellationToken cancellationToken)
    {
        Console.WriteLine(&quot;Request: {0} {1}&quot;, request.Method, request.RequestUri.ToString());

        if (logRequestResponseBody &amp;&amp; request.Content != null)
        {
            var requestContent = await request.Content.ReadAsStringAsync ();
            Console.WriteLine (requestContent);
        }

        var response = await base.SendAsync(request, cancellationToken);

        Console.WriteLine (&quot;Response: {0}&quot;, response.StatusCode);

        if (logRequestResponseBody)
        {
            var responseContent = await response.Content.ReadAsStringAsync ();
            Console.WriteLine (responseContent);
        }

        return response;
    }
}
</code></pre>

<p>Using this class will print all the SQL commands that are executed against the SQLite store.  Ensure you are capturing the console somewhere so that you can see the debug messages as you are running your application.</p>
<!-- Images -->

<!-- Links -->
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../projection/" title="Data Projection and Queries" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Data Projection and Queries
              </span>
            </div>
          </a>
        
        
          <a href="../relationships/" title="Relationships" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Relationships
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Adrian Hall
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/adrianhall" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/FizzyInTheHall" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.9fb73e57.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
    
      
        <script>!function(e,a,t,n,o,c,i){e.GoogleAnalyticsObject=o,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),i=a.getElementsByTagName(t)[0],c.async=1,c.src="https://www.google-analytics.com/analytics.js",i.parentNode.insertBefore(c,i)}(window,document,"script",0,"ga"),ga("create","UA-93366112-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");if(Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var a=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",a,e.href)})}),document.forms.search){var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})}</script>
      
    
  </body>
</html>