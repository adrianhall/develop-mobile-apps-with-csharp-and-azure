
<!DOCTYPE html>
<html class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter6/mvc/">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <link rel="shortcut icon" href="../../assets/images/favicon.png">
      
      <meta name="generator" content="mkdocs-0.16.1, mkdocs-material-1.2.0">
    
    
      
        <title>MVC Applications - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <script src="../../assets/javascripts/modernizr-56ade86843.js"></script>
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application-e17eeafcbc.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-892b79c5c5.palette.css">
      
    
    
      
        
        
        
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    
  </head>
  
  
  
  
    <body data-md-color-primary="red" data-md-color-accent="deep-purple">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <header class="md-header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-icon md-icon--home md-header-nav__button">
          </a>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <span class="md-flex__ellipsis md-header-nav__title">
          
            
              
                <span class="md-header-nav__parent">
                  Chapter 6 - Combining Web and Mobile Apps
                </span>
              
            
            MVC Applications
          
        </span>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
          
<div class="md-search" data-md-component="search">
  <div class="md-search__overlay"></div>
  <div class="md-search__inner">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" accesskey="s" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query">
      <label class="md-icon md-search__icon" for="search"></label>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result"></div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <div class="md-header-nav__source">
          
            


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

          
        </div>
      </div>
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    
      <i class="md-icon md-icon--home md-nav__button"></i>
    
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      GitHub
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Chapter 1 - Introduction
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Chapter 1 - Introduction
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_pc/" title="Your First App - PC Edition" class="md-nav__link">
      Your First App - PC Edition
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter1/firstapp_mac/" title="Your First App - Mac Edition" class="md-nav__link">
      Your First App - Mac Edition
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Chapter 2 - Authentication
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Chapter 2 - Authentication
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/backend/" title="Authentication in the Backend" class="md-nav__link">
      Authentication in the Backend
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/enterprise/" title="Enterprise Authentication" class="md-nav__link">
      Enterprise Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/social/" title="Social Authentication" class="md-nav__link">
      Social Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/debugging/" title="Debugging Authentication" class="md-nav__link">
      Debugging Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/custom/" title="Custom Authentication" class="md-nav__link">
      Custom Authentication
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/authorization/" title="Claims and Authorization" class="md-nav__link">
      Claims and Authorization
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/realworld/" title="Tokens in Real Apps" class="md-nav__link">
      Tokens in Real Apps
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter2/bestpractices/" title="Best Practices" class="md-nav__link">
      Best Practices
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Chapter 3 - Data Access and Offline Sync
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Chapter 3 - Data Access and Offline Sync
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/dataconcepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/server/" title="Implementing Table Controllers" class="md-nav__link">
      Implementing Table Controllers
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/projection/" title="Data Projection and Queries" class="md-nav__link">
      Data Projection and Queries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/client/" title="The Mobile Client" class="md-nav__link">
      The Mobile Client
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/relationships/" title="Relationships" class="md-nav__link">
      Relationships
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter3/domainmgr/" title="The Domain Manager" class="md-nav__link">
      The Domain Manager
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Chapter 4 - Server Side Code
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Chapter 4 - Server Side Code
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/options/" title="Options for Server Code" class="md-nav__link">
      Options for Server Code
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/custom/" title="Custom HTTP Endpoints" class="md-nav__link">
      Custom HTTP Endpoints
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/webjobs/" title="WebJobs" class="md-nav__link">
      WebJobs
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/functions/" title="Functions" class="md-nav__link">
      Functions
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter4/recipes/" title="Recipes" class="md-nav__link">
      Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-6" type="checkbox" id="nav-6">
    
    <label class="md-nav__link" for="nav-6">
      Chapter 5 - Push Notifications
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-6">
        Chapter 5 - Push Notifications
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/android/" title="Android Push" class="md-nav__link">
      Android Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/ios/" title="iOS Push" class="md-nav__link">
      iOS Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/windows/" title="Windows Push" class="md-nav__link">
      Windows Push
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter5/recipes/" title="Push Recipes" class="md-nav__link">
      Push Recipes
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-7" type="checkbox" id="nav-7" checked>
    
    <label class="md-nav__link" for="nav-7">
      Chapter 6 - Combining Web and Mobile Apps
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-7">
        Chapter 6 - Combining Web and Mobile Apps
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
    <a href="./" title="MVC Applications" class="md-nav__link md-nav__link--active">
      MVC Applications
    </a>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../jquery/" title="jQuery Applications" class="md-nav__link">
      jQuery Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../angular/" title="Angular Applications" class="md-nav__link">
      Angular Applications
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../react/" title="React Applications" class="md-nav__link">
      React Applications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-8" type="checkbox" id="nav-8">
    
    <label class="md-nav__link" for="nav-8">
      Chapter 7 - Other Useful Services
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-8">
        Chapter 7 - Other Useful Services
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/services/" title="Useful Azure Services" class="md-nav__link">
      Useful Azure Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/search/" title="Azure Search" class="md-nav__link">
      Azure Search
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/media/" title="Media Services" class="md-nav__link">
      Media Services
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter7/realtime/" title="Real-time Notifications" class="md-nav__link">
      Real-time Notifications
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-9" type="checkbox" id="nav-9">
    
    <label class="md-nav__link" for="nav-9">
      Chapter 8 - Developing An App
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-9">
        Chapter 8 - Developing An App
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/developing/" title="The Development Environment" class="md-nav__link">
      The Development Environment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter8/testing/" title="Testing your Application" class="md-nav__link">
      Testing your Application
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-10" type="checkbox" id="nav-10">
    
    <label class="md-nav__link" for="nav-10">
      Chapter 9 - Going to Production
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-10">
        Chapter 9 - Going to Production
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/arm/" title="Repeatable Deployments" class="md-nav__link">
      Repeatable Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/appsvc/" title="Safe Deployments" class="md-nav__link">
      Safe Deployments
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/monitoring/" title="Monitoring" class="md-nav__link">
      Monitoring
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../chapter9/troubleshooting/" title="Troubleshooting" class="md-nav__link">
      Troubleshooting
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../xamarin_tips/" title="Xamarin Forms Tips" class="md-nav__link">
      Xamarin Forms Tips
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../android_appendix/" title="Android Developer Notes" class="md-nav__link">
      Android Developer Notes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../vs_extensions/" title="Visual Studio Extensions" class="md-nav__link">
      Visual Studio Extensions
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../references/" title="References" class="md-nav__link">
      References
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../credits/" title="Credits" class="md-nav__link">
      Credits
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#sharing-the-database" title="Sharing the Database" class="md-nav__link">
    Sharing the Database
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sharing-authentication" title="Sharing Authentication" class="md-nav__link">
    Sharing Authentication
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-anti-forgery-tokens" title="Using Anti-Forgery Tokens" class="md-nav__link">
    Using Anti-Forgery Tokens
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
               
                 <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter6\mvc.md" title="Edit this page" class="md-icon md-content__edit">edit</a>
               
              
                
                  <h1>MVC Applications</h1>
                
                <p>At some point, you will likely want to pair your mobile application with a web interface.  This may be because you have a simplified mobile app whereas you may have a more fully featured app within the web.  For example,  I see this design featured prominently in fitness apps.  The mobile app is a news feed and recording device, whereas the web interface contains all the fitness analytics.  You may also have some sort of administrative interface that provides an alternate view of the data.</p>
<p>Whatever the reason you decide to support web and mobile together, you will need to convert your Azure Mobile App backend to a fully-fledged ASP.NET MVC application.  Fortunately, the process of merging Azure Mobile Apps with an existing ASP.NET MVC application is simple.  Doing the reverse (merging MVC into Azure Mobile Apps) is considerably more complex.</p>
<p>Start by creating a new ASP.NET application with File -&gt; New Project.  Select the <strong>ASP.NET Web Application (.NET Framework)</strong> project template.  Then select th <strong>MVC</strong> template.  Change the Authentication to <strong>No Authentication</strong>.</p>
<p><img alt="" src="../img/new-project.png" /></p>
<p>Click <strong>OK</strong> to create the project.  Run your project to ensure it is working correctly.</p>
<div class="admonition info">
<p class="admonition-title">Why is merging MVC into Azure Mobile Apps so hard?</p>
<p>ASP.NET requires a large number of NuGet packages to implement MVC.  These are provided for you when you start from the appropriate template, but you will need to add them yourself when you start from the Azure Mobile Apps template.</p>
</div>
<p>Now that you have an MVC project, let's add Azure Mobile Apps to it.  Start by adding the following two NuGet packages to your project:</p>
<ul>
<li>Microsoft.Azure.Mobile.Server.Quickstart</li>
<li>Microsoft.Owin.Host.SystemWeb</li>
</ul>
<p>The <code>Microsoft.Azure.Mobile.Server.Quickstart</code> NuGet package contains dependencies for all the other Azure Mobile Apps SDK requirements.  If you want the big long list instead, add the following:</p>
<ul>
<li>AutoMapper</li>
<li>EntityFramework</li>
<li>Microsoft.AspNet.WebApi.Client</li>
<li>Microsoft.AspNet.WebApi.Core</li>
<li>Microsoft.AspNet.WebApi.Owin</li>
<li>Microsoft.Azure.Mobile.Server</li>
<li>Microsoft.Azure.Mobile.Server.Authentication</li>
<li>Microsoft.Azure.Mobile.Server.Notifications</li>
<li>Microsoft.Azure.NotificationHubs</li>
<li>Microsoft.Data.Edm</li>
<li>Microsoft.Owin</li>
<li>Microsoft.Owin.Security</li>
<li>Microsoft.WindowsAzure.ConfigurationManager</li>
<li>Owin</li>
<li>System.IdentityModel.Tokens.Jwt (v4.0.x - do not install v5.x)</li>
<li>System.Spatial</li>
</ul>
<div class="admonition warn">
<p class="admonition-title">Custom Authentication</p>
<p>If you are using custom authentication, then you need to produce the entire login flow for both web and mobile sides.  There is no assistance provided with the platform.  You will also need to add the <code>Microsoft.Azure.Mobile.Server.Login</code> package to your project.</p>
</div>
<p>Using the Quickstart package is a serious time saver over having to type in 16 package names.  The SystemWeb package enables the use of the Owin Startup.cs class.  This is used to bootstrap the Azure Mobile Apps configuration.</p>
<div class="admonition tip">
<p class="admonition-title">Upgrading to .NET 4.6</p>
<p>If you want to run your ASP.NET service under .NET Framework 4.6, you can upgrade just about everything.  However, the <code>System.IdentityModel.Tokens.Jwt</code> package should not be upgraded - leave it on the latest v4.x release.  Do not upgrade <code>AutoMapper</code> beyond v3.3.1 if you are using the <code>MappedEntityDomainManager</code> class.</p>
</div>
<p>You can then copy the the following files from your original Azure Mobile Apps server project to the new project.</p>
<ul>
<li><code>App_Start\Startup.MobileApp.cs</code></li>
<li><code>Controllers\*.cs</code></li>
<li><code>DataObjects\*.cs</code></li>
<li><code>Models\MobileServiceContext.cs</code></li>
</ul>
<p>Finally, adjust or create the <code>Startup.cs</code> file as follows:</p>
<pre><code class="csharp">using Microsoft.Owin;
using Owin;

[assembly: OwinStartup(typeof(Backend.Startup))]
namespace Backend
{
    public partial class Startup
    {
        public void Configuration(IAppBuilder app)
        {
            ConfigureMobileApp(app);
        }
    }
}
</code></pre>

<p>Note the addition of the <code>ConfigureMobileApp()</code> call.  If you are starting from the suggested template, this file does not exist and you will need to create it.</p>
<p>Finally, you must update the <code>Web.config</code> file.  Firstly, in the <code>&lt;configSections&gt;</code> tag, add the following to support Entity Framework:</p>
<pre><code class="xml">    &lt;section name=&quot;entityFramework&quot; type=&quot;System.Data.Entity.Internal.ConfigFile.EntityFrameworkSection, EntityFramework, Version=6.0.0.0, Culture=neutral, PublicKeyToken=b77a5c561934e089&quot; requirePermission=&quot;false&quot; /&gt;
</code></pre>

<p>Add the following <code>&lt;connectionStrings&gt;</code> section:</p>
<pre><code class="xml">  &lt;connectionStrings&gt;
    &lt;add name=&quot;MS_TableConnectionString&quot; connectionString=&quot;Data Source=(localdb)\MSSQLLocalDB;AttachDbFilename=|DataDirectory|\aspnet-Backend.mdf;Initial Catalog=aspnet-Backend-20160720081828;Integrated Security=True;MultipleActiveResultSets=True&quot; providerName=&quot;System.Data.SqlClient&quot; /&gt;
  &lt;/connectionStrings&gt;
</code></pre>

<p>Add the following entries to the <code>&lt;appSettings&gt;</code> section:</p>
<pre><code class="xml">  &lt;appSettings&gt;
    &lt;add key=&quot;webpages:Enabled&quot; value=&quot;false&quot; /&gt;
    &lt;add key=&quot;PreserveLoginUrl&quot; value=&quot;true&quot; /&gt;
    &lt;add key=&quot;MS_SigningKey&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;EMA_RuntimeUrl&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;MS_NotificationHubName&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;SigningKey&quot; value=&quot;Overridden by portal settings&quot; /&gt;
    &lt;add key=&quot;ValidAudience&quot; value=&quot;https://chapter6.azurewebsites.net/&quot; /&gt;
    &lt;add key=&quot;ValidIssuer&quot; value=&quot;https://chapter6.azurewebsites.net/&quot; /&gt;
  &lt;/appSettings&gt;
</code></pre>

<p>The first appSetting key should already be present.  These changes can be copied from the <code>Web.config</code> file from your Azure Mobile Apps project.</p>
<h2 id="sharing-the-database">Sharing the Database<a class="headerlink" href="#sharing-the-database" title="Permanent link">&para;</a></h2>
<p>Underneath the covers, Azure Mobile Apps uses <a href="https://www.asp.net/entity-framework">EntityFramework</a> to access the database.  It requires certain adjustments to the models, as we discussed in <a href="../../chapter3/dataconcepts/">Chapter 3</a>.  However, you can still use the same Entity Framework context to access the database.  There are some caveats that must be followed, however:</p>
<ul>
<li>Inserts must set the fields that are not managed by the database (such as <code>Id</code>).</li>
<li>Deletes must set the <code>Deleted</code> column if using Soft Delete, instead of directly deleting records.</li>
</ul>
<p>Before you get started, you have to enable EF code-first migrations.  If you don't, you will get an error about a duplicate clustered index in your application for each table based on EntityData.  To enable migrations:</p>
<ol>
<li>Open the Package Manager Console in Visual Studio</li>
<li>Run <code>Enable-Migrations</code></li>
<li>
<p>Adjust the created <code>Migrations\Configuration.cs</code> constructor as follows:</p>
<p><code>csharp
    public Configuration()
    {
        AutomaticMigrationsEnabled = false;
        SetSqlGenerator("System.Data.SqlClient", new EntityTableSqlGenerator());
    }</code></p>
</li>
<li>
<p>In your <code>App_Start\Startup.MobileApp.cs</code>, comment out or remove your  <code>Database.SetInitializer()</code> call, and replace with:</p>
<p><code>csharp
var migrator = new DbMigrator(new Migrations.Configuration());
migrator.Update();</code></p>
<p>You can also remove the MobileServiceInitializer class in the same file, if you wish.</p>
</li>
<li>
<p>Run <code>Add-Migration initial</code> in the Package Manager Console.</p>
</li>
</ol>
<p>This is an abbreviated set of instructions from our work in <a href="../../chapter3/server/">Chapter 3</a>.</p>
<p>As an example, let's create a default view for handling our TodoItem controller.  In MVC, you need a Model, View and Controller class.  The Model will be handled by our existing <code>DataObjects\TodoItem.cs</code> class.  The Controller and View will be new classes.  Let's take a look at the replacement <code>HomeController.cs</code> class first:</p>
<pre><code class="csharp">using System.Linq;
using System.Web.Mvc;
using Backend.Models;

namespace Backend.Controllers
{
    public class HomeController : Controller
    {
        private MobileServiceContext context;

        public HomeController()
        {
            context = new MobileServiceContext();
        }

        public ActionResult Index()
        {
            var list = context.TodoItems.ToList();
            return View(list);
        }

        [HttpPost]
        [ValidateAntiForgeryToken]
        public async Task&lt;ActionResult&gt; Create([Bind(Include = &quot;Text&quot;)]TodoItem item)
        {
            try
            {
                if (ModelState.IsValid)
                {
                    item.Id = Guid.NewGuid().ToString(&quot;N&quot;);
                    context.TodoItems.Add(item);
                    await context.SaveChangesAsync();
                }
            }
            catch (DataException)
            {
                ModelState.AddModelError(&quot;&quot;, &quot;Unable to save changes.&quot;);
            }
            return RedirectToAction(&quot;Index&quot;);
        }
    }
}
</code></pre>

<p>I am using the existing MobileServiceContext as the Entity Framework context.  The list of tasks is taken directly from the <code>DbSet&lt;&gt;</code> that was established for the mobile backend table controller.  I also have a method for creating a new todo item within the controller.  If you look for a tutorial on implementing CRUD in ASP.NET MVC, it's likely you will see code similar to this.</p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>I've removed some additional views from this backend (About and Contact) plus the links in the layout partial view.  This is just to make the code cleaner.  You can leave them in if you desire.</p>
</div>
<p>The view in <code>Views\Home\Index.cshtml</code> is similarly changed:</p>
<pre><code class="html">@{
    ViewBag.Title = &quot;Home Page&quot;;
}
@model IEnumerable&lt;Backend.DataObjects.TodoItem&gt;

&lt;div class=&quot;row&quot; style=&quot;margin-top: 8px;&quot;&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;col-md-10&quot;&gt;
        @using (Html.BeginForm(&quot;Create&quot;, &quot;Home&quot;, FormMethod.Post))
        {
            @Html.AntiForgeryToken()
            &lt;input type=&quot;text&quot; name=&quot;Text&quot; placeholder=&quot;Enter TodoItem Text...&quot;/&gt;
            &lt;input type=&quot;submit&quot; value=&quot;Add Todo Item&quot;/&gt;
        }
    &lt;/div&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;row&quot; style=&quot;margin-top: 8px;&quot;&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
    &lt;div class=&quot;col-md-10&quot;&gt;
        &lt;div class=&quot;table-responsive&quot;&gt;
            &lt;table class=&quot;table table-striped table-bordered table-hover table-condensed&quot;&gt;
                &lt;thead&gt;
                    &lt;tr&gt;
                        &lt;th&gt;#&lt;/th&gt;
                        &lt;th&gt;Text&lt;/th&gt;
                        &lt;th&gt;Complete&lt;/th&gt;
                    &lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody&gt;
                    @foreach (var item in Model)
                    {
                        &lt;tr&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Id)&lt;/td&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Text)&lt;/td&gt;
                            &lt;td&gt;@Html.DisplayFor(modelItem =&gt; item.Complete)&lt;/td&gt;
                        &lt;/tr&gt;
                    }
                &lt;/tbody&gt;
            &lt;/table&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;div class=&quot;col-md-1&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
</code></pre>

<p>The HTML classes are from <a href="http://getbootstrap.com/">Bootstrap</a> - a common CSS framework.  The first row div encapsulates the form for adding a new todo item, and the second row div encapsulates the list.  If you enter some text into the box and click the submit button, it will be added to the database.</p>
<h2 id="sharing-authentication">Sharing Authentication<a class="headerlink" href="#sharing-authentication" title="Permanent link">&para;</a></h2>
<div class="admonition warn">
<p class="admonition-title">Custom Authentication</p>
<p>This section only pertains to using the standard authentication techniques provided with Azure App Service.  It does not pertain to custom authentication.  If you are using custom authentication, then you need to produce the entire login flow for both web and mobile sides.  There is no assistance provided with the platform.</p>
</div>
<p>As one would suspect, <a href="../../chapter2/authconcepts/">setting up App Service Authentication</a>, then adding an <code>[Authorize]</code> attribute to the <code>HomeController</code> is a good starting point for making our application authenticated.  However, it isn't enough.  If you just do this, you will got something like the following:</p>
<p><img alt="" src="../img/failed-auth.PNG" /></p>
<p>In order to properly capture the login flow, we have to redirect a missing authentication to the appropriate authentication endpoint.  In ASP.NET, this functionality is configured within the <code>Web.config</code> file.  Locate the <code>&lt;system.web&gt;</code> section and add the following:</p>
<pre><code class="xml">  &lt;system.web&gt;
    &lt;compilation debug=&quot;true&quot; targetFramework=&quot;4.5.2&quot;/&gt;
    &lt;httpRuntime targetFramework=&quot;4.5.2&quot;/&gt;
    &lt;authentication mode=&quot;Forms&quot;&gt;
      &lt;forms loginUrl=&quot;/.auth/login/aad&quot; timeout=&quot;2880&quot;/&gt;
    &lt;/authentication&gt;
  &lt;/system.web&gt;
</code></pre>

<p>The <code>&lt;compilation&gt;</code> and <code>&lt;httpRuntime&gt;</code> values should already be present.  The <code>&lt;authentication&gt;</code> section is new.  Once you deploy this code to Azure App Service, you will be redirected to your authentication provider.  Once the authentication process is complete, you will receive a page indicating successful authentication, with a link back to the website.</p>
<div class="admonition warn">
<p class="admonition-title">Use a private browsing window for testing</p>
<p>One of the major problems with using Azure AD for authentication as a developer is that the Azure Portal authentication uses the same providers.  This can cause problems in your app.  Always use a private browsing window and/or a different browser for testing your code.</p>
</div>
<h3 id="using-anti-forgery-tokens">Using Anti-Forgery Tokens<a class="headerlink" href="#using-anti-forgery-tokens" title="Permanent link">&para;</a></h3>
<p>One of the gotchas for using ASP.NET MVC with Azure App Service Authentication is that the Anti-Forgery Token no longer works as advertised.  If you try to use the anti-forgery token on POST operations (and the associated <code>[ValidateAntiForgeryToken]</code> within your controller), you will receive the following exception:</p>
<blockquote>
<p>A claim of type 'http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier' or 'http://schemas.microsoft.com/accesscontrolservice/2010/07/claims/identityprovider' was not present on the provided ClaimsIdentity. To enable anti-forgery token support with claims-based authentication, please verify that the configured claims provider is providing both of these claims on the ClaimsIdentity instances it generates. If the configured claims provider instead uses a different claim type as a unique identifier, it can be configured by setting the static property AntiForgeryConfig.UniqueClaimTypeIdentifier.</p>
</blockquote>
<p>Unfortunately, the logic here is wrong.  Check the <a href="https://github.com/mono/aspnetwebstack/blob/6248bfd24c31356e75a31c1b1030d4d96f669a6a/src/System.Web.WebPages/Helpers/AntiXsrf/ClaimUidExtractor.cs#L78">source code</a> and you will see that both listed claims must be present to not throw the exception.  The Azure App Service Authentication claims do not include the <code>identityprovider</code> claim.  With the advent of .NET Core, I do not expect this bug to be fixed.  The workaround is to explicitly specify the identifier to use somewhere in your application startup:</p>
<pre><code class="csharp">AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;
</code></pre>

<p>I place this in the MVC specific <code>App_Start\RouteConfig.cs</code> file:</p>
<pre><code class="csharp">namespace Backend
{
    public class RouteConfig
    {
        public static void RegisterRoutes(RouteCollection routes)
        {
            routes.IgnoreRoute(&quot;{resource}.axd/{*pathInfo}&quot;);

            routes.MapRoute(
                name: &quot;Default&quot;,
                url: &quot;{controller}/{action}/{id}&quot;,
                defaults: new { controller = &quot;Home&quot;, action = &quot;Index&quot;, id = UrlParameter.Optional }
            );

            AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;
        }
    }
}
</code></pre>

<p>This will force the use of the (singular) claim rather than requiring both claims to be present, thus allowing you to use the anti-forgery token.</p>
<!-- Images -->

<!-- Links -->
              
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../chapter5/recipes/" title="Push Recipes" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Push Recipes
              </span>
            </div>
          </a>
        
        
          <a href="../jquery/" title="jQuery Applications" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                jQuery Applications
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2017 Adrian Hall
          </div>
        
        powered by
        <a href="http://www.mkdocs.org" title="MkDocs">MkDocs</a>
        and
        <a href="http://squidfunk.github.io/mkdocs-material/" title="Material for MkDocs">
          Material for MkDocs</a>
      </div>
      
        
  <div class="md-footer-social">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    
      <a href="https://github.com/adrianhall" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/FizzyInTheHall" class="md-footer-social__link fa fa-twitter"></a>
    
  </div>

      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application-30ac6a1727.js"></script>
      <script>app.initialize({url:{base:"../.."}})</script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
    
      
      <script>!function(e,t,a,n,o,c,i){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,c=t.createElement(a),i=t.getElementsByTagName(a)[0],c.async=1,c.src=n,i.parentNode.insertBefore(c,i)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-93366112-1","auto"),ga("set","anonymizeIp",!0),ga("send","pageview");var links=document.getElementsByTagName("a");Array.prototype.map.call(links,function(e){e.host!=document.location.host&&e.addEventListener("click",function(){var t=e.getAttribute("data-md-action")||"follow";ga("send","event","outbound",t,e.href)})});var query=document.forms.search.query;query.addEventListener("blur",function(){if(this.value){var e=document.location.pathname;ga("send","pageview",e+"?q="+this.value)}})</script>
      
    
  </body>
</html>