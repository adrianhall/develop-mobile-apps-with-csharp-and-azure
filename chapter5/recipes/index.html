
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Adrian Hall">
      
      
        <link rel="canonical" href="https://adrianhall.github.io/develop-mobile-apps-with-csharp-and-azure/chapter5/recipes/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.2.14">
    
    
      
        <title>Push Recipes - Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3de6f41f.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.cc9b2e1e.min.css">
        
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../css/extra.css">
    
      <link rel="stylesheet" href="../../css/vs.css">
    
    <script>__md_scope=new URL("../..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#marketing-push" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-header__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Push Recipes
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" class="md-nav__button md-logo" aria-label="Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Develop Cloud Connected Mobile Apps with Xamarin and Microsoft Azure
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Chapter 1 - Introduction
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 1 - Introduction" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Chapter 1 - Introduction
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_pc/" class="md-nav__link">
        Your First App - PC Edition
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter1/firstapp_mac/" class="md-nav__link">
        Your First App - Mac Edition
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Chapter 2 - Authentication
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 2 - Authentication" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Chapter 2 - Authentication
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/backend/" class="md-nav__link">
        Authentication in the Backend
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/enterprise/" class="md-nav__link">
        Enterprise Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/social/" class="md-nav__link">
        Social Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/debugging/" class="md-nav__link">
        Debugging Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/custom/" class="md-nav__link">
        Custom Authentication
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/authorization/" class="md-nav__link">
        Claims and Authorization
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/realworld/" class="md-nav__link">
        Tokens in Real Apps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter2/bestpractices/" class="md-nav__link">
        Best Practices
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          Chapter 3 - Data Access and Offline Sync
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 3 - Data Access and Offline Sync" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Chapter 3 - Data Access and Offline Sync
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/dataconcepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/server/" class="md-nav__link">
        Implementing Table Controllers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/projection/" class="md-nav__link">
        Data Projection and Queries
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/client/" class="md-nav__link">
        The Mobile Client
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/relationships/" class="md-nav__link">
        Relationships
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter3/domainmgr/" class="md-nav__link">
        The Domain Manager
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Chapter 4 - Server Side Code
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 4 - Server Side Code" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Chapter 4 - Server Side Code
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/options/" class="md-nav__link">
        Options for Server Code
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/custom/" class="md-nav__link">
        Custom HTTP Endpoints
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/webjobs/" class="md-nav__link">
        WebJobs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/functions/" class="md-nav__link">
        Functions
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter4/recipes/" class="md-nav__link">
        Recipes
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Chapter 5 - Push Notifications
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 5 - Push Notifications" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Chapter 5 - Push Notifications
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../concepts/" class="md-nav__link">
        Concepts
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../android/" class="md-nav__link">
        Android Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ios/" class="md-nav__link">
        iOS Push
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../windows/" class="md-nav__link">
        Windows Push
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Push Recipes
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Push Recipes
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#marketing-push" class="md-nav__link">
    Marketing Push
  </a>
  
    <nav class="md-nav" aria-label="Marketing Push">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-android" class="md-nav__link">
    Deep Linking with Android
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-ios" class="md-nav__link">
    Deep Linking with iOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-uwp" class="md-nav__link">
    Deep Linking with UWP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#push-to-sync" class="md-nav__link">
    Push to Sync
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_7" type="checkbox" id="__nav_7" >
      
      
      
      
        <label class="md-nav__link" for="__nav_7">
          Chapter 6 - Combining Web and Mobile Apps
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 6 - Combining Web and Mobile Apps" data-md-level="1">
        <label class="md-nav__title" for="__nav_7">
          <span class="md-nav__icon md-icon"></span>
          Chapter 6 - Combining Web and Mobile Apps
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/mvc/" class="md-nav__link">
        MVC Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/jquery/" class="md-nav__link">
        jQuery Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/angular/" class="md-nav__link">
        Angular Applications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter6/react/" class="md-nav__link">
        React Applications
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_8" type="checkbox" id="__nav_8" >
      
      
      
      
        <label class="md-nav__link" for="__nav_8">
          Chapter 7 - Other Useful Services
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 7 - Other Useful Services" data-md-level="1">
        <label class="md-nav__title" for="__nav_8">
          <span class="md-nav__icon md-icon"></span>
          Chapter 7 - Other Useful Services
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/services/" class="md-nav__link">
        Useful Azure Services
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/search/" class="md-nav__link">
        Azure Search
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter7/media/" class="md-nav__link">
        Media Services
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_9" type="checkbox" id="__nav_9" >
      
      
      
      
        <label class="md-nav__link" for="__nav_9">
          Chapter 8 - Developing An App
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 8 - Developing An App" data-md-level="1">
        <label class="md-nav__title" for="__nav_9">
          <span class="md-nav__icon md-icon"></span>
          Chapter 8 - Developing An App
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/developing/" class="md-nav__link">
        The Development Environment
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter8/testing/" class="md-nav__link">
        Testing your Application
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_10" type="checkbox" id="__nav_10" >
      
      
      
      
        <label class="md-nav__link" for="__nav_10">
          Chapter 9 - Going to Production
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Chapter 9 - Going to Production" data-md-level="1">
        <label class="md-nav__title" for="__nav_10">
          <span class="md-nav__icon md-icon"></span>
          Chapter 9 - Going to Production
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/arm/" class="md-nav__link">
        Repeatable Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/appsvc/" class="md-nav__link">
        Safe Deployments
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../chapter9/monitoring/" class="md-nav__link">
        Monitoring and Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../xamarin_tips/" class="md-nav__link">
        Xamarin Forms Tips
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../android_appendix/" class="md-nav__link">
        Android Developer Notes
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../vs_extensions/" class="md-nav__link">
        Visual Studio Extensions
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../references/" class="md-nav__link">
        References
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../credits/" class="md-nav__link">
        Credits
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#marketing-push" class="md-nav__link">
    Marketing Push
  </a>
  
    <nav class="md-nav" aria-label="Marketing Push">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-android" class="md-nav__link">
    Deep Linking with Android
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-ios" class="md-nav__link">
    Deep Linking with iOS
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deep-linking-with-uwp" class="md-nav__link">
    Deep Linking with UWP
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#push-to-sync" class="md-nav__link">
    Push to Sync
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/adrianhall/develop-mobile-apps-with-csharp-and-azure/edit/master/docs/chapter5/recipes.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>Push Recipes</h1>

<p>This section is dedicated to exploring various common recipes for push notifications and how we can achieve those recipes through cross-platform code.</p>
<h2 id="marketing-push">Marketing Push<a class="headerlink" href="#marketing-push" title="Permanent link">&para;</a></h2>
<p>The most common requirement for push notifications is to alert users of a special offer or other marketing information.  The general idea is that the marketing person will create a "campaign" that includes a push notification.  When the user receives the push notification, they will accept it.  If a user accepts the push notification, the mobile app will deep-link into a specific page and store the fact that the user viewed the page within the database.</p>
<p>To implement this sort of functionality within a cross-platform application, we need to implement <strong>Templates</strong>.  We gave demonstrations of the implementation of the templates while we were discussing the various platform implementations.  However, we didn't actually use them.  A template is provides by the mobile client when registering.  Let's take a look at a typical template as implemented by each platform:</p>
<p><strong>Android</strong>:</p>
<pre><code class="language-text">{
    &quot;data&quot;: {
        &quot;message&quot;: &quot;$(message)&quot;,
        &quot;picture&quot;: &quot;$(picture)&quot;
    }
}
</code></pre>
<p><strong>iOS</strong>:</p>
<pre><code class="language-text">{
    &quot;aps&quot;: {
        &quot;alert&quot;: &quot;$(message)&quot;,
        &quot;picture&quot;: &quot;$(picture)&quot;
    }
}
</code></pre>
<p><strong>Windows</strong>:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;toast launch=&quot;zumobook&quot;&gt;
  &lt;visual&gt;
    &lt;binding template=&quot;ToastGeneric&quot;&gt;
      &lt;text&gt;$(message)&lt;/text&gt;
    &lt;/binding&gt;
  &lt;/visual&gt;
  &lt;actions&gt;
    &lt;action content=&quot;Open&quot; arguments=&quot;$(picture)&quot; /&gt;
    &lt;action content=&quot;Cancel&quot; arguments=&quot;cancel&quot; /&gt;
  &lt;/actions&gt;
&lt;/toast&gt;
</code></pre>
<div class="admonition tip">
<p class="admonition-title">Toast, Tile and Badge Schemas</p>
<p>If you want to understand the format of the XML that we are using in the Windows section, it's laid out in the <a href="https://msdn.microsoft.com/en-us/library/windows/apps/br212853.aspx">MSDN documentation</a>.</p>
</div>
<p>Each of these formats can be specified in the appropriate registration call:</p>
<pre><code class="language-csharp">    // Android Version
    var genericTemplate = new PushTemplate
    {
        Body = @&quot;{&quot;&quot;data&quot;&quot;:{&quot;&quot;message&quot;&quot;:&quot;&quot;$(message)&quot;&quot;,&quot;&quot;picture&quot;&quot;:&quot;&quot;$(picture)&quot;&quot;}}&quot;
    };
    installation.Templates.Add(&quot;genericTemplate&quot;, genericTemplate);

    // iOS Version
    var genericTemplate = new PushTemplate
    {
        Body = @&quot;{&quot;&quot;aps&quot;&quot;:{&quot;&quot;alert&quot;&quot;:&quot;&quot;$(message)&quot;&quot;,&quot;&quot;picture&quot;&quot;:&quot;&quot;$(picture)&quot;&quot;}}&quot;
    };
    installation.Templates.Add(&quot;genericTemplate&quot;, genericTemplate);

    // Windows Version
    var genericTemplate = new WindowsPushTemplate
    {
        Body = @&quot;&lt;?xml version=&quot;&quot;1.0&quot;&quot; encoding=&quot;&quot;utf-8&quot;&quot;?&gt;
&lt;toast launch=&quot;&quot;zumobook&quot;&quot;&gt;
  &lt;visual&gt;
    &lt;binding template=&quot;&quot;ToastGeneric&quot;&quot;&gt;
      &lt;text&gt;$(message)&lt;/text&gt;
    &lt;/binding&gt;
  &lt;/visual&gt;
  &lt;actions&gt;
    &lt;action content=&quot;&quot;Open&quot;&quot; arguments=&quot;&quot;$(picture)&quot;&quot; /&gt;
    &lt;action content=&quot;&quot;Cancel&quot;&quot; arguments=&quot;&quot;cancel&quot;&quot; /&gt;
  &lt;/actions&gt;
&lt;/toast&gt;&quot;
    };
    genericTemplate.Headers.Add(&quot;X-WNS-Type&quot;, &quot;wns/toast&quot;);
    installation.Templates.Add(&quot;genericTemplate&quot;, genericTemplate);
</code></pre>
<p>To push, we can use the same Test Send facility in the Azure Portal.  In the Test Send screen, set the <strong>Platforms</strong> field to be <strong>Custom Template</strong>, and the payload to be a JSON document with the two fields:</p>
<pre><code class="language-text">{
    &quot;message&quot;: &quot;Test Message&quot;,
    &quot;picture&quot;: &quot;http://r.ddmcdn.com/w_606/s_f/o_1/cx_0/cy_15/cw_606/ch_404/APL/uploads/2014/06/01-kitten-cuteness-1.jpg&quot;
}
</code></pre>
<p>If you have done all the changes thus far, you will receive the same notification as before.  The difference is that you are pushing a message once and receiving that same message across all the Android, iOS and Windows systems at the same time.  You no longer have to know what sort of device your users are holding - the message will get to them.</p>
<p>We can take this a step further, however, by deep-linking.  Deep-linking is a technique often used in push notification systems whereby we present the user a dialog that asks them to open the notification.  If the notification is opened, they are taken directly to a new view with the appropriate content provided.</p>
<h3 id="deep-linking-with-android">Deep Linking with Android<a class="headerlink" href="#deep-linking-with-android" title="Permanent link">&para;</a></h3>
<p>Let's start our investigation with the Android code-base.  Our push notification is received by the <code>OnMessage()</code> method within the <code>GcmService</code> class in the <code>GcmHandler.cs</code> file.  We can easily extract the two fields we need to execute our deep-link:</p>
<pre><code class="language-csharp">protected override void OnMessage(Context context, Intent intent)
{
    Log.Info(&quot;GcmService&quot;, $&quot;Message {intent.ToString()}&quot;);
    var message = intent.Extras.GetString(&quot;message&quot;) ?? &quot;Unknown Message&quot;;
    var picture = intent.Extras.GetString(&quot;picture&quot;);
    CreateNotification(&quot;TaskList&quot;, message, picture);
}
</code></pre>
<p>We can continue by implementing a special format of the notification message we used earlier to send a notification:</p>
<pre><code class="language-csharp">private void CreateNotification(string title, string msg, string parameter = null)
{
    var startupIntent = new Intent(this, typeof(MainActivity));
    startupIntent.PutExtra(&quot;param&quot;, parameter);

    var stackBuilder = TaskStackBuilder.Create(this);
    stackBuilder.AddParentStack(Java.Lang.Class.FromType(typeof(MainActivity)));
    stackBuilder.AddNextIntent(startupIntent);

    var pendingIntent = stackBuilder.GetPendingIntent(0, PendingIntentFlags.OneShot);
    var notification = new Notification.Builder(this)
        .SetContentIntent(pendingIntent)
        .SetContentTitle(title)
        .SetContentText(msg)
        .SetSmallIcon(Resource.Drawable.icon)
        .SetAutoCancel(true)
        .Build();
    var notificationManager = GetSystemService(Context.NotificationService) as NotificationManager;
    notificationManager.Notify(0, notification);
}
</code></pre>
<p>The additional piece is the <code>startupIntent</code>.  When the user clicks on open, the mobile app is called with the <code>startupIntent</code> included in the context.  We update the <code>OnCreate()</code> method with <code>MainActivity.cs</code> to read this intent:</p>
<pre><code class="language-csharp">[Activity(Label = &quot;TaskList.Droid&quot;, Icon = &quot;@drawable/icon&quot;, MainLauncher = true, ConfigurationChanges = ConfigChanges.ScreenSize | ConfigChanges.Orientation)]
public class MainActivity : global::Xamarin.Forms.Platform.Android.FormsApplicationActivity
{
    protected override void OnCreate(Bundle bundle)
    {
        base.OnCreate(bundle);

        Microsoft.WindowsAzure.MobileServices.CurrentPlatform.Init();

        global::Xamarin.Forms.Forms.Init(this, bundle);

        ((DroidPlatformProvider)DependencyService.Get&lt;IPlatformProvider&gt;()).Init(this);

        string param = this.Intent.GetStringExtra(&quot;param&quot;);
        LoadApplication(new App(loadParameter: param));
    }
}
</code></pre>
<p>The param string is null on the first start (or when the intent is not present).  This get's passed to our <code>App()</code> constructor (in the shared project):</p>
<pre><code class="language-csharp">public App(string loadParameter = null)
{
    ServiceLocator.Instance.Add&lt;ICloudService, AzureCloudService&gt;();

    if (loadParameter == null)
    {
        MainPage = new NavigationPage(new Pages.EntryPage());
    }
    else
    {
        MainPage = new NavigationPage(new Pages.PictureView(loadParameter));
    }
}
</code></pre>
<p>If the <code>App()</code> constructor is passed a non-null parameter, then we deep-link to a new page instead of going to the entry page.  Now all we need to do is create a XAML page as follows that loads a picture.  The <code>Pages.PictureView.xaml</code> is small enough since its only function is to display a picture:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot; ?&gt;
&lt;ContentPage
    x:Class=&quot;TaskList.Pages.PictureView&quot;
    xmlns=&quot;http://xamarin.com/schemas/2014/forms&quot;
    xmlns:x=&quot;http://schemas.microsoft.com/winfx/2009/xaml&quot;&gt;
    &lt;Image x:Name=&quot;background&quot; Source=&quot;{Binding PictureSource, Mode=OneWay}&quot; /&gt;
&lt;/ContentPage&gt;
</code></pre>
<p>The code behind file looks similar to the <code>TaskDetail</code> page:</p>
<pre><code class="language-csharp">using Xamarin.Forms;
using Xamarin.Forms.Xaml;

namespace TaskList.Pages
{
    [XamlCompilation(XamlCompilationOptions.Compile)]
    public partial class PictureView : ContentPage
    {
        public PictureView(string picture)
        {
            InitializeComponent();
            BindingContext = new ViewModels.PictureViewModel(picture);
        }
    }
}
</code></pre>
<p>Finally, the view model should be familiar at this point:</p>
<pre><code class="language-csharp">using TaskList.Abstractions;
using Xamarin.Forms;

namespace TaskList.ViewModels
{
    public class PictureViewModel : BaseViewModel
    {
        public PictureViewModel(string picture = null)
        {
            if (picture != null)
            {
                PictureSource = picture;
            }
            Title = &quot;A Picture for you&quot;;
        }

        public string PictureSource { get; }
    }
}
</code></pre>
<p>If I were to continue, I would add some controls that allow me to go back to the task list (if I am logged in) or the entry page (if I am not logged in).</p>
<div class="admonition tip">
<p class="admonition-title">Keep the Push Small</p>
<p>You should keep the push payload as small as possible.  There are limits and they vary by platform (but are in the range of 4-5Kb).  Note that I don't include the full URL of the picture, for example, nor do I include the picture as binary data.  This allows me to adjust to an appropriate image URLwithin the client.  This keeps the number of bytes in the push small, but also allows me to adjust the image for the platform, if necessary.</p>
</div>
<h3 id="deep-linking-with-ios">Deep Linking with iOS<a class="headerlink" href="#deep-linking-with-ios" title="Permanent link">&para;</a></h3>
<p>Deep linking with iOS follows a similar pattern to Android.  The notification is received by <code>DidReceiveRemoteNotification()</code> method in the <code>AppDelegate.cs</code>, which we can then process to load the appropriate page from the background.</p>
<p>First, update the <code>DidReceiveRemoteNotification()</code> method to call a new method we will define in a moment.  This allows us to call the notification processor from multiple places:</p>
<pre><code class="language-csharp">/// &lt;summary&gt;
/// Handler for Push Notifications
/// &lt;/summary&gt;
public override void DidReceiveRemoteNotification(UIApplication application, NSDictionary userInfo, Action&lt;UIBackgroundFetchResult&gt; completionHandler)
{
    ProcessNotification(userInfo, false);
}
</code></pre>
<p>This method is also defined in the <code>AppDelegate.cs</code> class:</p>
<pre><code class="language-csharp">private void ProcessNotification(NSDictionary options, bool fromFinishedLoading)
{
    if (!(options != null &amp;&amp; options.ContainsKey(new NSString(&quot;aps&quot;))))
    {
        // Short circuit - nothing to do
        return;
    }

    NSDictionary aps = options.ObjectForKey(new NSString(&quot;aps&quot;)) as NSDictionary;

    // Obtain the alert and picture elements if they are there
    var alertString = GetStringFromOptions(aps, &quot;alert&quot;);
    var pictureString = GetStringFromOptions(aps, &quot;picture&quot;);

    if (!fromFinishedLoading)
    {
        // Manually show an alert
        if (!string.IsNullOrEmpty(alertString))
        {
            UIAlertView alertView = new UIAlertView(
                &quot;TaskList&quot;,
                alertString,
                null,
                NSBundle.MainBundle.LocalizedString(&quot;Cancel&quot;, &quot;Cancel&quot;),
                NSBundle.MainBundle.LocalizedString(&quot;OK&quot;, &quot;OK&quot;)
            );
            alertView.Clicked += (sender, args) =&gt;
            {
                if (args.ButtonIndex != alertView.CancelButtonIndex)
                {
                    if (!string.IsNullOrEmpty(pictureString))
                    {
                        App.Current.MainPage = new NavigationPage(new Pages.PictureView(pictureString));
                    }
                }
            };
            alertView.Show();
        }
    }
}

private string GetStringFromOptions(NSDictionary options, string key)
{
    string v = string.Empty;
    if (options.ContainsKey(new NSString(key)))
    {
        v = (options[new NSString(key)] as NSString).ToString();
    }
    return v;
}
</code></pre>
<p>This method checks to see if there is something to do.  If there is, it generates the alert as before.  This time, however, if the user clicks on OK, then it sets the current page to the same <code>PictureView</code> view that was used by the Android application.  The <code>GetStringFromOptions()</code> method is a convenience method for extracting strings from the push notification payload.</p>
<p>Send the following push notification to receive the picture:</p>
<pre><code class="language-text">{
    &quot;aps&quot;:{
        &quot;alert&quot;:&quot;Notification Hub test notification&quot;,
        &quot;picture&quot;:&quot;http://r.ddmcdn.com/w_606/s_f/o_1/cx_0/cy_15/cw_606/ch_404/APL/uploads/2014/06/01-kitten-cuteness-1.jpg&quot;
    }
}
</code></pre>
<p>You should test this in the following cases:</p>
<ul>
<li>The app is running and in the foreground.</li>
<li>The app is running, but in the background.</li>
<li>The app is not running at all.</li>
</ul>
<h3 id="deep-linking-with-uwp">Deep Linking with UWP<a class="headerlink" href="#deep-linking-with-uwp" title="Permanent link">&para;</a></h3>
<p>Universal Windows is perhaps the most complete story for notifications out there.  Firstly, let's construct our notification.  On the <strong>Test Send</strong> blade within your notification hub in the Azure portal, choose <strong>Windows</strong> as the platform and cut and paste the following into the Payload:</p>
<pre><code class="language-xml">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;toast launch=&quot;zumobook&quot;&gt;
  &lt;visual&gt;
    &lt;binding template=&quot;ToastGeneric&quot;&gt;
      &lt;text&gt;This is a simple toast notification example&lt;/text&gt;
    &lt;/binding&gt;
  &lt;/visual&gt;
  &lt;actions&gt;
    &lt;action content=&quot;Open&quot; arguments=&quot;http://static.boredpanda.com/blog/wp-content/uploads/2016/08/cute-kittens-7-57b30aa10707a__605.jpg&quot; /&gt;
    &lt;action content=&quot;Cancel&quot; arguments=&quot;cancel&quot; /&gt;
  &lt;/actions&gt;
&lt;/toast&gt;
</code></pre>
<p>This payload provides a textual response with two buttons - an open button and a cancel button.  The most important part of this, however, is the <code>launch="zumobook"</code>.  If the user clicks on Open, the application it is associated with is launched via the <code>OnActivated()</code> method, and the toast information is passed into that method.  This method is located in the <code>App.xaml.cs</code> file of the TaskList.UWP project:</p>
<pre><code class="language-csharp">protected override void OnActivated(IActivatedEventArgs args)
{
    if (args.Kind == ActivationKind.ToastNotification)
    {
        var toastArgs = args as ToastNotificationActivatedEventArgs;
        Xamarin.Forms.Application.Current.MainPage = new Xamarin.Forms.NavigationPage(
            new Pages.PictureView(toastArgs.Argument));
    }
}
</code></pre>
<p>The only real problem here is that there is a conflict within this file between the standard <code>Frame</code> object and the Xamarin Forms version of the <code>Frame</code> object.  If you use <code>using Xamarin.Forms;</code> in this file, you have to fully qualify conflicting classes.  It's just as easy to fully-qualify the specific Xamarin Forms classes when they are needed, as I did above.</p>
<h2 id="push-to-sync">Push to Sync<a class="headerlink" href="#push-to-sync" title="Permanent link">&para;</a></h2>
<p>Sometimes, you want to alert the user that there is something new for that user.  When the user is alerted, acceptance of the push notification indicates that the user wants to go to the app and synchronize the database before viewing the data.</p>
<p>Push to Sync is very similar to the Marketing Push, but there are some caveats.  In general, the synchronization process should happen within 30 seconds.  That's not very long in the mobile world.  So, what do you do?</p>
<p>Firstly, let's look at the code for the server-side.  We need to generate an asynchronous push whenever a record is updated.  We will pass the ID of the updated record with the push.  Here is an example table controller:</p>
<pre><code class="language-csharp">using System.Linq;
using System.Threading.Tasks;
using System.Web.Http;
using System.Web.Http.Controllers;
using System.Web.Http.OData;
using Microsoft.Azure.Mobile.Server;
using Backend.DataObjects;
using Backend.Models;
using Microsoft.Azure.Mobile.Server.Config;
using Microsoft.Azure.NotificationHubs;
using System.Collections.Generic;
using System;

namespace Backend.Controllers
{
    [Authorize]
    public class TodoItemController : TableController&lt;TodoItem&gt;
    {
        protected override void Initialize(HttpControllerContext controllerContext)
        {
            base.Initialize(controllerContext);
            MobileServiceContext context = new MobileServiceContext();
            DomainManager = new EntityDomainManager&lt;TodoItem&gt;(context, Request, enableSoftDelete: true);
        }

        // GET tables/TodoItem
        public IQueryable&lt;TodoItem&gt; GetAllTodoItems()
        {
            return Query();
        }

        // GET tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public SingleResult&lt;TodoItem&gt; GetTodoItem(string id)
        {
            return Lookup(id);
        }

        // PATCH tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task&lt;TodoItem&gt; PatchTodoItem(string id, Delta&lt;TodoItem&gt; patch)
        {
            var item = await UpdateAsync(id, patch);
            await PushToSyncAsync(&quot;todoitem&quot;, item.Id);
            return item;
        }

        // POST tables/TodoItem
        public async Task&lt;IHttpActionResult&gt; PostTodoItem(TodoItem item)
        {
            TodoItem current = await InsertAsync(item);
            await PushToSyncAsync(&quot;todoitem&quot;, item.Id);
            return CreatedAtRoute(&quot;Tables&quot;, new { id = current.Id }, current);
        }

        // DELETE tables/TodoItem/48D68C86-6EA6-4C25-AA33-223FC9A27959
        public async Task DeleteTodoItem(string id)
        {
            await PushToSyncAsync(&quot;todoitem&quot;, id);
            await DeleteAsync(id);
        }

        private async Task PushToSyncAsync(string table, string id)
        {
            var appSettings = this.Configuration.GetMobileAppSettingsProvider().GetMobileAppSettings();
            var nhName = appSettings.NotificationHubName;
            var nhConnection = appSettings.Connections[MobileAppSettingsKeys.NotificationHubConnectionString].ConnectionString;

            // Create a new Notification Hub client
            var hub = NotificationHubClient.CreateClientFromConnectionString(nhConnection, nhName);

            // Create a template message
            var templateParams = new Dictionary&lt;string, string&gt;();
            templateParams[&quot;op&quot;] = &quot;sync&quot;;
            templateParams[&quot;table&quot;] = table;
            templateParams[&quot;id&quot;] = id;

            // Send the template message
            try
            {
                var result = await hub.SendTemplateNotificationAsync(templateParams);
                Configuration.Services.GetTraceWriter().Info(result.State.ToString());
            }
            catch (Exception ex)
            {
                Configuration.Services.GetTraceWriter().Error(ex.Message, null, &quot;PushToSync Error&quot;);
            }
        }
    }
}
</code></pre>
<p>The important code here is the <code>PushToSyncAsync()</code> method.  This does the actual push to your clients.  In this version, any client that has registered a template with the <code>$(op)</code>, <code>$(table)</code> and <code>$(id)</code> variables will get the push notification.  The Notifications Hub SDK <code>SendTemplateNotificationAsync()</code> method can also send to a list of devices and a tag expression via various overloads.</p>
<p>We have to also register a new template.  Here are the two versions:</p>
<pre><code class="language-csharp">// Android version
var pushToSyncTemplate = new PushTemplate
{
    Body = @&quot;{&quot;&quot;data&quot;&quot;:{&quot;&quot;op&quot;&quot;:&quot;&quot;$(op)&quot;&quot;,&quot;&quot;table&quot;&quot;:&quot;&quot;$(table)&quot;&quot;,&quot;&quot;id&quot;&quot;:&quot;&quot;$(id)&quot;&quot;}}&quot;
};
installation.Templates.Add(&quot;pushToSync&quot;, pushToSyncTemplate);

// iOS version
PushTemplate pushToSyncTemplate = new PushTemplate
{
    Body = @&quot;{&quot;&quot;aps&quot;&quot;:{&quot;&quot;op&quot;&quot;:&quot;&quot;$(op)&quot;&quot;,&quot;&quot;table&quot;&quot;:&quot;&quot;$(table)&quot;&quot;,&quot;&quot;id&quot;&quot;:&quot;&quot;$(id)&quot;&quot;},&quot;&quot;content-available&quot;&quot;:1}&quot;
}
installation.Templates.Add(&quot;pushToSync&quot;, pushToSyncTemplate);
</code></pre>
<div class="admonition info">
<p class="admonition-title">What about Universal Windows</p>
<p>You can do some remarkable things with Universal Windows, but you have to resort to raw pushes.  At that 
point, you can decide what to put in the payload.  When running, these are handled the same way as the 
marketing push.  For more information, see <a href="https://docs.microsoft.com/en-us/windows/uwp/controls-and-patterns/tiles-and-notifications-raw-notification-overview">the WNS documentation</a>.</p>
</div>
<p>The Push to Sync message needs to be handled by the TaskList view.  The easiest mechanism of communicating with the view is to use the <code>MessagingCenter</code>.  The TaskList view already has the appropriate code to refresh the list when it receives a message:</p>
<pre><code class="language-csharp">    // Execute the refresh command
    RefreshCommand.Execute(null);
    MessagingCenter.Subscribe&lt;TaskDetailViewModel&gt;(this, &quot;ItemsChanged&quot;, async (sender) =&gt;
    {
        await ExecuteRefreshCommand();
    });
</code></pre>
<p>We can add an appropriate push-to-sync version like this:</p>
<pre><code class="language-csharp">    MessageCenter.Subscribe&lt;PushToSync&gt;(this, &quot;ItemsChanged&quot;, async (sender) =&gt; 
    {
        await ExecuteRefreshCommand();
    });
</code></pre>
<p>This is the same code, but listens for a notification from a different class.  That class is defined in the shared project <code>Models</code> folder:</p>
<pre><code class="language-csharp">namespace TaskList.Models
{
    public class PushToSync
    {
        public string Table { get; set; }
        public string Id { get; set; }
    }
}
</code></pre>
<p>When the MessagingCenter is sent a message for push-to-sync, it will execute the refresh command, thus refreshing the data.  All that remains is to actually send that message in response to the notification.  For Android, this is done in the <code>Services\GcmHandler.cs</code> file in the <code>OnMessage()</code> method:</p>
<pre><code class="language-csharp">    protected override void OnMessage(Context context, Intent intent)
    {
        Log.Info(&quot;GcmService&quot;, $&quot;Message {intent.ToString()}&quot;);
        var op = intent.Extras.GetString(&quot;op&quot;);
        if (op != null)
        {
            var syncMessage = new PushToSync()
            {
                Table = intent.Extras.GetString(&quot;table&quot;),
                Id = intent.Extras.GetString(&quot;id&quot;)
            };
            MessagingCenter.Send&lt;PushToSync&gt;(syncMessage, &quot;ItemsChanged&quot;);
        }
        else
        {
            var message = intent.Extras.GetString(&quot;message&quot;) ?? &quot;Unknown Message&quot;;
            var picture = intent.Extras.GetString(&quot;picture&quot;);
            CreateNotification(&quot;TaskList&quot;, message, picture);
        }
    }
</code></pre>
<p>For iOS, the send happens in the <code>ProcessNotification()</code> method of the <code>AppDelegate.cs</code> class:</p>
<pre><code class="language-csharp">    private void ProcessNotification(NSDictionary options, bool fromFinishedLoading)
    {
        if (!(options != null &amp;&amp; options.ContainsKey(new NSString(&quot;aps&quot;))))
            return;

        NSDictionary aps = options.ObjectForKey(new NSString(&quot;aps&quot;)) as NSDictionary;
        if (!fromFinishedLoading)
        {
            var alertString = GetStringFromOptions(aps, &quot;alert&quot;);
            if (!string.IsNullOrEmpty(alertString))
            {
                // Create the alert (removed for brevity)
            }

            var opString = GetStringFromOptions(aps, &quot;op&quot;);
            if (!string.IsNullOrEmpty(opString) &amp;&amp; opString.Equals(&quot;sync&quot;))
            {
                var syncMessage = new PushToSync()
                {
                    Table = GetStringFromOptions(aps, &quot;table&quot;),
                    Id = GetStringFromOptions(aps, &quot;id&quot;)
                };
                MessagingCenter.Send&lt;PushToSync&gt;(syncMessage, &quot;ItemsChanged&quot;);
            }
        }
    }
</code></pre>
<p>When a client inserts or updates a record into the database on the server, <code>PushToSync()</code> is called.  That emits a push notification in the proper form defined within the mobile app.  When the mobile app receives that push notification, it sends an "ItemsChanged" event to the messaging center.  The TaskList view subscribes to those events and performs a sync in response to that event.</p>
<p>There are several things we could do to this code, including:</p>
<ul>
<li>Push to the UserId that owns the record only - this will reduce the number of pushes that happen.</li>
<li>Only pull the specific record on the specific table that is needed.  This is available in the sender object.</li>
</ul>
<!-- Links -->

              
            </article>
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../windows/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Windows Push" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Windows Push
            </div>
          </div>
        </a>
      
      
        
        <a href="../../chapter6/mvc/" class="md-footer__link md-footer__link--next" aria-label="Next: MVC Applications" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              MVC Applications
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2017-2020 Adrian Hall
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
      
      
    
    <a href="https://github.com/adrianhall" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
    </a>
  
    
    
      
      
    
    <a href="https://twitter.com/FizzyInTheHall" target="_blank" rel="noopener" title="twitter.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.c2e1ee47.min.js"></script>
      
        <script src="../../js/highlight.pack.js"></script>
      
    
  </body>
</html>